---
layout: page
title: SICP Chapter 4 Exercises & Solutions
category: note
tags:
  - post
  - SICP
  - solutions
---
<style>
.outline-text-3 > p.verse {
    background-color: #eee8d5;
    font: italic 400 1.0em Calibri,-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol" !important;
    padding: 1em;
    padding-left: 1.5em;
    border-left: 3px solid #2aa198;
}
</style>

<section id="outline-container-org7c3d31e" class="outline-2">
<h2 id="org7c3d31e"></h2>
<div class="outline-text-2" id="text-org7c3d31e">
<p>
The HTML for this page has been automatically generated by parsing the loosely
formatted source code &amp; comments included in my solutions repository
(<a href="https://github.com/zv/SICP-guile">https://github.com/zv/SICP-guile</a>), if you encounter any unformatted
solutions, you think you've spotted an error or you have something you'd like
to share about the exercises, don't hesitate to leave a comment below
(or a pull request on the source repo).
</p>
</div>
</section>

<section id="outline-container-org104b4fb" class="outline-2">
<h2 id="org104b4fb">Exercises Chapter 4</h2>
<div class="outline-text-2" id="text-org104b4fb">
</div>
<div id="outline-container-orgd69b5f9" class="outline-3">
<h3 id="orgd69b5f9">Exercise 4.1</h3>
<div class="outline-text-3" id="text-orgd69b5f9">
<p class="verse">
Notice that we cannot tell whether the metacircular evaluator evaluates operands<br>
from left to right or from right to left. Its evaluation order is inherited from<br>
the underlying Lisp: If the arguments to cons in list-of-values are evaluated<br>
from left to right, then list-of-values will evaluate operands from left to<br>
right; and if the arguments to cons are evaluated from right to left, then<br>
list-of-values will evaluate operands from right to left.<br>
<br>
Write a version of list-of-values that evaluates operands from left to right<br>
regardless of the order of evaluation in the underlying Lisp. Also write a<br>
version of list-of-values that evaluates operands from right to left.<br>
</p>
</div>

<div id="outline-container-orgdc2afe4" class="outline-4">
<h4 id="orgdc2afe4">Answer</h4>
<div class="outline-text-4" id="text-orgdc2afe4">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">rtl-list-of-values</span> exps env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>no-operands? exps<span style="color: #268bd2;">)</span> '<span style="color: #268bd2;">()</span>
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span>left <span style="color: #b58900;">(</span>zeval <span style="color: #268bd2;">(</span>first-operand exps<span style="color: #268bd2;">)</span> env<span style="color: #b58900;">)</span> <span style="color: #859900;">)</span>
             <span style="color: #859900;">(</span>right <span style="color: #b58900;">(</span>rtl-list-of-values <span style="color: #268bd2;">(</span>rest-operands exps<span style="color: #268bd2;">)</span> env<span style="color: #b58900;">)</span> <span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>cons left right<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfa87915" class="outline-3">
<h3 id="orgfa87915">Exercise 4.2</h3>
<div class="outline-text-3" id="text-orgfa87915">
<p class="verse">
Louis Reasoner plans to reorder the cond clauses in eval so that the clause for<br>
procedure applications appears before the clause for assignments. He argues that<br>
this will make the interpreter more efficient: Since programs usually contain<br>
more applications than assignments, definitions, and so on, his modified eval<br>
will usually check fewer clauses than the original eval before identifying the<br>
type of an expression.<br>
<br>
1. What is wrong with Louis’s plan? (Hint: What will Louis’s evaluator do with the expression (define x 3)?)<br>
<br>
2. Louis is upset that his plan didn’t work. He is willing to go to any lengths to make his evaluator recognize procedure applications before it checks for most other kinds of expressions. Help him by changing the syntax of the evaluated language so that procedure applications start with call. For example, instead of (factorial 3) we will now have to write (call factorial 3) and instead of (+ 1 2) we will have to write (call + 1 2).<br>
</p>
</div>

<div id="outline-container-org742384f" class="outline-4">
<h4 id="org742384f">Answer</h4>
<div class="outline-text-4" id="text-org742384f">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Answer:</span>
<span style="color: #93a1a1;">1: The order of operations will cause some variables to be undefined. As the</span>
<span style="color: #93a1a1;">example suggests, define will be called with 'x' and '3' as arguments. `define'</span>
<span style="color: #93a1a1;">cannot be made into a procedure because the arguments will be evaluated.</span>

<span style="color: #93a1a1;">2. Only `application' need be changed:</span>

<span style="color: #93a1a1;">(define application? (exp)</span>
<span style="color: #93a1a1;">(tagged-list? exp 'call))</span>
<span style="color: #93a1a1;">(define operator (exp) (cadr exp))</span>
<span style="color: #93a1a1;">(define operands (exp) (cddr exp)) |#</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9e84a9c" class="outline-3">
<h3 id="org9e84a9c">Exercise 4.3</h3>
<div class="outline-text-3" id="text-org9e84a9c">
<p class="verse">
Rewrite eval so that the dispatch is done in data-directed style. Compare this<br>
with the data-directed differentiation procedure of Exercise 2.73.<br>
(You may use the car of a compound expression as the type of the expression, as<br>
is appropriate for the syntax implemented in this section.)<br>
</p>
</div>

<div id="outline-container-orgc650a18" class="outline-4">
<h4 id="orgc650a18">Answer</h4>
<div class="outline-text-4" id="text-orgc650a18">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define-class</span> <span style="color: #b58900;">&lt;dispatch-table&gt;</span> <span style="color: #b58900;">()</span>
  <span style="color: #b58900;">(</span>method-table <span style="color: #657b83; font-weight: bold;">#:init-value</span> <span style="color: #268bd2;">(</span>make-hash-table<span style="color: #268bd2;">)</span>
                <span style="color: #657b83; font-weight: bold;">#:getter</span> method-table<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">table-ordinal</span> op type<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>opstr   <span style="color: #859900;">(</span>symbol-&gt;string op<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>typestr <span style="color: #859900;">(</span>symbol-&gt;string type<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>string-append opstr <span style="color: #2aa198;">"/"</span> typestr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define-method</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">get</span> <span style="color: #268bd2;">(</span>dt <span style="color: #b58900;">&lt;dispatch-table&gt;</span><span style="color: #268bd2;">)</span> op type<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span>symbol? op<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>symbol? type<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
      <span style="color: #268bd2;">(</span>hash-ref <span style="color: #6c71c4;">(</span>method-table dt<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>table-ordinal op type<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
      #f<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define-method</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">put</span> <span style="color: #268bd2;">(</span>dt <span style="color: #b58900;">&lt;dispatch-table&gt;</span><span style="color: #268bd2;">)</span> op type item<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>hash-set! <span style="color: #268bd2;">(</span>method-table dt<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>table-ordinal op type<span style="color: #268bd2;">)</span> item<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">dispatch-tt</span> <span style="color: #b58900;">(</span>make <span style="color: #b58900;">&lt;dispatch-table&gt;</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">list-tag</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"Extract the type of expression"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>pair? expr<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>car expr<span style="color: #268bd2;">)</span> #f<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">install-procedure</span> p<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>put dispatch-tt 'eval <span style="color: #268bd2;">(</span>car p<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>cadr p<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Install our procedures</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span>
 install-procedure
 `<span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>quote  ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>expr env<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>text-of-quotation expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span><span style="color: #859900; font-weight: bold;">set!</span>    ,eval-assignment<span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span>define ,eval-definition<span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span>if     ,eval-if<span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span>lambda ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>expr env<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>make-procedure <span style="color: #b58900;">(</span>lambda-parameters expr<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>lambda-body expr<span style="color: #b58900;">)</span> env<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span>begin  ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>expr env<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>eval-sequence <span style="color: #b58900;">(</span>begin-actions expr<span style="color: #b58900;">)</span> env<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span>cond   ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>expr env<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>zeval <span style="color: #b58900;">(</span>cond-&gt;if expr<span style="color: #b58900;">)</span> env<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">zeval</span> expr env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>dispatch-fn <span style="color: #859900;">(</span>get dispatch-tt 'eval <span style="color: #b58900;">(</span>list-tag expr<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cond</span>
     <span style="color: #6c71c4;">[</span><span style="color: #859900;">(</span>self-evaluating? expr<span style="color: #859900;">)</span>
      expr<span style="color: #6c71c4;">]</span>
     <span style="color: #6c71c4;">[</span><span style="color: #859900;">(</span>variable? expr<span style="color: #859900;">)</span>
      <span style="color: #859900;">(</span>lookup-variable-value expr env<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
     <span style="color: #6c71c4;">[</span><span style="color: #859900;">(</span>procedure? dispatch-fn<span style="color: #859900;">)</span>
      <span style="color: #859900;">(</span>dispatch-fn expr env<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
     <span style="color: #6c71c4;">[</span><span style="color: #859900;">(</span>application? expr<span style="color: #859900;">)</span>
      <span style="color: #859900;">(</span>zapply <span style="color: #b58900;">(</span>zeval <span style="color: #268bd2;">(</span>operator expr<span style="color: #268bd2;">)</span> env<span style="color: #b58900;">)</span>
              <span style="color: #b58900;">(</span>list-of-values <span style="color: #268bd2;">(</span>operands expr<span style="color: #268bd2;">)</span> env<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
     <span style="color: #6c71c4;">[</span><span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900;">(</span>error <span style="color: #2aa198;">"Bad Expression"</span> expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">install-driver-loop</span> evaluator fn<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>put dispatch-tt 'driver-loop evaluator fn<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-driver-loop 'zeval base-driver-loop<span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2fd2679" class="outline-3">
<h3 id="org2fd2679">Exercise 4.4</h3>
<div class="outline-text-3" id="text-org2fd2679">
<p class="verse">
Recall the definitions of the special forms and and or from Chapter 1:<br>
<br>
`and': The expressions are evaluated from left to right. If any expression<br>
evaluates to false, false is returned; any remaining expressions are not<br>
evaluated. If all the expressions evaluate to true values, the value of the last<br>
expression is returned. If there are no expressions then true is returned.<br>
`or': The expressions are evaluated from left to right. If any expression<br>
evaluates to a true value, that value is returned; any remaining expressions are<br>
not evaluated. If all expressions evaluate to false, or if there are no<br>
expressions, then false is returned.<br>
<br>
Install `and' and `or' as new special forms for the evaluator by defining<br>
appropriate syntax procedures and evaluation procedures eval-and and eval-or.<br>
Alternatively, show how to implement and and or as derived expressions.<br>
</p>
</div>
<div id="outline-container-orgdcb9dce" class="outline-4">
<h4 id="orgdcb9dce">Answer</h4>
<div class="outline-text-4" id="text-orgdcb9dce">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">disjunct</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? <span style="color: #6c71c4;">(</span>cdr exp<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> 'false
      <span style="color: #268bd2;">(</span>cadr exp<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">rest-disjunctions</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? <span style="color: #6c71c4;">(</span>cdr exp<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> '<span style="color: #268bd2;">()</span>
      <span style="color: #268bd2;">(</span>cddr exp<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">or</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">or?</span> exp<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>tagged-list? exp 'or<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">eval-or</span> exp env<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>eval-connective exp env true?<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">or</span> ,eval-or<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">and</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">and?</span> exp<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>tagged-list? exp 'and<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">eval-and</span> exp env<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>eval-connective exp env false?<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">and</span> ,eval-and<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">eval-connective</span> exp env oper<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"eval-connective evaluates the first part of an expression in the given</span>
<span style="color: #2aa198;">environment. If the result applied to `oper' is false, it continues to evaluate</span>
<span style="color: #2aa198;">until `(oper exp)' argument returns true or no arguments remain."</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>disjunction <span style="color: #859900;">(</span>zeval <span style="color: #b58900;">(</span>disjunct exp<span style="color: #b58900;">)</span> env<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>rest-disjunctions <span style="color: #859900;">(</span>rest-disjunctions exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">or</span> <span style="color: #859900;">(</span>oper disjunction<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>null? rest-disjunctions<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span> disjunction
        <span style="color: #6c71c4;">(</span>eval-connective <span style="color: #859900;">(</span>cons <span style="color: #b58900;">(</span>operator exp<span style="color: #b58900;">)</span> rest-disjunctions<span style="color: #859900;">)</span>
                         env
                         oper<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf819c65" class="outline-3">
<h3 id="orgf819c65">Exercise 4.5</h3>
<div class="outline-text-3" id="text-orgf819c65">
<p class="verse">
Scheme allows an additional syntax for cond clauses, (⟨test⟩ =&gt; ⟨recipient⟩). If<br>
⟨test⟩ evaluates to a true value, then ⟨recipient⟩ is evaluated. Its value must<br>
be a procedure of one argument; this procedure is then invoked on the value of<br>
the ⟨test⟩, and the result is returned as the value of the cond expression. For<br>
example<br>
<br>
&#xa0;(cond ((assoc 'b '((a 1) (b 2))) =&gt; cadr)<br>
&#xa0;(else false))<br>
<br>
returns 2.<br>
Modify the handling of cond so that it supports this extended syntax.<br>
</p>
</div>
<div id="outline-container-org27bac31" class="outline-4">
<h4 id="org27bac31">Answer</h4>
<div class="outline-text-4" id="text-org27bac31">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">cond-is-pipe?</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>pair? exp<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>eq? <span style="color: #6c71c4;">(</span>cadr exp<span style="color: #6c71c4;">)</span> '=&gt;<span style="color: #268bd2;">)</span> #f<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">cond-recipient</span> exp<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>caddr exp<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">expand-clauses</span> clauses<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? clauses<span style="color: #268bd2;">)</span> 'false
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">[</span>first <span style="color: #b58900;">(</span>car clauses<span style="color: #b58900;">)</span><span style="color: #859900;">]</span>
            <span style="color: #859900;">[</span>rest  <span style="color: #b58900;">(</span>cdr clauses<span style="color: #b58900;">)</span><span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>

        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">check for =&gt;</span>
        <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>cond-is-pipe? first<span style="color: #859900;">)</span>
            <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>test <span style="color: #6c71c4;">(</span>cond-predicate first<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span>
              <span style="color: #b58900;">(</span>make-if test
                       <span style="color: #268bd2;">(</span>list <span style="color: #6c71c4;">(</span>cond-recipient first<span style="color: #6c71c4;">)</span> test<span style="color: #268bd2;">)</span>
                       <span style="color: #268bd2;">(</span>expand-clauses rest<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>

            <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">otherwise a normal cond applies</span>
            <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>cond-else-clause? first<span style="color: #b58900;">)</span>
                <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? rest<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>sequence-&gt;exp <span style="color: #6c71c4;">(</span>cond-actions first<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
                    <span style="color: #268bd2;">(</span>error <span style="color: #2aa198;">"ELSE clause isn't last: COND-&gt;IF"</span> clauses<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
                <span style="color: #b58900;">(</span>make-if <span style="color: #268bd2;">(</span>cond-predicate first<span style="color: #268bd2;">)</span>
                         <span style="color: #268bd2;">(</span>sequence-&gt;exp <span style="color: #6c71c4;">(</span>cond-actions first<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
                         <span style="color: #268bd2;">(</span>expand-clauses rest<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge84f592" class="outline-3">
<h3 id="orge84f592">Exercise 4.6</h3>
<div class="outline-text-3" id="text-orge84f592">
<p class="verse">
&#xa0;Let expressions are derived expressions, because<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;(let ((⟨var₁⟩ ⟨exp₁⟩) … (⟨varₙ⟩ ⟨expₙ⟩))<br>
&#xa0;&#xa0;&#xa0;&#xa0;⟨body⟩)<br>
<br>
is equivalent to<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;((lambda (⟨var₁⟩ … ⟨varₙ⟩)<br>
&#xa0;&#xa0;&#xa0;&#xa0;⟨body⟩)<br>
&#xa0;&#xa0;&#xa0;&#xa0;⟨exp₁⟩<br>
&#xa0;&#xa0;&#xa0;&#xa0;…<br>
&#xa0;&#xa0;&#xa0;&#xa0;⟨expₙ⟩)<br>
<br>
&#xa0;Implement a syntactic transformation let-&gt;combination that reduces evaluating<br>
&#xa0;let expressions to evaluating combinations of the type shown above, and add the<br>
&#xa0;appropriate clause to eval to handle let expressions.<br>
</p>
</div>
<div id="outline-container-org390f024" class="outline-4">
<h4 id="org390f024">Answer</h4>
<div class="outline-text-4" id="text-org390f024">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span>generate-accessors
 <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>let-bindings       cadr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let-body           cddr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let-binding-vars   <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">cut</span> map car <span style="color: #b58900;">&lt;...&gt;</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let-binding-exprs  <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">cut</span> map cadr <span style="color: #b58900;">&lt;...&gt;</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let-vars           <span style="color: #6c71c4;">(</span>compose let-binding-vars let-bindings<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let-exprs          <span style="color: #6c71c4;">(</span>compose let-binding-exprs let-bindings<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>


<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">make-let-&gt;lambda</span> vars exprs body<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"Makes a let expression as ((lambda (vars) body) exprs)"</span>
  <span style="color: #b58900;">(</span>cons <span style="color: #268bd2;">(</span>make-lambda vars body<span style="color: #268bd2;">)</span> exprs<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">let-&gt;combination</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? exp<span style="color: #268bd2;">)</span> 'false
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">[</span>bindings <span style="color: #b58900;">(</span>let-bindings exp<span style="color: #b58900;">)</span><span style="color: #859900;">]</span>
            <span style="color: #859900;">[</span>body     <span style="color: #b58900;">(</span>let-body exp<span style="color: #b58900;">)</span><span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>make-let-&gt;lambda <span style="color: #859900;">(</span>let-binding-vars bindings<span style="color: #859900;">)</span>
                          <span style="color: #859900;">(</span>let-binding-exprs bindings<span style="color: #859900;">)</span>
                          body<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp env<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>zeval <span style="color: #859900;">(</span>let-&gt;combination exp<span style="color: #859900;">)</span> env<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgae3ce7a" class="outline-3">
<h3 id="orgae3ce7a">Exercise 4.7</h3>
<div class="outline-text-3" id="text-orgae3ce7a">
<p class="verse">
`let*' is similar to `let', except that the bindings of the `let*' variables are<br>
performed sequentially from left to right, and each binding is made in an<br>
environment in which all of the preceding bindings are visible. For example<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let* ((x 3)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(y (+ x 2))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(z (+ x y 5)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(* x z))<br>
<br>
returns 39. Explain how a `let*' expression can be rewritten as a set of nested<br>
let expressions, and write a procedure `let*-&gt;nested-lets' that performs this<br>
transformation. If we have already implemented let (Exercise 4.6) and we want to<br>
extend the evaluator to handle `let*', is it sufficient to add a clause to eval<br>
whose action is<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(eval (let*-&gt;nested-lets exp) env)<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let (x 3)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let (y 2)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;1))<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;((lambda (x) (lambda (y) 1) 2) 3)<br>
<br>
or must we explicitly expand `let*' in terms of non-derived expressions?<br>
</p>
</div>
<div id="outline-container-org2153e28" class="outline-4">
<h4 id="org2153e28">Answer</h4>
<div class="outline-text-4" id="text-org2153e28">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;;; </span><span style="color: #93a1a1;">There is nothing preventing `let*' from being defined in terms of existing</span>
<span style="color: #93a1a1;">;;; </span><span style="color: #93a1a1;">`let' expressions</span>
<span style="color: #2aa198;">(</span>generate-accessors
 <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>let*-body  caddr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let*-inits cadr<span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;;;; </span><span style="color: #93a1a1;">This is a little funky here, I've replaced this with another version copied</span>
<span style="color: #93a1a1;">;;;; </span><span style="color: #93a1a1;">online -- the only thing wrong with this is some monkeying around with the let</span>
<span style="color: #93a1a1;">;;;; </span><span style="color: #93a1a1;">order</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">(define (let*-&gt;nested-let exp)</span>
<span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">(define (next exp)</span>
<span style="color: #93a1a1;">;;     </span><span style="color: #93a1a1;">(list (operator exp) (cdadr exp) (caddr exp)))</span>
<span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">(if (null? exp) 'false</span>
<span style="color: #93a1a1;">;;       </span><span style="color: #93a1a1;">(let ([bindings (let-bindings exp)]</span>
<span style="color: #93a1a1;">;;             </span><span style="color: #93a1a1;">[body     (let-body exp)])</span>
<span style="color: #93a1a1;">;;         </span><span style="color: #93a1a1;">(if (null? bindings) body</span>
<span style="color: #93a1a1;">;;             </span><span style="color: #93a1a1;">(make-let-&gt;lambda</span>
<span style="color: #93a1a1;">;;              </span><span style="color: #93a1a1;">(list (car (let-binding-vars bindings)))</span>
<span style="color: #93a1a1;">;;              </span><span style="color: #93a1a1;">(list (car (let-binding-exprs bindings)))</span>
<span style="color: #93a1a1;">;;              </span><span style="color: #93a1a1;">(let*-&gt;nested-let (next exp)))))))</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">let*-&gt;nested-lets</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>inits <span style="color: #859900;">(</span>let*-inits expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>body <span style="color: #859900;">(</span>let*-body expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">next</span> expr<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>null? expr<span style="color: #859900;">)</span> body
          <span style="color: #859900;">(</span>list 'let <span style="color: #b58900;">(</span>list <span style="color: #268bd2;">(</span>car expr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>next <span style="color: #268bd2;">(</span>cdr expr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>next inits<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>


<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let*</span> ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp env<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>zeval <span style="color: #859900;">(</span>let*-&gt;nested-lets exp<span style="color: #859900;">)</span> env<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8776a4a" class="outline-3">
<h3 id="org8776a4a">Exercise 4.8</h3>
<div class="outline-text-3" id="text-org8776a4a">
<p class="verse">
“Named let” is a variant of let that has the form<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ⟨var⟩ ⟨bindings⟩ ⟨body⟩)<br>
<br>
The ⟨bindings⟩ and ⟨body⟩ are just as in ordinary let, except that ⟨var⟩ is<br>
bound within ⟨body⟩ to a procedure whose body is ⟨body⟩ and whose parameters are<br>
the variables in the ⟨bindings⟩. Thus, one can repeatedly execute the ⟨body⟩ by<br>
invoking the procedure named ⟨var⟩. For example, the iterative Fibonacci<br>
procedure (1.2.2) can be rewritten using named let as follows:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (fib n)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let fib-iter ((a 1) (b 0) (count n))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if (= count 0)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;b<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(fib-iter (+ a b)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;a<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(- count 1)))))<br>
<br>
Modify let-&gt;combination of Exercise 4.6 to also support named let.<br>
</p>
</div>
<div id="outline-container-org6c0fe2a" class="outline-4">
<h4 id="org6c0fe2a">Answer</h4>
<div class="outline-text-4" id="text-org6c0fe2a">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">named-let?</span> exp<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>symbol? <span style="color: #268bd2;">(</span>cadr exp<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>generate-accessors
 <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>nlet-var cadr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>nlet-bindings caddr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>nlet-body cdddr<span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">make-named-let</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">get prepped for that long let</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>body       <span style="color: #859900;">(</span>nlet-body exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
         <span style="color: #6c71c4;">[</span>bindings   <span style="color: #859900;">(</span>nlet-bindings exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
         <span style="color: #6c71c4;">[</span>vars       <span style="color: #859900;">(</span>let-binding-vars bindings<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
         <span style="color: #6c71c4;">[</span>exprs      <span style="color: #859900;">(</span>let-binding-exprs bindings<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
         <span style="color: #6c71c4;">[</span>fnname     <span style="color: #859900;">(</span>nlet-var exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
         <span style="color: #6c71c4;">[</span>fn         <span style="color: #859900;">(</span>make-lambda vars body<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>%as-syntax
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> ,bindings
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">begin</span>
         <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> ,fnname ,fn<span style="color: #b58900;">)</span>
         ,@body<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">let-&gt;combination</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? exp<span style="color: #268bd2;">)</span> 'false
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>named-let? exp<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>make-named-let exp<span style="color: #6c71c4;">)</span>
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">otherwise we're processing a normal let</span>
          <span style="color: #6c71c4;">(</span>make-let-&gt;lambda <span style="color: #859900;">(</span>let-vars exp<span style="color: #859900;">)</span>
                            <span style="color: #859900;">(</span>let-exprs exp<span style="color: #859900;">)</span>
                            <span style="color: #859900;">(</span>let-body exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8bcc8d9" class="outline-3">
<h3 id="org8bcc8d9">Exercise 4.9</h3>
<div class="outline-text-3" id="text-org8bcc8d9">
<p class="verse">
Many languages support a variety of iteration constructs, such as `do', `for',<br>
`while', and `until'. In Scheme, iterative processes can be expressed in terms of<br>
ordinary procedure calls, so special iteration constructs provide no essential<br>
gain in computational power. On the other hand, such constructs are often<br>
convenient. Design some iteration constructs, give examples of their use, and<br>
show how to implement them as derived expressions.<br>
</p>
</div>
<div id="outline-container-orge482b84" class="outline-4">
<h4 id="orge482b84">Answer</h4>
<div class="outline-text-4" id="text-orge482b84">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>generate-accessors
 <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>while-cond cadr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>while-body caddr<span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">make-while</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>body <span style="color: #859900;">(</span>while-body exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>cond <span style="color: #859900;">(</span>while-cond exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>null? cond<span style="color: #6c71c4;">)</span> 'false
        <span style="color: #6c71c4;">(</span>%as-syntax
         <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">while-loop</span> <span style="color: #b58900;">()</span>
           <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> ,cond
               <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">begin</span> ,body
                      <span style="color: #6c71c4;">(</span>while-loop<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
               false<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span>while ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp env<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>zeval <span style="color: #859900;">(</span>make-while exp<span style="color: #859900;">)</span> env<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org9e69d93" class="outline-3">
<h3 id="org9e69d93">Exercise 4.11 &amp; Exercise 4.12</h3>
<div class="outline-text-3" id="text-org9e69d93">
<p class="verse">
4.11: Instead of representing a frame as a pair of lists, we can represent a<br>
frame as a list of bindings, where each binding is a name-value pair. Rewrite<br>
the environment operations to use this alternative representation.<br>
<br>
4.12: The procedures define-variable!, set-variable-value! and<br>
lookup-variable-value can be expressed in terms of more abstract procedures for<br>
traversing the environment structure. Define abstractions that capture the<br>
common patterns and redefine the three procedures in terms of these<br>
abstractions.<br>
</p>
<p>
<b>*</b> Answer
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">make-frame</span> variables values<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">map</span> cons variables values<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">var-process</span> var environment fn<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">var-search</span> env<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>eq? env the-empty-environment<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">begin</span>
                                          <span style="color: #93a1a1;">;;</span><span style="color: #93a1a1;">(pretty-print environment)</span>
                                          <span style="color: #859900;">(</span>error <span style="color: #2aa198;">"Unbound variable"</span> var<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #859900;">(</span><span style="color: #b58900;">[</span>frame <span style="color: #268bd2;">(</span>first-frame env<span style="color: #268bd2;">)</span><span style="color: #b58900;">]</span>
               <span style="color: #b58900;">[</span>entry <span style="color: #268bd2;">(</span>assoc var frame<span style="color: #268bd2;">)</span><span style="color: #b58900;">]</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">if</span> entry <span style="color: #b58900;">(</span>fn frame entry<span style="color: #b58900;">)</span>
              <span style="color: #b58900;">(</span>var-search <span style="color: #268bd2;">(</span>enclosing-environment env<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>var-search environment<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">lookup-variable-value</span> var env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>var-process var env <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>_frame entry<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>cdr entry<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">set-variable-value!</span> var val env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>var-process var env <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>frame entry<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>set-cdr! entry val<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">define-variable!</span> var val env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>set-car! env <span style="color: #268bd2;">(</span>assoc-set! <span style="color: #6c71c4;">(</span>first-frame env<span style="color: #6c71c4;">)</span> var val<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org8eb041f" class="outline-3">
<h3 id="org8eb041f">Exercise 4.13</h3>
<div class="outline-text-3" id="text-org8eb041f">
<p class="verse">
Scheme allows us to create new bindings for variables by means of define, but<br>
provides no way to get rid of bindings. Implement for the evaluator a special<br>
form make-unbound! that removes the binding of a given symbol from the<br>
environment in which the make-unbound! expression is evaluated. This problem is<br>
not completely specified. For example, should we remove only the binding in the<br>
first frame of the environment? Complete the specification and justify any<br>
choices you make.<br>
</p>
</div>
<div id="outline-container-org7ce21d5" class="outline-4">
<h4 id="org7ce21d5">Answer</h4>
<div class="outline-text-4" id="text-org7ce21d5">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Spec:</span>
<span style="color: #93a1a1;">`undefine' and `unset' are functions that set the name of the binding inside the</span>
<span style="color: #93a1a1;">closest stack-frame to null. |#</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">undefine-variable!</span> var env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>var-process var env <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>frame entry<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>set-car! entry '<span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">eval-undefinition</span> exp env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>undefine-variable!
   <span style="color: #268bd2;">(</span>definition-variable exp<span style="color: #268bd2;">)</span> env<span style="color: #b58900;">)</span>
  'ok<span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span>undefine ,eval-undefinition<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb477eaf" class="outline-3">
<h3 id="orgb477eaf">Exercise 4.14</h3>
<div class="outline-text-3" id="text-orgb477eaf">
<p class="verse">
Eva Lu Ator and Louis Reasoner are each experimenting with the metacircular<br>
evaluator. Eva types in the definition of map, and runs some test programs that<br>
use it. They work fine. Louis, in contrast, has installed the system version of<br>
map as a primitive for the metacircular evaluator. When he tries it, things go<br>
terribly wrong. Explain why Louis’s map fails even though Eva’s works.<br>
</p>
</div>
<div id="outline-container-orge6824b3" class="outline-4">
<h4 id="orge6824b3">Answer</h4>
<div class="outline-text-4" id="text-orge6824b3">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">Louis is trying to use a variable defined inside the *interpreters* stack</span>
<span style="color: #93a1a1;">frame, not the *interpreTED* stack frame |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orged85025" class="outline-3">
<h3 id="orged85025">Exercise 4.15</h3>
<div class="outline-text-3" id="text-orged85025">
<p class="verse">
Given a one-argument procedure p and an object a, p is said to “halt” on a if<br>
evaluating the expression (p a) returns a value (as opposed to terminating with<br>
an error message or running forever). Show that it is impossible to write a<br>
procedure halts? that correctly determines whether p halts on a for any<br>
procedure p and object a. Use the following reasoning: If you had such a<br>
procedure halts?, you could implement the following program:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (run-forever)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(run-forever))<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (try p)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if (halts? p p)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(run-forever)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;'halted))<br>
<br>
Now consider evaluating the expression (try try) and show that any possible<br>
outcome (either halting or running forever) violates the intended behavior of<br>
halts?.<br>
</p>
</div>
<div id="outline-container-orge3fdcee" class="outline-4">
<h4 id="orge3fdcee">Answer</h4>
<div class="outline-text-4" id="text-orge3fdcee">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| - - - - - Solution:</span>
<span style="color: #93a1a1;">This problem is an abstract description of a thought experiment Turing conducted in the 1930s which would later be known as the 'halting problem'.</span>

<span style="color: #93a1a1;">The problem has no solution for a similar reason to the 'liar' paradox:</span>

<span style="color: #93a1a1;">Suppose it returns true -- `try' enters an endless loop, so it obviously doesn&#8217;t halt, while halts? returned true. The contrawise position is identical</span>

<span style="color: #93a1a1;">Therefore there can be no solution to the problem |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org94df819" class="outline-3">
<h3 id="org94df819">Exercise 4.16</h3>
<div class="outline-text-3" id="text-org94df819">
<p class="verse">
In this exercise we implement the method just described for interpreting<br>
internal definitions. We assume that the evaluator supports let (see Exercise<br>
4.6).<br>
<br>
1. Change `lookup-variable-value' (4.1.3) to signal an error if the value it finds<br>
is the symbol <b>unassigned</b>.<br>
2. Write a procedure `scan-out-defines' that takes a procedure body and returns an<br>
equivalent one that has no internal definitions, by making the transformation<br>
described above.<br>
3. Install `scan-out-defines' in the interpreter, either in make-procedure or in<br>
procedure-body (see 4.1.3). Which place is better? Why?<br>
</p>
</div>
<div id="outline-container-orgfe20775" class="outline-4">
<h4 id="orgfe20775">Answer</h4>
<div class="outline-text-4" id="text-orgfe20775">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">1. Solution</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">simultaneous/lookup-variable-value</span> var env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>var-process var env <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>_f entry<span style="color: #6c71c4;">)</span>
                         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>eq? <span style="color: #b58900;">(</span>cdr entry<span style="color: #b58900;">)</span> '*unassigned*<span style="color: #859900;">)</span>
                             <span style="color: #859900;">(</span>error <span style="color: #2aa198;">"Unassigned var: "</span> var<span style="color: #859900;">)</span>
                             <span style="color: #859900;">(</span>cdr entry<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">2</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">scan-out-defines</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"Transform a procedure, returning an equivalent one with no internal</span>
<span style="color: #2aa198;">definitions"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">has-define</span> <span style="color: #268bd2;">(</span>find <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>e<span style="color: #859900;">)</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #b58900;">(</span>pair? e<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>eq? <span style="color: #268bd2;">(</span>car e<span style="color: #268bd2;">)</span> 'define<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
                           expr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> has-define
      <span style="color: #268bd2;">(</span>fold
       <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>elt prev<span style="color: #859900;">)</span>
         <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>bindings <span style="color: #6c71c4;">(</span>let-bindings prev<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
               <span style="color: #268bd2;">[</span>body     <span style="color: #6c71c4;">(</span>let-body prev<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span>
           <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">merge our (new) bindings &amp; body</span>
           <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">match</span> elt
             <span style="color: #268bd2;">[</span><span style="color: #6c71c4;">(</span>'define var val<span style="color: #6c71c4;">)</span>
              `<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span><span style="color: #2aa198;">(</span>,var '*unassigned*<span style="color: #2aa198;">)</span>
                     ,@bindings<span style="color: #859900;">)</span>
                 <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> ,var ,val<span style="color: #859900;">)</span>
                 <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">we use ,@ to prevent recursive lists</span>
                 ,@body<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
             <span style="color: #268bd2;">[</span>_ `<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> ,bindings ,@body ,elt<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
       '<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">we start with a basic let expression</span>
       expr<span style="color: #268bd2;">)</span>
      expr<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">simulatanous test</span>
<span style="color: #2aa198;">(</span>assert-equal
 <span style="color: #b58900;">(</span>scan-out-defines '<span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">a</span> <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span>
                     <span style="color: #6c71c4;">(</span>make-thing <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span>
                     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">b</span> <span style="color: #6c71c4;">2</span><span style="color: #6c71c4;">)</span>
                     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">c</span> <span style="color: #6c71c4;">3</span><span style="color: #6c71c4;">)</span>
                     <span style="color: #6c71c4;">(</span>make-thing a <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>c '*unassigned*<span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>b '*unassigned*<span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>a '*unassigned*<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">set!</span> c <span style="color: #6c71c4;">3</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">set!</span> b <span style="color: #6c71c4;">2</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">set!</span> a <span style="color: #6c71c4;">1</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>make-thing <span style="color: #6c71c4;">1</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>make-thing a <span style="color: #6c71c4;">1</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">3 -- I've selected make-procedure so that the conversion is done at</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">interpretation, rather than runtime.</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">simultaneous/make-procedure</span> parameters body env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>list 'procedure
        parameters
        <span style="color: #268bd2;">(</span>scan-out-defines body<span style="color: #268bd2;">)</span>
        env<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org48ef774" class="outline-3">
<h3 id="org48ef774">Exercise 4.18</h3>
<div class="outline-text-3" id="text-org48ef774">
<p class="verse">
Consider an alternative strategy for scanning out definitions that translates<br>
the example in the text to<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lambda ⟨vars⟩<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((u '<b>unassigned</b>)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(v '<b>unassigned</b>))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((a ⟨e1⟩)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(b ⟨e2⟩))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(set! u a)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(set! v b))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;⟨e3⟩))<br>
<br>
Here a and b are meant to represent new variable names, created by the<br>
interpreter, that do not appear in the user’s program. Consider the solve<br>
procedure from 3.5.4:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (solve f y0 dt)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define y (integral (delay dy) y0 dt))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define dy (stream-map f y))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;y)<br>
<br>
Will this procedure work if internal definitions are scanned out as shown in<br>
this exercise? What if they are scanned out as shown in the text? Explain.<br>
</p>
</div>
<div id="outline-container-org638deac" class="outline-4">
<h4 id="org638deac">Answer</h4>
<div class="outline-text-4" id="text-org638deac">
<div class="org-src-container">
<pre class="src src-scheme">
                                        <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">- - - - - - Solution:</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">This wont work because the proxy-value of `y' (a) cannot be directly</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">referenced upon the definition of `dy'</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org97ab332" class="outline-3">
<h3 id="org97ab332">Exercise 4.19</h3>
<div class="outline-text-3" id="text-org97ab332">
<p class="verse">
Ben Bitdiddle, Alyssa P. Hacker, and Eva Lu Ator are arguing about the desired<br>
result of evaluating the expression<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((a 1))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (f x)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define b (+ a x))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define a 5)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(+ a b))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(f 10))<br>
<br>
Ben asserts that the result should be obtained using the sequential rule for<br>
define: `b' is defined to be 11, then `a' is defined to be 5, so the result is<br>
16. Alyssa objects that mutual recursion requires the simultaneous scope rule<br>
for internal procedure definitions, and that it is unreasonable to treat<br>
procedure names differently from other names. Thus, she argues for the mechanism<br>
implemented in Exercise 4.16. This would lead to a being unassigned at the time<br>
that the value for `b' is to be computed. Hence, in Alyssa’s view the procedure<br>
should produce an error. Eva has a third opinion. She says that if the<br>
definitions of `a' and `b' are truly meant to be simultaneous, then the value 5<br>
for `a' should be used in evaluating b. Hence, in Eva’s view `a' should be 5, `b'<br>
should be 15, and the result should be 20. Which (if any) of these viewpoints do<br>
you support? Can you devise a way to implement internal definitions so that they<br>
behave as Eva prefers?<br>
</p>
</div>
<div id="outline-container-org440f537" class="outline-4">
<h4 id="org440f537">Answer</h4>
<div class="outline-text-4" id="text-org440f537">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution</span>
<span style="color: #93a1a1;">I like Alyssas view, although Ben's dominates most thinking.</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Eva's view can be easily supported by swapping the order within the `let'</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">quasiquote of `set!' and `@,body'</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org765b86f" class="outline-3">
<h3 id="org765b86f">Exercise 4.20 (lol)</h3>
<div class="outline-text-3" id="text-org765b86f">
<p class="verse">
Because internal definitions look sequential but are actually simultaneous, some<br>
people prefer to avoid them entirely, and use the special form letrec instead.<br>
Letrec looks like let, so it is not surprising that the variables it binds are<br>
bound simultaneously and have the same scope as each other. The sample procedure<br>
f above can be written without internal definitions, but with exactly the same<br>
meaning, as<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (f x)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(letrec<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;((even?<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lambda (n)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if (= n 0)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;true<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(odd? (- n 1)))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(odd?<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lambda (n)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if (= n 0)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;false<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(even? (- n 1))))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;⟨rest of body of f⟩))<br>
<br>
`letrec' expressions, which have the form<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(letrec ((⟨var₁⟩ ⟨exp₁⟩) … (⟨varₙ⟩ ⟨expₙ⟩))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;⟨body⟩)<br>
<br>
are a variation on let in which the expressions ⟨expₖ⟩ that provide the initial<br>
values for the variables ⟨varₖ⟩ are evaluated in an environment that includes<br>
all the letrec bindings. This permits recursion in the bindings, such as the<br>
mutual recursion of even? and odd? in the example above, or the evaluation of 10<br>
factorial with<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(letrec<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;((fact<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lambda (n)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if (= n 1)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;1<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(* n (fact (- n 1)))))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(fact 10))<br>
<br>
1. Implement letrec as a derived expression, by transforming a letrec expression<br>
into a let expression as shown in the text above or in Exercise 4.18. That is,<br>
the letrec variables should be created with a let and then be assigned their<br>
values with set!.<br>
<br>
2. Louis Reasoner is confused by all this fuss about internal definitions. The<br>
way he sees it, if you don’t like to use define inside a procedure, you can just<br>
use let. Illustrate what is loose about his reasoning by drawing an environment<br>
diagram that shows the environment in which the ⟨rest of body of f⟩ is evaluated<br>
during evaluation of the expression (f 5), with f defined as in this exercise.<br>
Draw an environment diagram for the same evaluation, but with let in place of<br>
letrec in the definition of f.<br>
</p>
</div>
<div id="outline-container-org8cd8fb2" class="outline-4">
<h4 id="org8cd8fb2">Answer</h4>
<div class="outline-text-4" id="text-org8cd8fb2">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">1.</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">letrec-&gt;let</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>%as-syntax
   <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span>
       ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">map</span> <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">generate the (binding . '*unassigned) let binds</span>
         <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>v<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>list v ''*unassigned<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
         <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">map</span> car <span style="color: #b58900;">(</span>cadr expr<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>

     ,@<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">map</span> <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">generate the `set!' expressions</span>
        <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>bind<span style="color: #b58900;">)</span> `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> ,<span style="color: #268bd2;">(</span>car bind<span style="color: #268bd2;">)</span> ,<span style="color: #268bd2;">(</span>cadr bind<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>let-bindings expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">and merge our existing body</span>
     ,@<span style="color: #6c71c4;">(</span>let-body expr<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>assert-equal
 <span style="color: #b58900;">(</span>letrec-&gt;let
  `<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">letrec</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span>a <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #268bd2;">()</span> <span style="color: #268bd2;">(</span>b<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
            <span style="color: #859900;">(</span>b <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #268bd2;">()</span> <span style="color: #268bd2;">(</span>a<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>x a<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>x b<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>x c<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>

 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>a '*unassigned<span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>b '*unassigned<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">set!</span> a <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #859900;">()</span> <span style="color: #859900;">(</span>b<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">set!</span> b <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #859900;">()</span> <span style="color: #859900;">(</span>a<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>x a<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>x b<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>x c<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">letrec</span> ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp env<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>zeval <span style="color: #859900;">(</span>letrec-&gt;let exp<span style="color: #859900;">)</span> env<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">2.</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">The main problem with Louis's reasoning is that the environment that `let' is</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">being evaluating against is actually expressed in the form of a `lambda' whoses</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">actual function bodies are being passed in as arguments (in the case of (f x)),</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">this means that the lexical scope of `even?' cannot see that of `odd?' and</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">versa.</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgadfc336" class="outline-3">
<h3 id="orgadfc336">Exercise 4.21</h3>
<div class="outline-text-3" id="text-orgadfc336">
<p class="verse">
Amazingly, Louis’s intuition in Exercise 4.20 is correct. It is indeed possible<br>
to specify recursive procedures without using letrec (or even define), although<br>
the method for accomplishing this is much more subtle than Louis imagined. The<br>
following expression computes 10 factorial by applying a recursive factorial<br>
procedure:231<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;((lambda (n)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;((lambda (fact) (fact fact n))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lambda (ft k)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if (= k 1)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;1<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(* k (ft ft (- k 1)))))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;10)<br>
<br>
1. Check (by evaluating the expression) that this really does compute<br>
factorials. Devise an analogous expression for computing Fibonacci numbers.<br>
<br>
Consider the following procedure, which includes mutually recursive internal<br>
definitions:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (f x)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (even? n)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if (= n 0)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;true<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(odd? (- n 1))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (odd? n)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if (= n 0)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;false<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(even? (- n 1))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(even? x))<br>
<br>
2. Fill in the missing expressions to complete an alternative definition of f,<br>
which uses neither internal definitions nor letrec:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (f x)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;((lambda (even? odd?)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(even? even? odd? x))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lambda (ev? od? n)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if (= n 0)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;true<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(od? ⟨??⟩ ⟨??⟩ ⟨??⟩)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lambda (ev? od? n)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if (= n 0)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;false<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(ev? ⟨??⟩ ⟨??⟩ ⟨??⟩)))))<br>
</p>
<p>
<b>*</b> Answer
</p>
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">1.</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">It does indeed produce Factorials</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">funk-fibonacci</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #268bd2;">(</span>n<span style="color: #268bd2;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">(it's a fibonacci number)</span>
    <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>fib<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>fib fib n<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>fb k<span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">match</span> k
         <span style="color: #b58900;">[</span><span style="color: #6c71c4;">0</span> <span style="color: #6c71c4;">1</span><span style="color: #b58900;">]</span>
         <span style="color: #b58900;">[</span><span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">1</span><span style="color: #b58900;">]</span>
         <span style="color: #b58900;">[</span>_ <span style="color: #268bd2;">(</span>+ <span style="color: #6c71c4;">(</span>fb fb <span style="color: #859900;">(</span>- k <span style="color: #6c71c4;">1</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
               <span style="color: #6c71c4;">(</span>fb fb <span style="color: #859900;">(</span>- k <span style="color: #6c71c4;">2</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">]</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">2.</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">feven-4.21</span> x<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>even? odd?<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>even? even? odd? x<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
   <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>ev? od? n<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>= n <span style="color: #6c71c4;">0</span><span style="color: #859900;">)</span>
         #t
         <span style="color: #859900;">(</span>od? ev? od? <span style="color: #b58900;">(</span>- n <span style="color: #6c71c4;">1</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
   <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>ev? od? n<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>= n <span style="color: #6c71c4;">0</span><span style="color: #859900;">)</span>
         #f
         <span style="color: #859900;">(</span>ev? ev? od? <span style="color: #b58900;">(</span>- n <span style="color: #6c71c4;">1</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>assert <span style="color: #b58900;">(</span>= <span style="color: #268bd2;">(</span>funk-fibonacci <span style="color: #6c71c4;">4</span><span style="color: #268bd2;">)</span> <span style="color: #6c71c4;">5</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>assert <span style="color: #b58900;">(</span>feven-4.21 <span style="color: #6c71c4;">4</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>


<div id="outline-container-orgfe35eda" class="outline-3">
<h3 id="orgfe35eda">Exercise 4.22</h3>
<div class="outline-text-3" id="text-orgfe35eda">
<p class="verse">
Extend the evaluator in this section to support the special form let. (See Exercise 4.6.)<br>
</p>
</div>
<div id="outline-container-org7b9811c" class="outline-4">
<h4 id="org7b9811c">Answer</h4>
<div class="outline-text-4" id="text-org7b9811c">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>install-analyze-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>analyze <span style="color: #859900;">(</span>let-&gt;combination exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8628d12" class="outline-3">
<h3 id="org8628d12">Exercise 4.25</h3>
<div class="outline-text-3" id="text-org8628d12">
<p class="verse">
Suppose that (in ordinary applicative-order Scheme) we define unless as shown<br>
above and then define factorial in terms of unless as<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (factorial n)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(unless (= n 1)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(* n (factorial (- n 1)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;1))<br>
What happens if we attempt to evaluate (factorial 5)? Will our definitions work<br>
in a normal-order language?<br>
</p>
</div>
<div id="outline-container-org675f576" class="outline-4">
<h4 id="org675f576">Answer</h4>
<div class="outline-text-4" id="text-org675f576">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solution:</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Applicative order languages will cause an infinite loop with the definition</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">of `unless' provided by SICP -- on the other hand a normal-order language will</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">do just fine</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga57f927" class="outline-3">
<h3 id="orga57f927">Exercise 4.26</h3>
<div class="outline-text-3" id="text-orga57f927">
<p class="verse">
Ben Bitdiddle and Alyssa P. Hacker disagree over the importance of lazy<br>
evaluation for implementing things such as unless. Ben points out that it’s<br>
possible to implement unless in applicative order as a special form. Alyssa<br>
counters that, if one did that, unless would be merely syntax, not a procedure<br>
that could be used in conjunction with higher-order procedures. Fill in the<br>
details on both sides of the argument. Show how to implement unless as a derived<br>
expression (like cond or let), and give an example of a situation where it might<br>
be useful to have unless available as a procedure, rather than as a special<br>
form.<br>
</p>
</div>
<div id="outline-container-org8f239ab" class="outline-4">
<h4 id="org8f239ab">Answer</h4>
<div class="outline-text-4" id="text-org8f239ab">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">zv-unless</span> condition consequent alternative<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> condition alternative
      consequent<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>generate-accessors
 <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>unless-predicate cadr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>unless-alternative caddr<span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">unless-consequent</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>not <span style="color: #6c71c4;">(</span>null? <span style="color: #859900;">(</span>cdddr exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
      <span style="color: #268bd2;">(</span>cadddr exp<span style="color: #268bd2;">)</span>
      'false<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">unless-&gt;if</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>make-if
   <span style="color: #268bd2;">(</span>unless-predicate exp<span style="color: #268bd2;">)</span>
   <span style="color: #268bd2;">(</span>unless-consequent exp<span style="color: #268bd2;">)</span>
   <span style="color: #268bd2;">(</span>unless-alternative exp<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">analyze-unless</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>pproc <span style="color: #859900;">(</span>analyze <span style="color: #b58900;">(</span>unless-predicate exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>cproc <span style="color: #859900;">(</span>analyze <span style="color: #b58900;">(</span>unless-consequent exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>aproc <span style="color: #859900;">(</span>analyze <span style="color: #b58900;">(</span>unless-alternative exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #6c71c4;">(</span>env<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>true? <span style="color: #b58900;">(</span>pproc env<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>cproc env<span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>aproc env<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">unless</span> ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp env<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>zeval <span style="color: #859900;">(</span>unless-&gt;if exp<span style="color: #859900;">)</span> env<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>install-analyze-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">unless</span> ,analyze-unless<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">this functions utility is for lazy bums who cant type `not'</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Various evaluator utils</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgceac691" class="outline-3">
<h3 id="orgceac691">Exercise 4.27</h3>
<div class="outline-text-3" id="text-orgceac691">
<p class="verse">
Suppose we type in the following definitions to the lazy evaluator:<br>
<br>
(define count 0)<br>
(define (id x) (set! count (+ count 1)) x)<br>
(define w (id (id 10)))<br>
<br>
Give the missing values in the following sequence of interactions, and explain<br>
your answers.<br>
<br>
<br>
;;; L-Eval input:<br>
count<br>
<br>
;;; L-Eval value:<br>
1<br>
<br>
;;; L-Eval input:<br>
w<br>
<br>
;;; L-Eval value:<br>
10<br>
<br>
;;; L-Eval input:<br>
count<br>
<br>
;;; L-Eval value:<br>
2<br>
<br>
</p>
</div>
<div id="outline-container-org3007336" class="outline-4">
<h4 id="org3007336">Answer</h4>
<div class="outline-text-4" id="text-org3007336">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf4d3040" class="outline-3">
<h3 id="orgf4d3040">Exercise 4.28</h3>
<div class="outline-text-3" id="text-orgf4d3040">
<p class="verse">
lazy-eval uses actual-value rather than leval to evaluate the operator before passing<br>
it to apply, in order to force the value of the operator. Give an example that<br>
demonstrates the need for this forcing.<br>
<br>
</p>
</div>
<div id="outline-container-orgc7f873e" class="outline-4">
<h4 id="orgc7f873e">Answer</h4>
<div class="outline-text-4" id="text-orgc7f873e">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solution</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Any function using a lambda as an argument will fail -- the operands are</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">not forced and when trying to apply them you will attempt to apply a thunk</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">instead of a "real" value.</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga57fdd4" class="outline-3">
<h3 id="orga57fdd4">Exercise 4.29</h3>
<div class="outline-text-3" id="text-orga57fdd4">
<p class="verse">
Exhibit a program that you would expect to run much more slowly without<br>
memoization than with memoization. Also, consider the following interaction,<br>
where the id procedure is defined as in Exercise 4.27 and count starts at 0:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (square x) (* x x))<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; L-Eval input:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(square (id 10))<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; L-Eval value:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;⟨response⟩<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; L-Eval input:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;count<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; L-Eval value:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;⟨response⟩<br>
<br>
Give the responses both when the evaluator memoizes and when it does not.<br>
<br>
</p>
</div>
<div id="outline-container-org60e78c4" class="outline-4">
<h4 id="org60e78c4">Answer</h4>
<div class="outline-text-4" id="text-org60e78c4">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solutions</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">The canonical example of a function sped up by memoization is factorial --</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">each of the components can be reused n^2 times</span>


<span style="color: #93a1a1;">#| Memoized:</span>
<span style="color: #93a1a1;">;;; L-Eval input:</span>
<span style="color: #93a1a1;">(square (id 10))</span>

<span style="color: #93a1a1;">;;; L-Eval value:</span>
<span style="color: #93a1a1;">100</span>

<span style="color: #93a1a1;">;;; L-Eval input:</span>
<span style="color: #93a1a1;">count</span>

<span style="color: #93a1a1;">;;; L-Eval value:</span>
<span style="color: #93a1a1;">1</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #93a1a1;">#| Raw:</span>

<span style="color: #93a1a1;">;;; L-Eval input:</span>
<span style="color: #93a1a1;">(square (id 10))</span>

<span style="color: #93a1a1;">;;; L-Eval value:</span>
<span style="color: #93a1a1;">100</span>

<span style="color: #93a1a1;">;;; L-Eval input:</span>
<span style="color: #93a1a1;">count</span>

<span style="color: #93a1a1;">;;; L-Eval value:</span>
<span style="color: #93a1a1;">2</span>

<span style="color: #93a1a1;">|#</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1ce7c3e" class="outline-3">
<h3 id="org1ce7c3e">Exercise 4.30</h3>
<div class="outline-text-3" id="text-org1ce7c3e">
<p class="verse">
Cy D. Fect, a reformed C programmer, is worried that some side effects may never<br>
take place, because the lazy evaluator doesn’t force the expressions in a<br>
sequence. Since the value of an expression in a sequence other than the last one<br>
is not used (the expression is there only for its effect, such as assigning to a<br>
variable or printing), there can be no subsequent use of this value (e.g., as an<br>
argument to a primitive procedure) that will cause it to be forced. Cy thus<br>
thinks that when evaluating sequences, we must force all expressions in the<br>
sequence except the final one. He proposes to modify eval-sequence from 4.1.1 to<br>
use actual-value rather than eval:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (eval-sequence exps env)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(cond ((last-exp? exps)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(eval (first-exp exps) env))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(else<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(actual-value (first-exp exps)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;env)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(eval-sequence (rest-exps exps)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;env))))<br>
<br>
1. Ben Bitdiddle thinks Cy is wrong. He shows Cy the for-each procedure<br>
described in Exercise 2.23, which gives an important example of a sequence with<br>
side effects:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (for-each proc items)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if (null? items)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;'done<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(begin (proc (car items))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(for-each proc<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(cdr items)))))<br>
<br>
He claims that the evaluator in the text (with the original eval-sequence)<br>
handles this correctly:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; L-Eval input:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(for-each<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lambda (x) (newline) (display x))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;'(57 321 88))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;57<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;321<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;88<br>
<br>
;;; L-Eval value:<br>
done<br>
<br>
Explain why Ben is right about the behavior of for-each.<br>
<br>
2. Cy agrees that Ben is right about the for-each example, but says that that’s<br>
not the kind of program he was thinking about when he proposed his change to<br>
eval-sequence. He defines the following two procedures in the lazy evaluator:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (p1 x)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(set! x (cons x '(2)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;x)<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (p2 x)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (p e) e x)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(p (set! x (cons x '(2)))))<br>
<br>
What are the values of (p1 1) and (p2 1) with the original eval-sequence?<br>
What would the values be with Cy’s proposed change to eval-sequence?<br>
<br>
3. Cy also points out that changing eval-sequence as he proposes does not affect<br>
the behavior of the example in part a. Explain why this is true.<br>
<br>
4. How do you think sequences ought to be treated in the lazy evaluator? Do you<br>
like Cy’s approach, the approach in the text, or some other approach?<br>
<br>
</p>
</div>
<div id="outline-container-org362bf74" class="outline-4">
<h4 id="org362bf74">Answer</h4>
<div class="outline-text-4" id="text-org362bf74">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solutions</span>
<span style="color: #93a1a1;">1. In `for-each's case, the procedure is called every time, all primitive</span>
<span style="color: #93a1a1;">procedures are called -- even if they are the last.</span>

<span style="color: #93a1a1;">2.</span>
<span style="color: #93a1a1;">leval: (p1 1) =&gt; (1 2); (p2 1) =&gt; 1</span>
<span style="color: #93a1a1;">(`e' is never evaluated -- it's a compound procedure)</span>
<span style="color: #93a1a1;">actual-value: (p1 1) =&gt; (1 2); (p2 1) =&gt; (1 2)</span>

<span style="color: #93a1a1;">3. There is no difference -- primitive procedures are called either way</span>

<span style="color: #93a1a1;">4. Side effects are a critical aspect of computer programming -- a lazy computer</span>
<span style="color: #93a1a1;">system needs to execute them in a manner consistent with our expectations of a</span>
<span style="color: #93a1a1;">basic interpreter -- Cy's approach is the winner. |#</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgaae800c" class="outline-3">
<h3 id="orgaae800c">Exercise 4.31</h3>
<div class="outline-text-3" id="text-orgaae800c">
<p class="verse">
The approach taken in this section is somewhat unpleasant, because it makes an<br>
incompatible change to Scheme. It might be nicer to implement lazy evaluation as<br>
an upward-compatible extension, that is, so that ordinary Scheme programs will<br>
work as before. We can do this by extending the syntax of procedure declarations<br>
to let the user control whether or not arguments are to be delayed. While we’re<br>
at it, we may as well also give the user the choice between delaying with and<br>
without memoization. For example, the definition<br>
<br>
(define (f a (b lazy) c (d lazy-memo))<br>
…)<br>
<br>
would define f to be a procedure of four arguments, where the first and third<br>
arguments are evaluated when the procedure is called, the second argument is<br>
delayed, and the fourth argument is both delayed and memoized. Thus, ordinary<br>
procedure definitions will produce the same behavior as ordinary Scheme, while<br>
adding the lazy-memo declaration to each parameter of every compound procedure<br>
will produce the behavior of the lazy evaluator defined in this section. Design<br>
and implement the changes required to produce such an extension to Scheme. You<br>
will have to implement new syntax procedures to handle the new syntax for<br>
define. You must also arrange for eval or apply to determine when arguments are<br>
to be delayed, and to force or delay arguments accordingly, and you must arrange<br>
for forcing to memoize or not, as appropriate.<br>
<br>
</p>
</div>
<div id="outline-container-org04bab38" class="outline-4">
<h4 id="org04bab38">Answer</h4>
<div class="outline-text-4" id="text-org04bab38">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">perpetual-thunk?</span> obj<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>tagged-list? obj 'always-thunk<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">delay-it-perpetually</span> exp env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>list 'always-thunk exp env<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">list-of-resolved-args</span> parameters arguments env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">map</span>
   <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>p a<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">match</span> p
       <span style="color: #859900;">[</span><span style="color: #b58900;">(</span>_ 'lazy<span style="color: #b58900;">)</span>       <span style="color: #b58900;">(</span>delay-it-perpetually a env<span style="color: #b58900;">)</span><span style="color: #859900;">]</span>
       <span style="color: #859900;">[</span><span style="color: #b58900;">(</span>_ 'lazy-memo<span style="color: #b58900;">)</span>  <span style="color: #b58900;">(</span>delay-it a env<span style="color: #b58900;">)</span><span style="color: #859900;">]</span>
       <span style="color: #859900;">[</span>_               a<span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
   parameters
   arguments<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">force-it</span> obj<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"This is just a memoizing version of `force-it'"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">fetch-result</span> e<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>actual-value <span style="color: #6c71c4;">(</span>thunk-exp e<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>thunk-env e<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">match</span> obj
    <span style="color: #268bd2;">[</span>thunk?
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span><span style="color: #b58900;">[</span>result <span style="color: #268bd2;">(</span>fetch-result obj<span style="color: #268bd2;">)</span><span style="color: #b58900;">]</span><span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> obj `<span style="color: #b58900;">(</span>evaluated-thunk ,result<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
       result<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
    <span style="color: #268bd2;">[</span>evaluated-thunk? <span style="color: #6c71c4;">(</span>thunk-value obj<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
    <span style="color: #268bd2;">[</span>perpetual-thunk? <span style="color: #6c71c4;">(</span>fetch-result obj<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
    <span style="color: #268bd2;">[</span>_ obj<span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">fetch-parameter</span> p<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>pair? p<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>car p<span style="color: #268bd2;">)</span> p<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">extract-parameters</span> fn<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">map</span> fetch-parameter <span style="color: #268bd2;">(</span>procedure-parameters fn<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">capply</span> procedure arguments env<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"capply is a combined `apply' function -- determining which parameters are</span>
<span style="color: #2aa198;">lazy, memoized or raw and supplying them to the function at hand"</span>
  <span style="color: #93a1a1;">;;</span><span style="color: #93a1a1;">(format #t "procedure: ~a\narguments: ~a\nenv: ~a" procedure arguments env)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">cond</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>primitive-procedure? procedure<span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>apply-primitive-procedure
          procedure
          <span style="color: #859900;">(</span>list-of-arg-values arguments env<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>  <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">changed</span>
        <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>compound-procedure? procedure<span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>leval-sequence
          <span style="color: #859900;">(</span>procedure-body procedure<span style="color: #859900;">)</span>

          <span style="color: #859900;">(</span>extend-environment
           <span style="color: #b58900;">(</span>extract-parameters procedure<span style="color: #b58900;">)</span>
           <span style="color: #b58900;">(</span>list-of-resolved-args <span style="color: #268bd2;">(</span>procedure-parameters procedure<span style="color: #268bd2;">)</span>
                                  arguments
                                  env<span style="color: #b58900;">)</span> <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">changed</span>
           <span style="color: #b58900;">(</span>procedure-environment procedure<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">else</span> <span style="color: #6c71c4;">(</span>error <span style="color: #2aa198;">"Unknown procedure type: APPLY"</span> procedure<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Install our new driver-loop</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">combined-driver-loop</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>prompt-for-input <span style="color: #2aa198;">";; Strict/Lazy (ceval) input: "</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>input <span style="color: #859900;">(</span>read<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>output <span style="color: #859900;">(</span>actual-value input the-global-environment<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>announce-output output-prompt<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>user-print output<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>combined-driver-loop<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-driver-loop 'ceval combined-driver-loop<span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfa379fd" class="outline-3">
<h3 id="orgfa379fd">Exercise 4.35</h3>
<div class="outline-text-3" id="text-orgfa379fd">
<p class="verse">
Write a procedure an-integer-between that returns an integer between two given<br>
bounds. This can be used to implement a procedure that finds Pythagorean<br>
triples, i.e., triples of integers ( i , j , k ) between the given bounds such<br>
that i ≤ j and i 2 + j 2 = k 2 , as follows:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (a-pythagorean-triple-between low high)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((i (an-integer-between low high)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((j (an-integer-between i high)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((k (an-integer-between j high)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(require (= (+ (* i i) (* j j))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(* k k)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(list i j k)))))<br>
<br>
</p>
</div>
<div id="outline-container-orgfbf6fa4" class="outline-4">
<h4 id="orgfbf6fa4">Answer</h4>
<div class="outline-text-4" id="text-orgfbf6fa4">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">an-integer-between</span> low high<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>&lt; low high<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>amb low
         <span style="color: #6c71c4;">(</span>an-integer-between <span style="color: #859900;">(</span>+ <span style="color: #6c71c4;">1</span> low<span style="color: #859900;">)</span> high<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org4b40434" class="outline-3">
<h3 id="org4b40434">Exercise 4.36</h3>
<div class="outline-text-3" id="text-org4b40434">
<p class="verse">
Exercise 3.69 discussed how to generate the stream of all Pythagorean triples,<br>
with no upper bound on the size of the integers to be searched. Explain why<br>
simply replacing an-integer-between by an-integer-starting-from in the procedure<br>
in Exercise 4.35 is not an adequate way to generate arbitrary Pythagorean<br>
triples. Write a procedure that actually will accomplish this. (That is, write a<br>
procedure for which repeatedly typing try-again would in principle eventually<br>
generate all Pythagorean triples.)<br>
</p>
</div>
<div id="outline-container-orgec892f7" class="outline-4">
<h4 id="orgec892f7">Answer</h4>
<div class="outline-text-4" id="text-orgec892f7">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>sqrt ,sqrt<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">pyth-triple</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">k</span> <span style="color: #6c71c4;">(</span>an-integer-starting-from <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">j</span> <span style="color: #6c71c4;">(</span>an-integer-between <span style="color: #6c71c4;">1</span> k<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">i</span> <span style="color: #6c71c4;">(</span>an-integer-between <span style="color: #6c71c4;">1</span> j<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>= <span style="color: #859900;">(</span>+ <span style="color: #b58900;">(</span>* i i<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>* j j<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
                <span style="color: #859900;">(</span>* k k<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>list i j k<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">#| Solution Explanation:</span>
<span style="color: #93a1a1;">Depth first search means that an infinite `amb' loop will never progress past</span>
<span style="color: #93a1a1;">the first 'amb' |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf1367ed" class="outline-3">
<h3 id="orgf1367ed">Exercise 4.37</h3>
<div class="outline-text-3" id="text-orgf1367ed">
<p class="verse">
Ben Bitdiddle claims that the following method for generating Pythagorean<br>
triples is more efficient than the one in Exercise 4.35. Is he correct? (Hint:<br>
Consider the number of possibilities that must be explored.)<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (a-pythagorean-triple-between low high)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((i (an-integer-between low high))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(hsq (* high high)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((j (an-integer-between i high)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((ksq (+ (* i i) (* j j))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(require (&gt;= hsq ksq))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((k (sqrt ksq)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(require (integer? k))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(list i j k))))))<br>
<br>
</p>
</div>
<div id="outline-container-org4ce5706" class="outline-4">
<h4 id="org4ce5706">Answer</h4>
<div class="outline-text-4" id="text-org4ce5706">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">It seems to be -- Ben's method only uses N^2 space, while the .35 method uses</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">N^3 space, while also throwing away tons of 'impossible' results.</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3b55b26" class="outline-3">
<h3 id="org3b55b26">Exercise 4.38</h3>
<div class="outline-text-3" id="text-org3b55b26">
<p class="verse">
Modify the multiple-dwelling procedure to omit the requirement that Smith and<br>
Fletcher do not live on adjacent floors. How many solutions are there to this<br>
modified puzzle?<br>
</p>
</div>
<div id="outline-container-orgc416aac" class="outline-4">
<h4 id="orgc416aac">Answer</h4>
<div class="outline-text-4" id="text-orgc416aac">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution</span>

<span style="color: #93a1a1;">;; There are 5 distinct solutions</span>

<span style="color: #93a1a1;">|#</span>
<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">multiple-dwelling</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">baker</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">cooper</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">fletcher</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">miller</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">smith</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require
     <span style="color: #6c71c4;">(</span>distinct? <span style="color: #859900;">(</span>list baker cooper fletcher
                      miller smith<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= baker <span style="color: #6c71c4;">5</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= cooper <span style="color: #6c71c4;">1</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= fletcher <span style="color: #6c71c4;">5</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= fletcher <span style="color: #6c71c4;">1</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>&gt; miller cooper<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require
     <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= <span style="color: #b58900;">(</span>abs <span style="color: #268bd2;">(</span>- fletcher cooper<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> <span style="color: #6c71c4;">1</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>list <span style="color: #6c71c4;">(</span>list 'baker baker<span style="color: #6c71c4;">)</span>
          <span style="color: #6c71c4;">(</span>list 'cooper cooper<span style="color: #6c71c4;">)</span>
          <span style="color: #6c71c4;">(</span>list 'fletcher fletcher<span style="color: #6c71c4;">)</span>
          <span style="color: #6c71c4;">(</span>list 'miller miller<span style="color: #6c71c4;">)</span>
          <span style="color: #6c71c4;">(</span>list 'smith smith<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc92c731" class="outline-3">
<h3 id="orgc92c731">Exercise 4.39</h3>
<div class="outline-text-3" id="text-orgc92c731">
<p class="verse">
Does the order of the restrictions in the multiple-dwelling procedure affect the<br>
answer? Does it affect the time to find an answer? If you think it matters,<br>
demonstrate a faster program obtained from the given one by reordering the<br>
restrictions. If you think it does not matter, argue your case.<br>
</p>
</div>
<div id="outline-container-org2ea6b66" class="outline-4">
<h4 id="org2ea6b66">Answer</h4>
<div class="outline-text-4" id="text-org2ea6b66">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">The order of the restrictions can matter regarding runtime invoking the</span>
<span style="color: #93a1a1;">'failure' continuation through a `require' statement or otherwise can prevent a</span>
<span style="color: #93a1a1;">great deal of work from being performed.</span>
<span style="color: #93a1a1;">|#</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org4e7b8b6" class="outline-3">
<h3 id="org4e7b8b6">TODO: Exercise 4.40</h3>
<div class="outline-text-3" id="text-org4e7b8b6">
<p class="verse">
In the multiple dwelling problem, how many sets of assignments are there of<br>
people to floors, both before and after the requirement that floor assignments<br>
be distinct? It is very inefficient to generate all possible assignments of<br>
people to floors and then leave it to backtracking to eliminate them. For<br>
example, most of the restrictions depend on only one or two of the person-floor<br>
variables, and can thus be imposed before floors have been selected for all the<br>
people. Write and demonstrate a much more efficient nondeterministic procedure<br>
that solves this problem based upon generating only those possibilities that are<br>
not already ruled out by previous restrictions. (Hint: This will require a nest<br>
of `let' expressions.)<br>
</p>
</div>
<div id="outline-container-org1cde02e" class="outline-4">
<h4 id="org1cde02e">Answer</h4>
<div class="outline-text-4" id="text-org1cde02e">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3ca8d81" class="outline-3">
<h3 id="org3ca8d81">Exercise 4.41</h3>
<div class="outline-text-3" id="text-org3ca8d81">
<p class="verse">
Write an ordinary Scheme program to solve the multiple dwelling puzzle.<br>
</p>
</div>
<div id="outline-container-orga03f6f2" class="outline-4">
<h4 id="orga03f6f2">Answer</h4>
<div class="outline-text-4" id="text-orga03f6f2">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">possible-floors</span> '<span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>baker <span style="color: #6c71c4;">(</span><span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
                          <span style="color: #268bd2;">[</span>cooper <span style="color: #6c71c4;">(</span><span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
                          <span style="color: #268bd2;">[</span>fletcher <span style="color: #6c71c4;">(</span><span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
                          <span style="color: #268bd2;">[</span>miller <span style="color: #6c71c4;">(</span><span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
                          <span style="color: #268bd2;">[</span>smith <span style="color: #6c71c4;">(</span><span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>


<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">solve-it</span> floors<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">valid?</span> lst<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">distinct?</span> lst<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">cond</span>
       <span style="color: #859900;">(</span><span style="color: #b58900;">(</span>null? lst<span style="color: #b58900;">)</span> #t<span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span><span style="color: #b58900;">(</span>null? <span style="color: #268bd2;">(</span>cdr lst<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> #t<span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">else</span>
        <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #268bd2;">(</span>not <span style="color: #6c71c4;">(</span>member <span style="color: #859900;">(</span>car lst<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>cdr lst<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
             <span style="color: #268bd2;">(</span>distinct? <span style="color: #6c71c4;">(</span>cdr lst<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span>distinct? <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">map</span> cdr lst<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>&gt; <span style="color: #859900;">(</span>assoc-ref lst 'miller<span style="color: #859900;">)</span>
            <span style="color: #859900;">(</span>assoc-ref lst 'cooper<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">check that smith and fletcher are not adjacent</span>
         <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= <span style="color: #6c71c4;">1</span> <span style="color: #b58900;">(</span>abs <span style="color: #268bd2;">(</span>- <span style="color: #6c71c4;">(</span>assoc-ref lst 'smith<span style="color: #6c71c4;">)</span>
                           <span style="color: #6c71c4;">(</span>assoc-ref lst 'fletcher<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= <span style="color: #6c71c4;">1</span> <span style="color: #b58900;">(</span>abs <span style="color: #268bd2;">(</span>- <span style="color: #6c71c4;">(</span>assoc-ref lst 'cooper<span style="color: #6c71c4;">)</span>
                           <span style="color: #6c71c4;">(</span>assoc-ref lst 'fletcher<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>

  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">recursive-level</span> lst acc<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>null? lst<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>valid? acc<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>display acc<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #859900;">(</span><span style="color: #b58900;">(</span>top <span style="color: #268bd2;">(</span>car lst<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
               <span style="color: #b58900;">(</span>name <span style="color: #268bd2;">(</span>car top<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
               <span style="color: #b58900;">(</span>pfloors <span style="color: #268bd2;">(</span>cadr top<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">map</span>
           <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #268bd2;">(</span>elt<span style="color: #268bd2;">)</span>
             <span style="color: #268bd2;">(</span>recursive-level <span style="color: #6c71c4;">(</span>cdr lst<span style="color: #6c71c4;">)</span>
                              <span style="color: #6c71c4;">(</span>cons <span style="color: #859900;">(</span>cons name elt<span style="color: #859900;">)</span> acc<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
           pfloors<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>

  <span style="color: #b58900;">(</span>recursive-level floors '<span style="color: #268bd2;">()</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org9c60efa" class="outline-3">
<h3 id="org9c60efa">Exercise 4.42</h3>
<div class="outline-text-3" id="text-org9c60efa">
<p class="verse">
&#xa0;Solve the following "Liars" puzzle (from Phillips 1934):<br>
<br>
&#xa0;Five schoolgirls sat for an examination.  Their parents&#x2013;so they<br>
&#xa0;thought&#x2013;showed an undue degree of interest in the result.  They<br>
&#xa0;therefore agreed that, in writing home about the examination, each<br>
&#xa0;girl should make one true statement and one untrue one.  The<br>
&#xa0;following are the relevant passages from their letters:<br>
<br>
&#xa0;- Betty: "Kitty was second in the examination.  I was only<br>
&#xa0;&#xa0;&#xa0;third."<br>
<br>
&#xa0;- Ethel: "You'll be glad to hear that I was on top.  Joan was<br>
&#xa0;&#xa0;&#xa0;second."<br>
<br>
&#xa0;- Joan: "I was third, and poor old Ethel was bottom."<br>
<br>
&#xa0;- Kitty: "I came out second.  Mary was only fourth."<br>
<br>
&#xa0;- Mary: "I was fourth.  Top place was taken by Betty."<br>
<br>
What in fact was the order in which the five girls were placed?<br>
</p>
</div>
<div id="outline-container-orga63e3c1" class="outline-4">
<h4 id="orga63e3c1">Answer</h4>
<div class="outline-text-4" id="text-orga63e3c1">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>a b<span style="color: #859900;">)</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> a b<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;;</span><span style="color: #93a1a1;">(append! primitive-procedures `((or ,(&#955; (a b) (or a b)))))</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">amb/eval-or</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"Both `or' and `and' can be implemented as primitive procedures without</span>
<span style="color: #2aa198;">significant issue, `amb/eval-or' exists to advance my knowledge of the</span>
<span style="color: #2aa198;">evaluator"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>disjunction <span style="color: #859900;">(</span>amb/analyze <span style="color: #b58900;">(</span>disjunct expr<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>rest-disjunctions <span style="color: #859900;">(</span>rest-disjunctions expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>env succeed fail<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>disjunction
       env
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>value fail2<span style="color: #b58900;">)</span>
         <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>true? value<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>succeed value fail2<span style="color: #268bd2;">)</span>
             <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>null? rest-disjunctions<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>succeed #f fail2<span style="color: #6c71c4;">)</span>
                 <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span>amb/eval-or <span style="color: #2aa198;">(</span>cons 'or rest-disjunctions<span style="color: #2aa198;">)</span><span style="color: #859900;">)</span> env succeed fail<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
       fail<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>amb/install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">or</span> ,amb/eval-or<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">xor</span> a b<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">or</span> a b<span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> a b<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">require-or</span> p1 p2<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>xor p1 p2<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">solve-liars</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">betty</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">ethel</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">joan</span>  <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">kitty</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">mary</span>  <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>

    <span style="color: #268bd2;">(</span>require
     <span style="color: #6c71c4;">(</span>distinct? <span style="color: #859900;">(</span>list betty ethel joan kitty mary<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">betty</span>
    <span style="color: #268bd2;">(</span>require-or <span style="color: #6c71c4;">(</span>= kitty <span style="color: #6c71c4;">2</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>= betty <span style="color: #6c71c4;">3</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">ethel</span>
    <span style="color: #268bd2;">(</span>require-or <span style="color: #6c71c4;">(</span>= ethel <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>= joan <span style="color: #6c71c4;">2</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">joan</span>
    <span style="color: #268bd2;">(</span>require-or <span style="color: #6c71c4;">(</span>= joan <span style="color: #6c71c4;">3</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>= ethel <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">kitty</span>
    <span style="color: #268bd2;">(</span>require-or <span style="color: #6c71c4;">(</span>= kitty <span style="color: #6c71c4;">2</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>= mary <span style="color: #6c71c4;">4</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">mary</span>
    <span style="color: #268bd2;">(</span>require-or <span style="color: #6c71c4;">(</span>= mary <span style="color: #6c71c4;">4</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>= <span style="color: #6c71c4;">1</span> betty<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>list
     <span style="color: #6c71c4;">(</span>list 'betty betty<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>list 'ethel ethel<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>list 'joan joan<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>list 'kitty kitty<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>list 'mary mary<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org261d25b" class="outline-3">
<h3 id="org261d25b">Exercise 4.43</h3>
<div class="outline-text-3" id="text-org261d25b">
<p class="verse">
Use the `amb' evaluator to solve the following puzzle<br>
<br>
Mary Ann Moore's father has a yacht and so has each of his four friends: Colonel<br>
Downing, Mr. Hall, Sir Barnacle Hood, and Dr. Parker. Each of the five also has<br>
one daughter and each has named his yacht after a daughter of one of the others.<br>
Sir Barnacle's yacht is the Gabrielle, Mr. Moore owns the Lorna; Mr. Hall the<br>
Rosalind. The Melissa, owned by Colonel Downing, is named after Sir Barnacle's<br>
daughter. Gabrielle's father owns the yacht that is named after Dr. Parker's<br>
daughter. Who is Lorna's father?<br>
<br>
Try to write the program so that it runs efficiently. Also determine how many<br>
solutions there are if we are not told that Mary Ann's last name is Moore.<br>
</p>
</div>
<div id="outline-container-orgf1436c5" class="outline-4">
<h4 id="orgf1436c5">Answer</h4>
<div class="outline-text-4" id="text-orgf1436c5">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #93a1a1;">#| </span>
<span style="color: #93a1a1;">&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9574;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;</span>
<span style="color: #93a1a1;">&#9553; Individual  &#9553; Yacht      &#9553;</span>
<span style="color: #93a1a1;">&#9568;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9580;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9571;</span>
<span style="color: #93a1a1;">&#9553; Downing     &#9553; Melissa    &#9553;</span>
<span style="color: #93a1a1;">&#9568;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9580;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9571;</span>
<span style="color: #93a1a1;">&#9553; Hall        &#9553; Rosalind   &#9553;</span>
<span style="color: #93a1a1;">&#9568;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9580;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9571;</span>
<span style="color: #93a1a1;">&#9553; Moore       &#9553; Lorna      &#9553;</span>
<span style="color: #93a1a1;">&#9568;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9580;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9571;</span>
<span style="color: #93a1a1;">&#9553; Hood        &#9553; Gabrielle  &#9553;</span>
<span style="color: #93a1a1;">&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9577;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;</span>
<span style="color: #93a1a1;">Gabrielle's father owns the yacht that is named after Dr. Parker's daughter</span>
<span style="color: #93a1a1;">&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9574;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;</span>
<span style="color: #93a1a1;">&#9553; Parker's Daughter      &#9553; Gabrielle's Father's Ship &#9553;</span>
<span style="color: #93a1a1;">&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9577;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;</span>
<span style="color: #93a1a1;">The Melissa, owned by Colonel Downing, is named after Sir Barnacle's daughter.</span>
<span style="color: #93a1a1;">&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9574;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;</span>
<span style="color: #93a1a1;">&#9553; Barnacle    &#9553; (Daughter: Melissa)       &#9553;</span>
<span style="color: #93a1a1;">&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9577;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>eq? ,eq?<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>cadr ,cadr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>caddr ,caddr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">sailors</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">father</span> car<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">daughter</span> cadr<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">yacht</span> caddr<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">different-names</span> father<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>eq? <span style="color: #b58900;">(</span>daughter father<span style="color: #b58900;">)</span>
                <span style="color: #b58900;">(</span>yacht father<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>

    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span>moore   <span style="color: #b58900;">(</span>list 'moore
                         'mary-ann
                         'lorna<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>hood    <span style="color: #b58900;">(</span>list 'hood
                         'melissa
                         'gabrielle<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>hall    <span style="color: #b58900;">(</span>list 'hall
                         <span style="color: #268bd2;">(</span>amb 'gabrielle 'lorna<span style="color: #268bd2;">)</span>
                         'rosalind<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>downing <span style="color: #b58900;">(</span>list 'downing
                         <span style="color: #268bd2;">(</span>amb 'gabrielle 'lorna 'rosalind<span style="color: #268bd2;">)</span>
                         'melissa<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>parker <span style="color: #b58900;">(</span>list 'parker
                        <span style="color: #268bd2;">(</span>amb 'gabrielle 'lorna 'rosalind<span style="color: #268bd2;">)</span>
                        'mary-anne<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>

      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span><span style="color: #b58900;">(</span>gabrielle-father <span style="color: #268bd2;">(</span>amb hall downing parker<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
            <span style="color: #b58900;">(</span>lorna-father     <span style="color: #268bd2;">(</span>amb hall downing parker<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>require <span style="color: #b58900;">(</span>eq? <span style="color: #268bd2;">(</span>daughter gabrielle-father<span style="color: #268bd2;">)</span> 'gabrielle<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>require <span style="color: #b58900;">(</span>eq? <span style="color: #268bd2;">(</span>daughter lorna-father<span style="color: #268bd2;">)</span> 'lorna<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>require <span style="color: #b58900;">(</span>different-names lorna-father<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>require <span style="color: #b58900;">(</span>different-names gabrielle-father<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>require <span style="color: #b58900;">(</span>eq? <span style="color: #268bd2;">(</span>daughter parker<span style="color: #268bd2;">)</span>
                      <span style="color: #268bd2;">(</span>yacht gabrielle-father<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        lorna-father<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org140f38b" class="outline-3">
<h3 id="org140f38b">TODO: Exercise 4.44</h3>
<div class="outline-text-3" id="text-org140f38b">
<p class="verse">
Exercise 2.42 described the “eight-queens puzzle” of placing queens on a<br>
chessboard so that no two attack each other. Write a nondeterministic program to<br>
solve this puzzle.<br>
</p>
</div>
<div id="outline-container-org7f6a992" class="outline-4">
<h4 id="org7f6a992">Answer</h4>
<div class="outline-text-4" id="text-org7f6a992">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>

<p>
#+end<sub>src</sub>
</p>
</div>
</div>
</div>
<div id="outline-container-orgc15a102" class="outline-3">
<h3 id="orgc15a102">Exercise 4.45</h3>
<div class="outline-text-3" id="text-orgc15a102">
<p class="verse">
Programs designed to accept natural language as input usually start by<br>
&#xa0;&#xa0;attempting to "parse" the input, that is, to match the input against some<br>
&#xa0;&#xa0;grammatical structure. For example, we might try to recognize simple sentences<br>
&#xa0;&#xa0;consisting of an article followed by a noun followed by a verb, such as "The cat<br>
&#xa0;&#xa0;eats." To accomplish such an analysis, we must be able to identify the parts of<br>
&#xa0;&#xa0;speech of individual words. We could start with some lists that classify various<br>
&#xa0;&#xa0;words:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(append! primitive-procedures `((set! ,(λ (x y) (set! x y)))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(append! primitive-procedures `((memq ,memq)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(map amb/infuse<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;'((define nouns '(noun student professor cat class))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define verbs '(verb studies lectures eats sleeps))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define articles '(article the a))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define prepositions '(prep for to in by with))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define <b>unparsed</b> '())<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (parse-sentence)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(list 'sentence<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(parse-noun-phrase)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(parse-verb-phrase)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (parse-word word-list)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(require (not (null? <b>unparsed</b>)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(require (memq (car <b>unparsed</b>) (cdr word-list)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((found-word (car <b>unparsed</b>)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(set! <b>unparsed</b> (cdr <b>unparsed</b>))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(list (car word-list) found-word)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (parse input)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(set! <b>unparsed</b> input)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((sent (parse-sentence)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(require (null? <b>unparsed</b>))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;sent))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (parse-prepositional-phrase)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(list 'prep-phrase<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(parse-word prepositions)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(parse-noun-phrase)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (parse-verb-phrase)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (maybe-extend verb-phrase)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(amb verb-phrase<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(maybe-extend (list 'verb-phrase<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;verb-phrase<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(parse-prepositional-phrase)))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(maybe-extend (parse-word verbs)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (parse-simple-noun-phrase)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(list 'simple-noun-phrase<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(parse-word articles)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(parse-word nouns)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (parse-noun-phrase)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (maybe-extend noun-phrase)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(amb noun-phrase<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(maybe-extend (list 'noun-phrase<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;noun-phrase<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(parse-prepositional-phrase)))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(maybe-extend (parse-simple-noun-phrase)))))<br>
&#xa0;With the grammar given above, the following sentence can be parsed in five<br>
&#xa0;different ways: "the professor lectures to the student in the class with the<br>
&#xa0;cat." Give the five parses and explain the differences in shades of meaning<br>
&#xa0;among them.<br>
</p>
</div>
<div id="outline-container-org483813e" class="outline-4">
<h4 id="org483813e">Answer</h4>
<div class="outline-text-4" id="text-org483813e">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#|</span>
<span style="color: #93a1a1;">(parse '(the professor lectures to the student in the class with the cat)) ~&gt;</span>

<span style="color: #93a1a1;">(sentence</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun professor))</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb lectures)</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep to)</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun student))))</span>
<span style="color: #93a1a1;">(prep-phrase (prep in) (simple-noun-phrase (article the) (noun class))))</span>
<span style="color: #93a1a1;">(prep-phrase (prep with) (simple-noun-phrase (article the) (noun cat)))))</span>


<span style="color: #93a1a1;">(sentence</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun professor))</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb lectures)</span>
<span style="color: #93a1a1;">(prep-phrase (prep to) (simple-noun-phrase (article the) (noun student))))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep in)</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun class))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep with)</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun cat)))))))</span>

<span style="color: #93a1a1;">(sentence</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun professor))</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb lectures)</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep to)</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun student))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep in)</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun class))))))</span>
<span style="color: #93a1a1;">(prep-phrase (prep with) (simple-noun-phrase (article the) (noun cat)))))</span>

<span style="color: #93a1a1;">(sentence</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun professor))</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb lectures)</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep to)</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun student))</span>
<span style="color: #93a1a1;">(prep-phrase (prep in) (simple-noun-phrase (article the) (noun class))))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep with)</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun cat)))))))</span>

<span style="color: #93a1a1;">(sentence</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun professor))</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb lectures)</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep to)</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun student))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep in)</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun class))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep with)</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun cat))))))))) |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org2612533" class="outline-3">
<h3 id="org2612533">Exercise 4.46</h3>
<div class="outline-text-3" id="text-org2612533">
<p class="verse">
The evaluators in sections *Note and do not determine what order operands are<br>
evaluated in. We will see that the `amb' evaluator evaluates them from left to<br>
right. Explain why our parsing program wouldn't work if the operands were<br>
evaluated in some other order.<br>
</p>
</div>
<div id="outline-container-org9688806" class="outline-4">
<h4 id="org9688806">Answer</h4>
<div class="outline-text-4" id="text-org9688806">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| parse-word advances the *unparsed* list from left to right, because it knows</span>
<span style="color: #93a1a1;">that the parser works this way. Without being sure of the order, we couldn&#8217;t</span>
<span style="color: #93a1a1;">implement parse-word. |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org371e97c" class="outline-3">
<h3 id="org371e97c">Exercise 4.49</h3>
<div class="outline-text-3" id="text-org371e97c">
<p class="verse">
Alyssa P. Hacker is more interested in generating interesting sentences than in<br>
parsing them. She reasons that by simply changing the procedure `parse-word' so<br>
that it ignores the "input sentence" and instead always succeeds and generates<br>
an appropriate word, we can use the programs we had built for parsing to do<br>
generation instead. Implement Alyssa's idea, and show the first half-dozen or so<br>
sentences generated.<br>
</p>
</div>
<div id="outline-container-org4e69702" class="outline-4">
<h4 id="org4e69702">Answer</h4>
<div class="outline-text-4" id="text-org4e69702">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> amb/infuse
     '<span style="color: #b58900;">(</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>generate-sentence<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-sentence</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>list 'sentence
               <span style="color: #859900;">(</span>generate-noun-phrase<span style="color: #859900;">)</span>
               <span style="color: #859900;">(</span>generate-verb-phrase<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-word</span> word-list<span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>list <span style="color: #859900;">(</span>car word-list<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>amb word-list<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-prepositional-phrase</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>list 'prep-phrase
               <span style="color: #859900;">(</span>generate-word prepositions<span style="color: #859900;">)</span>
               <span style="color: #859900;">(</span>generate-noun-phrase<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-verb-phrase</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #859900;">(</span><span style="color: #268bd2;">maybe-extend</span> verb-phrase<span style="color: #859900;">)</span>
           <span style="color: #859900;">(</span>amb verb-phrase
                <span style="color: #b58900;">(</span>maybe-extend <span style="color: #268bd2;">(</span>list 'verb-phrase
                                    verb-phrase
                                    <span style="color: #6c71c4;">(</span>generate-prepositional-phrase<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>maybe-extend <span style="color: #859900;">(</span>generate-word verbs<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-simple-noun-phrase</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>list 'simple-noun-phrase
               <span style="color: #859900;">(</span>generate-word articles<span style="color: #859900;">)</span>
               <span style="color: #859900;">(</span>generate-word nouns<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-noun-phrase</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #859900;">(</span><span style="color: #268bd2;">maybe-extend</span> noun-phrase<span style="color: #859900;">)</span>
           <span style="color: #859900;">(</span>amb noun-phrase
                <span style="color: #b58900;">(</span>maybe-extend <span style="color: #268bd2;">(</span>list 'noun-phrase
                                    noun-phrase
                                    <span style="color: #6c71c4;">(</span>generate-prepositional-phrase<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>maybe-extend <span style="color: #859900;">(</span>generate-simple-noun-phrase<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8bb4f2a" class="outline-3">
<h3 id="org8bb4f2a">Exercise 4.50</h3>
<div class="outline-text-3" id="text-org8bb4f2a">
<p class="verse">
Implement a new special form ramb that is like amb except<br>
that it searches alternatives in a random order, rather than<br>
from left to right. Show how this can help with Alyssa’s<br>
problem in Exercise 4.49.<br>
</p>
</div>
<div id="outline-container-orge1287e5" class="outline-4">
<h4 id="orge1287e5">Answer</h4>
<div class="outline-text-4" id="text-orge1287e5">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">shuffle</span> lst<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"Returns a randomly re-ordered copy of `lst'"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>&lt; <span style="color: #6c71c4;">(</span>length lst<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">1</span><span style="color: #268bd2;">)</span> lst
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">[</span>item <span style="color: #b58900;">(</span>list-ref lst <span style="color: #268bd2;">(</span>random <span style="color: #6c71c4;">(</span>length lst<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>cons item <span style="color: #859900;">(</span>shuffle <span style="color: #b58900;">(</span>delete item lst<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">amb/analyze-ramb</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>amb/analyze-amb <span style="color: #268bd2;">(</span>cons
                    <span style="color: #6c71c4;">(</span>car exp<span style="color: #6c71c4;">)</span>
                    <span style="color: #6c71c4;">(</span>shuffle <span style="color: #859900;">(</span>amb/choices exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org02c681f" class="outline-3">
<h3 id="org02c681f">Exercise 4.51</h3>
<div class="outline-text-3" id="text-org02c681f">
<p class="verse">
Implement a new kind of assignment called permanent-set!<br>
that is not undone upon failure. For example, we can choose<br>
two distinct elements from a list and count the number of<br>
trials required to make a successful choice as follows:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define count 0)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((x (an-element-of '(a b c)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(y (an-element-of '(a b c))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(permanent-set! count (+ count 1))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(require (not (eq? x y)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(list x y count))<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; Starting a new problem<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; Amb-Eval value:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(a b 2)<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; Amb-Eval input:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;try-again<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; Amb-Eval value:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(a c 3)<br>
<br>
What values would have been displayed if we had used set!<br>
here rather than permanent-set!?<br>
</p>
</div>
<div id="outline-container-org9235cb0" class="outline-4">
<h4 id="org9235cb0">Answer</h4>
<div class="outline-text-4" id="text-org9235cb0">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>shuffle ,shuffle<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">amb/analyze-permanent-assignment</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"The execution procedure for permanent assignment is essentially a</span>
<span style="color: #2aa198;">redaction of the components of `analyze-assignment' that restore the value</span>
<span style="color: #2aa198;">of the old variable proceeding from a failed assignment"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>var <span style="color: #859900;">(</span>definition-variable exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">(</span>vproc <span style="color: #859900;">(</span>amb/analyze <span style="color: #b58900;">(</span>definition-value exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #6c71c4;">(</span>env succeed fail<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>vproc
       env
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>val fail2<span style="color: #b58900;">)</span>
         <span style="color: #b58900;">(</span>set-variable-value! var val env<span style="color: #b58900;">)</span>
         <span style="color: #b58900;">(</span>succeed
          'ok
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">a failure continues without restoring the old value</span>
          <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">()</span> <span style="color: #6c71c4;">(</span>fail2<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
       fail<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/install-procedure `<span style="color: #b58900;">(</span>permanent-set! ,amb/analyze-permanent-assignment<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">cps</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">count</span> <span style="color: #6c71c4;">0</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span>x <span style="color: #b58900;">(</span>car <span style="color: #268bd2;">(</span>amb '<span style="color: #6c71c4;">(</span>a b c<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>y <span style="color: #b58900;">(</span>car <span style="color: #268bd2;">(</span>amb '<span style="color: #6c71c4;">(</span>z b c<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>permanent-set! count <span style="color: #859900;">(</span>+ count <span style="color: #6c71c4;">1</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>require <span style="color: #859900;">(</span>not <span style="color: #b58900;">(</span>eq? x y<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>list x y count<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgaee6312" class="outline-3">
<h3 id="orgaee6312">Exercise 4.52</h3>
<div class="outline-text-3" id="text-orgaee6312">
<p class="verse">
Implement a new construct called `if-fail' that permits the<br>
user to catch the failure of an expression. `if-fail' takes<br>
two expressions. It evaluates the first expression as usual<br>
and returns as usual if the evaluation succeeds. If the<br>
evaluation fails, however, the value of the second<br>
expression is returned, as in the following example:<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; Amb-Eval input:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if-fail<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((x (an-element-of '(1 3 5))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(require (even? x))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;x)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;'all-odd)<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; Starting a new problem<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; Amb-Eval value:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;all-odd<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;;;; Amb-Eval input:<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if-fail<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((x (an-element-of '(1 3 5 8))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(require (even? x))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;x)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;'all-odd)<br>
<br>
;;; Starting a new problem<br>
;;; Amb-Eval value:<br>
8<br>
</p>
<p>
<b>*</b> Answer
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">amb/analyze-if-fail</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>clause      <span style="color: #859900;">(</span>amb/analyze <span style="color: #b58900;">(</span>cadr exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>alternative <span style="color: #859900;">(</span>caddr exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>env succeed fail<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>clause env
              <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">success, just suplly the result</span>
              <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>value fail2<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>succeed value fail2<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
              <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">fail, send our alternative</span>
              <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">()</span> <span style="color: #b58900;">(</span>succeed alternative fail<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/install-procedure `<span style="color: #b58900;">(</span>if-fail ,amb/analyze-if-fail<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org1494d47" class="outline-3">
<h3 id="org1494d47">Exercise 4.53</h3>
<div class="outline-text-3" id="text-org1494d47">
<p class="verse">
With `permanent-set!' as described in *Note4.51 and<br>
`if-fail' as in *Note Exercise 4.52, what will be the result<br>
of evaluating<br>
<br>
(let ((pairs '()))<br>
(if-fail (let ((p (prime-sum-pair '(1 3 5 8) '(20 35 110))))<br>
(permanent-set! pairs (cons p pairs))<br>
(amb))<br>
pairs))<br>
<br>
</p>
</div>
<div id="outline-container-org8790d6b" class="outline-4">
<h4 id="org8790d6b">Answer</h4>
<div class="outline-text-4" id="text-org8790d6b">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">It prints:</span>

<span style="color: #93a1a1;">((8 35) (3 110) (3 20))</span>

<span style="color: #93a1a1;">Although the let form always fails (it calls (amb) as its</span>
<span style="color: #93a1a1;">last statement), the pairs get added into pairs, because</span>
<span style="color: #93a1a1;">permanent-set! doesn&#8217;t roll assignments back from failed</span>
<span style="color: #93a1a1;">paths. |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org95d4093" class="outline-3">
<h3 id="org95d4093">Exercise 4.54</h3>
<div class="outline-text-3" id="text-org95d4093">
<p class="verse">
<br>
If we had not realized that require could be implemented as an ordinary<br>
procedure that uses `amb', to be defined by the user as part of a<br>
nondeterministic program, we would have had to implement it as a special<br>
form. This would require syntax procedures<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (require? exp)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(tagged-list? exp 'require))<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (require-predicate exp)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(cadr exp))<br>
<br>
and a new clause in the dispatch in analyze<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;((require? exp) (analyze-require exp))<br>
<br>
as well the procedure analyze-require that handles require expressions.<br>
Complete the following definition of analyze-require.<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(define (analyze-require exp)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(let ((pproc (analyze<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(require-predicate exp))))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lambda (env succeed fail)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(pproc env<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lambda (pred-value fail2)<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(if ⟨??⟩<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;⟨??⟩<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(succeed 'ok fail2)))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;fail))))<br>
</p>
</div>
<div id="outline-container-org2c69386" class="outline-4">
<h4 id="org2c69386">Answer</h4>
<div class="outline-text-4" id="text-org2c69386">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">require-predicate</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>cadr exp<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">amb/analyze-require</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>pproc <span style="color: #859900;">(</span>analyze <span style="color: #b58900;">(</span>require-predicate exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>env succeed fail<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>pproc
       env
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>value fail2<span style="color: #b58900;">)</span>
         <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>not <span style="color: #6c71c4;">(</span>true? value<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
             <span style="color: #268bd2;">(</span>fail<span style="color: #268bd2;">)</span>
             <span style="color: #268bd2;">(</span>succeed 'ok fail2<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
      fail<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgcf7d9f7" class="outline-3">
<h3 id="orgcf7d9f7">Exercise 4.55</h3>
<div class="outline-text-3" id="text-orgcf7d9f7">
<p class="verse">
Give simple queries that retrieve the following information from the data<br>
base:<br>
<br>
- all people supervised by Ben Bitdiddle;<br>
- the names and jobs of all people in the accounting division;<br>
- the names and addresses of all people who live in Slumerville.<br>
</p>
</div>
<div id="outline-container-org6084749" class="outline-4">
<h4 id="org6084749">Answer</h4>
<div class="outline-text-4" id="text-org6084749">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">Respectively:</span>

<span style="color: #93a1a1;">- (supervisor ?x (Bitdiddle Ben))</span>
<span style="color: #93a1a1;">- (job ?name (accounting . ?other))</span>
<span style="color: #93a1a1;">- (address ?name (Slumerville . ?rest))</span>
<span style="color: #93a1a1;">|#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgbec3836" class="outline-3">
<h3 id="orgbec3836">Exercise 4.56</h3>
<div class="outline-text-3" id="text-orgbec3836">
<p class="verse">
Formulate compound queries that retrieve the following information:<br>
<br>
a. the names of all people who are supervised by Ben Bitdiddle,<br>
together with their addresses;<br>
<br>
b. all people whose salary is less than Ben Bitdiddle's,<br>
together with their salary and Ben Bitdiddle's salary;<br>
<br>
c. all people who are supervised by someone who is not in the<br>
computer division, together with the supervisor's name and<br>
job.<br>
</p>
</div>
<div id="outline-container-orgfd7f511" class="outline-4">
<h4 id="orgfd7f511">Answer</h4>
<div class="outline-text-4" id="text-orgfd7f511">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solutions:</span>
<span style="color: #93a1a1;">a. (and (supervisor ?name (Bitdiddle Ben))</span>
<span style="color: #93a1a1;">(address ?name . ?rest))</span>

<span style="color: #93a1a1;">b. (and (salary ?person ?salary)</span>
<span style="color: #93a1a1;">(salary (Bitdiddle Ben) ?ben-salary)</span>
<span style="color: #93a1a1;">(lisp-value &gt; ?salary ?ben-salary))</span>

<span style="color: #93a1a1;">c. (and (supervisor ?supervisor ?supervisee)</span>
<span style="color: #93a1a1;">(job ?supervisor ?job))</span>
<span style="color: #93a1a1;">|#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org6446484" class="outline-3">
<h3 id="org6446484">Exercise 4.57</h3>
<div class="outline-text-3" id="text-org6446484">
<p class="verse">
Define a rule that says that person 1 can replace person 2 if either person<br>
1 does the same job as person 2 or someone who does person 1’s job can also<br>
do person 2’s job, and if person 1 and person 2 are not the same person.<br>
Using your rule, give queries that find the following:<br>
<br>
- all people who can replace Cy D. Fect;<br>
- all people who can replace someone who is being paid more than they are,<br>
&#xa0;&#xa0;together with the two salaries.<br>
</p>
</div>

<div id="outline-container-org81811c3" class="outline-4">
<h4 id="org81811c3">Answer</h4>
<div class="outline-text-4" id="text-org81811c3">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>replaceable ?p1 ?p2<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">or</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #b58900;">(</span>job ?p1 ?p1post<span style="color: #b58900;">)</span>
                      <span style="color: #b58900;">(</span>job ?p2 ?p1post<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
                 <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #b58900;">(</span>job ?p1 ?p1post<span style="color: #b58900;">)</span>
                      <span style="color: #b58900;">(</span>job ?p2 ?p2post<span style="color: #b58900;">)</span>
                      <span style="color: #b58900;">(</span>can-do-job ?p1post ?p2post<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
             <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>same ?p1 ?p2<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">- all people who can replace Cy D. Fect</span>
<span style="color: #93a1a1;">=&gt; (replaceable ?t (Fect Cy D))</span>
<span style="color: #93a1a1;">- all people who can replace someone who is being paid more than they are,</span>
<span style="color: #93a1a1;">together with the two salaries.</span>
<span style="color: #93a1a1;">=&gt; (and (replaceable ?p1 ?p2)</span>
<span style="color: #93a1a1;">(salary ?p1 ?s1)</span>
<span style="color: #93a1a1;">(salary ?p2 ?s2)</span>
<span style="color: #93a1a1;">(lisp-value &gt; ?s2 ?s1))</span>

<span style="color: #93a1a1;">|#</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1238de7" class="outline-3">
<h3 id="org1238de7">Exercise 4.58</h3>
<div class="outline-text-3" id="text-org1238de7">
<p class="verse">
Define a rule that says that a person is a "big shot" in a division if the<br>
person works in the division but does not have a supervisor who works in<br>
the division.<br>
</p>
</div>
<div id="outline-container-org0816a17" class="outline-4">
<h4 id="org0816a17">Answer</h4>
<div class="outline-text-4" id="text-org0816a17">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>big-shot ?p1<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span>
         <span style="color: #6c71c4;">(</span>job ?p1 <span style="color: #859900;">(</span>?dept . ?job<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">or</span>
          <span style="color: #859900;">(</span>not <span style="color: #b58900;">(</span>supervisor ?p1 ?p2<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #b58900;">(</span>supervisor ?p1 ?p2<span style="color: #b58900;">)</span>
               <span style="color: #b58900;">(</span>not <span style="color: #268bd2;">(</span>job ?p2 <span style="color: #6c71c4;">(</span>?dept . ?job2<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgdfd14ba" class="outline-3">
<h3 id="orgdfd14ba">Exercise 4.59</h3>
<div class="outline-text-3" id="text-orgdfd14ba">
<p class="verse">
Ben Bitdiddle has missed one meeting too many. Fearing that his habit of<br>
forgetting meetings could cost him his job, Ben decides to do something<br>
about it. He adds all the weekly meetings of the firm to the Microshaft<br>
data base by asserting the following:<br>
<br>
</p>
</div>
<div id="outline-container-orgfce28bb" class="outline-4">
<h4 id="orgfce28bb">Answer</h4>
<div class="outline-text-4" id="text-orgfce28bb">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> query/infuse
     '<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>meeting accounting <span style="color: #6c71c4;">(</span>Monday 9am<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>meeting administration <span style="color: #6c71c4;">(</span>Monday 10am<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>meeting computer <span style="color: #6c71c4;">(</span>Wednesday 3pm<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>meeting administration <span style="color: #6c71c4;">(</span>Friday 1pm<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">#|</span>
<span style="color: #93a1a1;">Each of the above assertions is for a meeting of an entire division.</span>
<span style="color: #93a1a1;">Ben also adds an entry for the company-wide meeting that spans all the</span>
<span style="color: #93a1a1;">divisions. All of the company's employees attend this meeting.</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #2aa198;">(</span>query/infuse '<span style="color: #b58900;">(</span>meeting whole-company <span style="color: #268bd2;">(</span>Wednesday 4pm<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">#|</span>

<span style="color: #93a1a1;">a. On Friday morning, Ben wants to query the data base for all the meetings</span>
<span style="color: #93a1a1;">that occur that day. What query should he use?</span>

<span style="color: #93a1a1;">b. Alyssa P. Hacker is unimpressed. She thinks it would be much more useful</span>
<span style="color: #93a1a1;">to be able to ask for her meetings by specifying her name. So she designs a</span>
<span style="color: #93a1a1;">rule that says that a person's meetings include all `whole-company'</span>
<span style="color: #93a1a1;">meetings plus all meetings of that person's division. Fill in the body of</span>
<span style="color: #93a1a1;">Alyssa's rule.</span>

<span style="color: #93a1a1;">(rule (meeting-time ?person ?day-and-time)</span>
<span style="color: #93a1a1;">&lt;RULE-BODY&gt;)</span>

<span style="color: #93a1a1;">c. Alyssa arrives at work on Wednesday morning and wonders what meetings</span>
<span style="color: #93a1a1;">she has to attend that day. Having defined the above rule, what query</span>
<span style="color: #93a1a1;">should she make to find this out?</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solutions:</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">a. (meeting ?meeting (Friday ?time))</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">b.</span>
<span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>meeting-time ?person ?day-and-time<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">or</span>
         <span style="color: #6c71c4;">(</span>meeting whole-company ?day-and-time<span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">and</span>
          <span style="color: #859900;">(</span>meeting ?division ?day-and-time<span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>job ?person <span style="color: #b58900;">(</span>?division . ?job<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">c. (meeting-time (Hacker Alyssa P) (Wednesday . ?x))</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge4742d3" class="outline-3">
<h3 id="orge4742d3">Exercise 4.60</h3>
<div class="outline-text-3" id="text-orge4742d3">
<p class="verse">
By giving the query<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lives-near ?person (Hacker Alyssa P))<br>
<br>
Alyssa P. Hacker is able to find people who live near her, with<br>
whom she can ride to work.  On the other hand, when she tries to<br>
find all pairs of people who live near each other by querying<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lives-near ?person-1 ?person-2)<br>
<br>
she notices that each pair of people who live near each other is<br>
listed twice; for example,<br>
<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lives-near (Hacker Alyssa P) (Fect Cy D))<br>
&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;&#xa0;(lives-near (Fect Cy D) (Hacker Alyssa P))<br>
<br>
Why does this happen?  Is there a way to find a list of people who<br>
live near each other, in which each pair appears only once?<br>
Explain.<br>
</p>
</div>
<div id="outline-container-org1b539f5" class="outline-4">
<h4 id="org1b539f5">Answer</h4>
<div class="outline-text-4" id="text-org1b539f5">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">The reason this occurs it that there is no 'ordering' on the results</span>
<span style="color: #93a1a1;">returned, e.g (Dewitt) (Louis) is equally valid to (Louis) (Dewitt) when</span>
<span style="color: #93a1a1;">the query analyzer searches through valid responses.</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>lives-near-only ?person-1 ?person-2<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span>
         <span style="color: #6c71c4;">(</span>address ?person-1 <span style="color: #859900;">(</span>?town . ?rest-1<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>address ?person-2 <span style="color: #859900;">(</span>?town . ?rest-2<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>same ?person-1 ?person-2<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>lisp-value <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #b58900;">(</span>x y<span style="color: #b58900;">)</span>
                       <span style="color: #b58900;">(</span>string&lt;=? <span style="color: #268bd2;">(</span>symbol-&gt;string <span style="color: #6c71c4;">(</span>car x<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
                                  <span style="color: #268bd2;">(</span>symbol-&gt;string <span style="color: #6c71c4;">(</span>car y<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span> ?person-1 ?person-2<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1fa1c5a" class="outline-3">
<h3 id="org1fa1c5a">Exercise 4.61</h3>
<div class="outline-text-3" id="text-org1fa1c5a">
<p class="verse">
The following rules implement a `next-to' relation that finds adjacent<br>
elements of a list:<br>
<br>
(rule (?x next-to ?y in (?x ?y . ?u)))<br>
<br>
(rule (?x next-to ?y in (?v . ?z))<br>
(?x next-to ?y in ?z))<br>
<br>
What will the response be to the following queries?<br>
<br>
(?x next-to ?y in (1 (2 3) 4))<br>
<br>
(?x next-to 1 in (2 1 3 1))<br>
<br>
</p>
</div>
<div id="outline-container-orgf0cf0ec" class="outline-4">
<h4 id="orgf0cf0ec">Answer</h4>
<div class="outline-text-4" id="text-orgf0cf0ec">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solution:</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">The rules written as-is are incompatible with the existing system, a s, I've resolved them in the following way:</span>

<span style="color: #2aa198;">(</span>query/infuse '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>next-to ?x ?y in <span style="color: #6c71c4;">(</span>?x ?y . ?u<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>query/infuse '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>next-to ?x ?y in <span style="color: #6c71c4;">(</span>?v . ?z<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
                     <span style="color: #268bd2;">(</span>next-to ?x ?y in ?z<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">(next-to ?x ?y in (1 (2 3) 4)) =&gt; ((1 (2 3) 4) ((2 3) 4))</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">(next-to ?x 1 in (2 1 3 1)) =&gt; ((3 1)  (2 1))</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org08fadef" class="outline-3">
<h3 id="org08fadef">Exercise 4.62</h3>
<div class="outline-text-3" id="text-org08fadef">
<p class="verse">
Define rules to implement the `last-pair' operation of *Note Exercise 2-17,<br>
which returns a list containing the last element of a nonempty list. Check<br>
your rules on queries such as `(last-pair (3) ?x)', `(last-pair (1 2 3)<br>
?x)', and `(last-pair (2 ?x) (3))'. Do your rules work correctly on queries<br>
such as `(last-pair ?x (3))' ?<br>
</p>
</div>
<div id="outline-container-orge9ffabd" class="outline-4">
<h4 id="orge9ffabd">Answer</h4>
<div class="outline-text-4" id="text-orge9ffabd">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solution, it does not work correctly on results that yield an infinite</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">nubmer of answers;</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> query/infuse
     '<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>last-pair <span style="color: #859900;">(</span>?h<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>?h<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>last-pair <span style="color: #859900;">(</span>?h . ?t<span style="color: #859900;">)</span> ?last<span style="color: #6c71c4;">)</span>
             <span style="color: #6c71c4;">(</span>last-pair ?t ?last<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org88b8e05" class="outline-3">
<h3 id="org88b8e05">Exercise 4.63</h3>
<div class="outline-text-3" id="text-org88b8e05">
<p class="verse">
The following data base (see Genesis 4) traces the genealogy of the<br>
descendants of Ada back to Adam, by way of Cain:<br>
<br>
</p>
</div>
<div id="outline-container-org9090a8e" class="outline-4">
<h4 id="org9090a8e">Answer</h4>
<div class="outline-text-4" id="text-org9090a8e">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> query/infuse
     '<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>son Adam Cain<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Cain Enoch<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Enoch Irad<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Irad Mehujael<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Mehujael Methushael<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Methushael Lamech<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>wife Lamech Ada<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Ada Jabal<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Ada Jubal<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">#|</span>
<span style="color: #93a1a1;">Formulate rules such as</span>

<span style="color: #93a1a1;">"If S is the son of f, and f is the son of</span>
<span style="color: #93a1a1;">G, then S is the grandson of G" and "If W is the wife of M, and S</span>
<span style="color: #93a1a1;">is the son of W, then S is the son of M"</span>

<span style="color: #93a1a1;">(which was supposedly more true in biblical times than today) that will</span>
<span style="color: #93a1a1;">enable the query system to find the grandson of Cain; the sons of Lamech;</span>
<span style="color: #93a1a1;">the grandsons of Methushael. (See *Note Exercise 4-69 for some rules to</span>
<span style="color: #93a1a1;">deduce more complicated relationships.)</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>grandparent ?g ?f ?s<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span>son ?g ?f<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>son ?f ?s<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>son-of ?w ?m ?s<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span>wife ?m ?w<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>son ?w ?s<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb4745a6" class="outline-3">
<h3 id="orgb4745a6">Exercise 4.64</h3>
<div class="outline-text-3" id="text-orgb4745a6">
<p class="verse">
Louis Reasoner mistakenly deletes the `outranked-by' rule<br>
(section *Note 4.4.1) from the data base. When he realizes this,<br>
he quickly reinstalls it. Unfortunately, he makes a slight change<br>
in the rule, and types it in as<br>
</p>
</div>
<div id="outline-container-orgbe32e8b" class="outline-4">
<h4 id="orgbe32e8b">Answer</h4>
<div class="outline-text-4" id="text-orgbe32e8b">
<p>
#+begin<sub>verse</sub>
 (query/infuse '(rule (loop-outranked-by ?staff-person ?boss)
 (or (supervisor ?staff-person ?boss)
 (and (outranked-by ?middle-manager ?boss)
 (supervisor ?staff-person ?middle-manager)))))
</p>

<p>
Just after Louis types this information into the system, DeWitt
Aull comes by to find out who outranks Ben Bitdiddle. He issues
the query
</p>

<p>
(outranked-by (Bitdiddle Ben) ?who)
</p>

<p>
After answering, the system goes into an infinite loop.  Explain
why. 
</p>

<p>
Solution:
</p>

<p>
The problem with this query is the order in which applicable rules are
specified.
</p>

<p>
  After finding the previous `supervisor' rule applied; that is, the
  rule conclusion `(supervisor (Bitdiddle Ben) ?boss)' successfully
  unifies with the query pattern `(supervisor ?staff-person ?boss)' to
  produce a frame in which `?boss' is bound to `?who'. The interpreter
  proceeds to evaluate the next rule: `(outranked-by ?middle-manager
  ?boss)' in the same frame.
  One answer appears in the database.
  The `outranked-by' rule is also applicable, so the evaluator again
evaluators the `outranked-by' rule body which is equivalent to
`(outranked-by ?middle-manager ?who)' |#
#+end<sub>src</sub>
</p>
</div>
</div>
</div>
<div id="outline-container-org792ac3d" class="outline-3">
<h3 id="org792ac3d">Exercise 4.65</h3>
<div class="outline-text-3" id="text-org792ac3d">
<p class="verse">
Cy D. Fect, looking forward to the day when he will rise in the<br>
organization, gives a query to find all the wheels<br>
(using the `wheel' rule of section *Note 4-4-1)<br>
<br>
(wheel ?who)<br>
<br>
To his surprise, the system responds<br>
<br>
;;; Query results:<br>
(wheel (Warbucks Oliver))<br>
(wheel (Bitdiddle Ben))<br>
(wheel (Warbucks Oliver))<br>
(wheel (Warbucks Oliver))<br>
(wheel (Warbucks Oliver))<br>
<br>
Why is Oliver Warbucks listed four times?<br>
</p>
</div>
<div id="outline-container-org327dfff" class="outline-4">
<h4 id="org327dfff">Answer</h4>
<div class="outline-text-4" id="text-org327dfff">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>

<span style="color: #93a1a1;">The body of `wheel' contains a query pattern</span>
<span style="color: #93a1a1;">`(supervisor ?x ?middle-manager)' that can be satisfied by a</span>
<span style="color: #93a1a1;">variety of different values, each of those values contributes</span>
<span style="color: #93a1a1;">a match to the rule |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf7c74e0" class="outline-3">
<h3 id="orgf7c74e0">Exercise 4.66</h3>
<div class="outline-text-3" id="text-orgf7c74e0">
<p class="verse">
Ben has been generalizing the query system to provide statistics about<br>
the company. For example, to find the total salaries of all the<br>
computer programmers one will be able to say<br>
<br>
(sum ?amount<br>
(and (job ?x (computer programmer))<br>
(salary ?x ?amount)))<br>
<br>
In general, Ben's new system allows expressions of the form<br>
<br>
(accumulation-function &lt;VARIABLE&gt;<br>
&lt;QUERY PATTERN&gt;)<br>
<br>
where `accumulation-function' can be things like `sum', `average', or<br>
`maximum'. Ben reasons that it should be a cinch to implement this. He<br>
will simply feed the query pattern to `qeval'. This will produce a<br>
stream of frames. He will then pass this stream through a mapping<br>
function that extracts the value of the designated variable from each<br>
frame in the stream and feed the resulting stream of values to the<br>
accumulation function. Just as Ben completes the implementation and is<br>
about to try it out, Cy walks by, still puzzling over the `wheel'<br>
query result in exercise *Note Exercise 4-65. When Cy shows Ben the<br>
system's response, Ben groans, "Oh, no, my simple accumulation scheme<br>
won't work!"<br>
<br>
What has Ben just realized? Outline a method he can use to salvage the<br>
situation.<br>
</p>
</div>
<div id="outline-container-orgab64157" class="outline-4">
<h4 id="orgab64157">Answer</h4>
<div class="outline-text-4" id="text-orgab64157">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution</span>
<span style="color: #93a1a1;">Although the query supplied doesn't demonstrate it, it is possible to</span>
<span style="color: #93a1a1;">have multiple frames returns. |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org0a4f477" class="outline-3">
<h3 id="org0a4f477">Exercise 4.67</h3>
<div class="outline-text-3" id="text-org0a4f477">
<p class="verse">
Devise a way to install a loop detector in the query system so as to<br>
avoid the kinds of simple loops illustrated in the text and in *NoteExercise 4.64.<br>
<br>
The general idea is that the system should maintain some sort of<br>
history of its current chain of deductions and should not begin<br>
processing a query that it is already working on. Describe what kind<br>
of information (patterns and frames) is included in this history, and<br>
how the check should be made. (After you study the details of the<br>
query-system implementation in section *Note 4.4.4, you may want to<br>
modify the system to include your loop detector.)<br>
</p>
</div>
<div id="outline-container-orga5c3ef7" class="outline-4">
<h4 id="orga5c3ef7">Answer</h4>
<div class="outline-text-4" id="text-orga5c3ef7">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Because the rule variable contains the execution information, we can</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">lookup if a rule with the exact same parameters has been called before.</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">executed-rules</span> '<span style="color: #b58900;">()</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">previously-executed?</span> rule<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>member rule executed-rules<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">add-executed-rule!</span> rule<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> executed-rules <span style="color: #268bd2;">(</span>cons rule executed-rules<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">noloop/apply-a-rule</span> rule query-pattern query-frame<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>previously-executed? rule<span style="color: #268bd2;">)</span> stream-null
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">[</span>clean-rule <span style="color: #b58900;">(</span>rename-variables-in rule<span style="color: #b58900;">)</span><span style="color: #859900;">]</span> <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">alpha-conversion</span>
             <span style="color: #859900;">[</span>unify-result <span style="color: #b58900;">(</span>unify-match query-pattern
                                        <span style="color: #268bd2;">(</span>conclusion clean-rule<span style="color: #268bd2;">)</span>
                                        query-frame<span style="color: #b58900;">)</span><span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>eq? unify-result 'failed<span style="color: #859900;">)</span> stream-null
            <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">begin</span>
              <span style="color: #b58900;">(</span>add-executed-rule! rule<span style="color: #b58900;">)</span>
              <span style="color: #b58900;">(</span>qeval <span style="color: #268bd2;">(</span>rule-body clean-rule<span style="color: #268bd2;">)</span>
                     <span style="color: #268bd2;">(</span>singleton-stream
                      unify-result<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">The following are just driver extensions to permit for `noloop' to work</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">noloop/query-driver-loop</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> executed-rules '<span style="color: #268bd2;">()</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> apply-a-rule noloop/apply-a-rule<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>query-driver-loop<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">noloop/query/eval</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> executed-rules '<span style="color: #268bd2;">()</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> apply-a-rule noloop/apply-a-rule<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>q <span style="color: #859900;">(</span>query-syntax-process expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>stream-&gt;list
     <span style="color: #6c71c4;">(</span>stream-map
      <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>frame<span style="color: #b58900;">)</span>
        <span style="color: #b58900;">(</span>instantiate q frame <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>v f<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>contract-question-mark v<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
      <span style="color: #859900;">(</span>qeval q <span style="color: #b58900;">(</span>singleton-stream '<span style="color: #268bd2;">()</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-driver-loop 'qeval-noloop noloop/query-driver-loop<span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd36fcc1" class="outline-3">
<h3 id="orgd36fcc1">Exercise 4.68</h3>
<div class="outline-text-3" id="text-orgd36fcc1">
<p class="verse">
Define rules to implement the `reverse' operation of *Note Exercise 2-18,<br>
which returns a list containing the same elements as a given list in<br>
reverse order. (Hint: Use `append-to-form'.) Can your rules answer both<br>
`(reverse (1 2 3) ?x)' and `(reverse ?x (1 2 3))' ?<br>
</p>
</div>
<div id="outline-container-orgf467b48" class="outline-4">
<h4 id="orgf467b48">Answer</h4>
<div class="outline-text-4" id="text-orgf467b48">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">This is one solution that doesn't use append-to-form, but doesn't</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">generate proper lists</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> query/infuse
     '<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>bad-reverse <span style="color: #859900;">()</span> <span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>bad-reverse <span style="color: #859900;">(</span>?car . ?cdr<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>?cdr1 . ?car<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
             <span style="color: #6c71c4;">(</span>bad-reverse ?cdr ?cdr1<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> query/infuse
     '<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>reverse <span style="color: #859900;">()</span> <span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>reverse ?x ?y<span style="color: #6c71c4;">)</span>
             <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">and</span>
              <span style="color: #859900;">(</span>append-to-form <span style="color: #b58900;">(</span>?car<span style="color: #b58900;">)</span> ?rest ?x<span style="color: #859900;">)</span>
              <span style="color: #859900;">(</span>append-to-form ?rev <span style="color: #b58900;">(</span>?car<span style="color: #b58900;">)</span> ?y<span style="color: #859900;">)</span>
              <span style="color: #859900;">(</span>reverse ?rest ?rev<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org27a3b86" class="outline-3">
<h3 id="org27a3b86">Exercise 4.69</h3>
<div class="outline-text-3" id="text-org27a3b86">
<p class="verse">
Beginning with the data base and the rules you formulated in Exercise 4.63,<br>
devise a rule for adding “greats” to a grandson relationship. This should<br>
enable the system to deduce that Irad is the great-grandson of Adam, or<br>
that Jabal and Jubal are the great-great-great-great-great-grandsons of<br>
Adam. (Hint: Represent the fact about Irad, for example, as ((great<br>
grandson) Adam Irad). Write rules that determine if a list ends in the word<br>
grandson. Use this to express a rule that allows one to derive the<br>
relationship ((great . ?rel) ?x ?y), where ?rel is a list ending in<br>
grandson.) Check your rules on queries such as ((great grandson) ?g ?ggs)<br>
and (?relationship Adam Irad).<br>
</p>
</div>
<div id="outline-container-org1423f31" class="outline-4">
<h4 id="org1423f31">Answer</h4>
<div class="outline-text-4" id="text-org1423f31">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#|</span>
<span style="color: #93a1a1;">I cannot find a solution to this</span>
<span style="color: #93a1a1;">|#</span>


</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf716ad0" class="outline-3">
<h3 id="orgf716ad0">Exercise 4.70</h3>
<div class="outline-text-3" id="text-orgf716ad0">
<p class="verse">
What is the purpose of the `let' bindings in the procedures<br>
`add-assertion!' and `add-rule!' ? What would be wrong with the following<br>
implementation of `add-assertion!' ? Hint: Recall the definition of the<br>
infinite stream of ones in section *Note 3.5.2: `(define ones (cons-stream 1 ones))'.<br>
<br>
(define (add-assertion! assertion)<br>
(store-assertion-in-index assertion)<br>
(set! THE-ASSERTIONS<br>
(cons-stream assertion THE-ASSERTIONS))<br>
'ok)<br>
</p>
<p>
<b>*</b> Answer
</p>
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution is non-indexable |#</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org3696d0c" class="outline-3">
<h3 id="org3696d0c">Exercise 4.71</h3>
<div class="outline-text-3" id="text-org3696d0c">
<p class="verse">
Louis Reasoner wonders why the simple-query and disjoin procedures<br>
(4.4.4.2) are implemented using explicit delay operations, rather than<br>
being defined as follows:<br>
<br>
(define (simple-query query-pattern frame-stream)<br>
(stream-flatmap<br>
(lambda (frame)<br>
(stream-append<br>
(find-assertions query-pattern frame)<br>
(apply-rules query-pattern frame)))<br>
frame-stream))<br>
<br>
(define (disjoin disjuncts frame-stream)<br>
(if (empty-disjunction? disjuncts)<br>
the-empty-stream<br>
(interleave<br>
(qeval (first-disjunct disjuncts)<br>
frame-stream)<br>
(disjoin (rest-disjuncts disjuncts)<br>
frame-stream))))<br>
<br>
Can you give examples of queries where these simpler definitions would lead<br>
to undesirable behavior?<br>
</p>
</div>
<div id="outline-container-org5cdb6d1" class="outline-4">
<h4 id="org5cdb6d1">Answer</h4>
<div class="outline-text-4" id="text-org5cdb6d1">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgda24337" class="outline-3">
<h3 id="orgda24337">Exercise 4.72</h3>
<div class="outline-text-3" id="text-orgda24337">
<p class="verse">
Why do disjoin and stream-flatmap interleave the streams rather than simply<br>
append them? Give examples that illustrate why interleaving works better.<br>
(Hint: Why did we use interleave in 3.5.3?)<br>
</p>
</div>
<div id="outline-container-org3aca556" class="outline-4">
<h4 id="org3aca556">Answer</h4>
<div class="outline-text-4" id="text-org3aca556">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">`interleave' provides a way to achieve 'diagonalization', that is to say so</span>
<span style="color: #93a1a1;">that every element in an infinite list can be reached, rather than focusing</span>
<span style="color: #93a1a1;">on either an input stream or a database |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb141b71" class="outline-3">
<h3 id="orgb141b71">Exercise 4.73</h3>
<div class="outline-text-3" id="text-orgb141b71">
<p class="verse">
Why does flatten-stream use delay explicitly? What would be wrong with<br>
defining it as follows:<br>
<br>
(define (flatten-stream stream)<br>
(if (stream-null? stream)<br>
the-empty-stream<br>
(interleave (stream-car stream)<br>
(flatten-stream<br>
(stream-cdr stream)))))<br>
<br>
</p>
</div>
<div id="outline-container-org0f51115" class="outline-4">
<h4 id="org0f51115">Answer</h4>
<div class="outline-text-4" id="text-org0f51115">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">Because it would loop forever - the evaluation strategy of a scheme</span>
<span style="color: #93a1a1;">interpreter dictates that arguments are passed in their 'fully evaluated'</span>
<span style="color: #93a1a1;">form.</span>
<span style="color: #93a1a1;">|#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org38d714f" class="outline-3">
<h3 id="org38d714f"><span class="todo TODO">TODO</span> Exercise 4.74</h3>
<div class="outline-text-3" id="text-org38d714f">
<p class="verse">
Alyssa P. Hacker proposes to use a simpler version of stream-flatmap in<br>
negate, lisp-value, and find-assertions. She observes that the procedure<br>
that is mapped over the frame stream in these cases always produces either<br>
<br>
</p>
</div>
<div id="outline-container-orgcc6ddba" class="outline-4">
<h4 id="orgcc6ddba">Answer</h4>
<div class="outline-text-4" id="text-orgcc6ddba">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc1430f6" class="outline-3">
<h3 id="orgc1430f6"><span class="todo TODO">TODO</span> Exercise 4.75</h3>
<div class="outline-text-3" id="text-orgc1430f6">
<p class="verse">
Implement for the query language a new special form called `unique'.<br>
`Unique' should succeed if there is precisely one item in the data base<br>
satisfying a specified query. For example,<br>
<br>
(unique (job ?x (computer wizard)))<br>
<br>
should print the one-item stream<br>
<br>
(unique (job (Bitdiddle Ben) (computer wizard)))<br>
<br>
since Ben is the only computer wizard, and<br>
<br>
(unique (job ?x (computer programmer)))<br>
<br>
should print the empty stream, since there is more than one<br>
computer programmer.  Moreover,<br>
<br>
(and (job ?x ?j) (unique (job ?anyone ?j)))<br>
<br>
should list all the jobs that are filled by only one person, and<br>
the people who fill them.<br>
<br>
There are two parts to implementing `unique'.  The first is to<br>
write a procedure that handles this special form, and the second<br>
is to make `qeval' dispatch to that procedure.  The second part is<br>
trivial, since `qeval' does its dispatching in a data-directed<br>
way.  If your procedure is called `uniquely-asserted', all you<br>
need to do is<br>
<br>
(put 'unique 'qeval uniquely-asserted)<br>
<br>
and `qeval' will dispatch to this procedure for every query whose<br>
`type' (`car') is the symbol `unique'.<br>
<br>
The real problem is to write the procedure `uniquely-asserted'.<br>
This should take as input the `contents' (`cdr') of the `unique'<br>
query, together with a stream of frames.  For each frame in the<br>
stream, it should use `qeval' to find the stream of all extensions<br>
to the frame that satisfy the given query.  Any stream that does<br>
not have exactly one item in it should be eliminated.  The<br>
remaining streams should be passed back to be accumulated into one<br>
big stream that is the result of the `unique' query.  This is<br>
similar to the implementation of the `not' special form.<br>
<br>
Test your implementation by forming a query that lists all people<br>
who supervise precisely one person.<br>
</p>
</div>
<div id="outline-container-org24a615c" class="outline-4">
<h4 id="org24a615c">Answer</h4>
<div class="outline-text-4" id="text-org24a615c">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org852e7f4" class="outline-3">
<h3 id="org852e7f4"><span class="todo TODO">TODO</span> Exercise 4.76</h3>
<div class="outline-text-3" id="text-org852e7f4">
<p class="verse">
Our implementation of `and' as a series combination of queries<br>
is elegant, but it is inefficient because in processing<br>
the second query of the `and' we must scan the data<br>
base for each frame produced by the first query.  If the data base<br>
has n elements, and a typical query produces a number<br>
of output frames proportional to n (say n/k),<br>
then scanning the data base for each frame produced by the first<br>
query will require n<sup>2</sup>/k calls to the pattern matcher.  Another<br>
approach would be to process the two clauses of the `and'<br>
separately, then look for all pairs of output frames that are<br>
compatible.  If each query produces n/k output frames, then this<br>
means that we must perform n<sup>2</sup>/k<sup>2</sup> compatibility checks&#x2013;a factor<br>
of k fewer than the number of matches required in our current<br>
method.<br>
<br>
Devise an implementation of `and' that uses this strategy.  You<br>
must implement a procedure that takes two frames as inputs, checks<br>
whether the bindings in the frames are compatible, and, if so,<br>
produces a frame that merges the two sets of bindings.  This<br>
operation is similar to unification.<br>
</p>
</div>
<div id="outline-container-orgbfbf6da" class="outline-4">
<h4 id="orgbfbf6da">Answer</h4>
<div class="outline-text-4" id="text-orgbfbf6da">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org09f871e" class="outline-3">
<h3 id="org09f871e"><span class="todo TODO">TODO</span> Exercise 4.77</h3>
<div class="outline-text-3" id="text-org09f871e">
<p class="verse">
In section *Note 4-4-3:: we saw that `not' and<br>
`lisp-value' can cause the query language to give "wrong" answers<br>
if these filtering operations are applied to frames in which<br>
variables are unbound.  Devise a way to fix this shortcoming.  One<br>
idea is to perform the filtering in a "delayed" manner by<br>
appending to the frame a "promise" to filter that is fulfilled<br>
only when enough variables have been bound to make the operation<br>
possible.  We could wait to perform filtering until all other<br>
operations have been performed.  However, for efficiency's sake, we<br>
would like to perform filtering as soon as possible so as to cut<br>
down on the number of intermediate frames generated.<br>
</p>
</div>
<div id="outline-container-org6d8e87a" class="outline-4">
<h4 id="org6d8e87a">Answer</h4>
<div class="outline-text-4" id="text-org6d8e87a">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge2872b9" class="outline-3">
<h3 id="orge2872b9"><span class="todo TODO">TODO</span> Exercise 4.78</h3>
<div class="outline-text-3" id="text-orge2872b9">
<p class="verse">
Redesign the query language as a nondeterministic<br>
program to be implemented using the evaluator of section *Note<br>
4-3::, rather than as a stream process.  In this approach, each<br>
query will produce a single answer (rather than the stream of all<br>
answers) and the user can type `try-again' to see more answers.<br>
You should find that much of the mechanism we built in this<br>
section is subsumed by nondeterministic search and backtracking.<br>
You will probably also find, however, that your new query language<br>
has subtle differences in behavior from the one implemented here.<br>
Can you find examples that illustrate this difference?<br>
</p>
</div>
<div id="outline-container-org9a084a9" class="outline-4">
<h4 id="org9a084a9">Answer</h4>
<div class="outline-text-4" id="text-org9a084a9">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org96f40bc" class="outline-3">
<h3 id="org96f40bc"><span class="todo TODO">TODO</span> Exercise 4.79</h3>
<div class="outline-text-3" id="text-org96f40bc">
<p class="verse">
When we implemented the Lisp evaluator in section *Note 4-1, we<br>
saw how to use local environments to avoid name conflicts between<br>
the parameters of procedures. For example, in evaluating<br>
<br>
(define (square x)<br>
(* x x))<br>
<br>
(define (sum-of-squares x y)<br>
(+ (square x) (square y)))<br>
<br>
(sum-of-squares 3 4)<br>
<br>
there is no confusion between the `x' in `square' and the `x' in<br>
`sum-of-squares', because we evaluate the body of each procedure<br>
in an environment that is specially constructed to contain<br>
bindings for the local variables.  In the query system, we used a<br>
different strategy to avoid name conflicts in applying rules.<br>
Each time we apply a rule we rename the variables with new names<br>
that are guaranteed to be unique.  The analogous strategy for the<br>
Lisp evaluator would be to do away with local environments and<br>
simply rename the variables in the body of a procedure each time<br>
we apply the procedure.<br>
<br>
Implement for the query language a rule-application method that<br>
uses environments rather than renaming.  See if you can build on<br>
your environment structure to create constructs in the query<br>
language for dealing with large systems, such as the rule analog<br>
of block-structured procedures.  Can you relate any of this to the<br>
problem of making deductions in a context (e.g., "If I supposed<br>
that P were true, then I would be able to deduce A and B.") as a<br>
method of problem solving?  (This problem is open-ended.  A good<br>
answer is probably worth a Ph.D.)<br>
</p>
<p>
#+end<sub>verse</sub>
</p>
</div>
</div>
</section>
