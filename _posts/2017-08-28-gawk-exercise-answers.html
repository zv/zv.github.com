---
layout: page
title: GNU Awk's Manual Exercises
category: note
tags:
 - post
 - awk
 - solutions
---
<section id="outline-container-orgacc8051" class="outline-2">
<h2 id="orgacc8051"></h2>
<div class="outline-text-2" id="text-orgacc8051">
<p>
<a href="https://www.gnu.org/software/gawk/manual/gawk.html#Print">The GNU Awk manual</a> contains a handful of exercises to assist in learning
<code>awk</code>.
</p>

<p>
The manual doesn&rsquo;t contain answers to these exercises and having not found
them elsewhere, I&rsquo;ve published my own solutions here.
</p>

<p>
All of the exercises use features <i>exclusively</i> presented prior to the section
where the exercise appears. If you think you&rsquo;ve got a neat solution, <a href="https://github.com/zv/gawk-exercise/issues">please
submit a pull request!</a>
</p>
</div>
</section>

<section id="outline-container-orgbd20b21" class="outline-2">
<h2 id="orgbd20b21">Input</h2>
<div class="outline-text-2" id="text-orgbd20b21">
</div>
<div id="outline-container-orgee4ee53" class="outline-3">
<h3 id="orgee4ee53">#1</h3>
<div class="outline-text-3" id="text-orgee4ee53">
<div class="question" id="org9ce5325">
<p>
Using the <code>FIELDWIDTHS</code> variable (see <a href="https://www.gnu.org/software/gawk/manual/gawk.html#Constant-Size">Constant Size</a>), write a program to read
election data, where each record represents one voter’s votes. Come up with a
way to define which columns are associated with each ballot item, and print the
total votes, including abstentions, for each item.
</p>

</div>
</div>
<div id="outline-container-org4fe5a49" class="outline-4">
<h4 id="org4fe5a49">Answer</h4>
<div class="outline-text-4" id="text-org4fe5a49">
<div class="org-src-container">
<pre class="src src-awk"><span style="color: #859900; font-weight: bold;">BEGIN</span>  <span style="color: #2aa198;">{</span> <span style="color: #268bd2;">FIELDWIDTHS</span> = <span style="color: #2aa198;">"18 9 15"</span> <span style="color: #2aa198;">}</span>

<span style="color: #268bd2;">NR</span> &gt; <span style="color: #6c71c4;">2</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>$2 ~ <span style="color: #2aa198;">"x"</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        gore++
    <span style="color: #b58900;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>$3 ~ <span style="color: #2aa198;">"x"</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        bush++
    <span style="color: #b58900;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #b58900;">{</span>
        abstained++
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">END</span> <span style="color: #2aa198;">{</span> <span style="color: #268bd2;">print</span> <span style="color: #2aa198;">"Bush:"</span>, bush, <span style="color: #2aa198;">"Gore:"</span>, gore, <span style="color: #2aa198;">"Abstained:"</span>, abstained <span style="color: #2aa198;">}</span>
</pre>
</div>

<pre class="example">
Bush: 9 Gore: 10 Abstained: 1
</pre>
</div>
</div>
</div>

<div id="outline-container-org79d264a" class="outline-3">
<h3 id="org79d264a">#2</h3>
<div class="outline-text-3" id="text-org79d264a">
<div class="question" id="org2de3329">
<p>
Plain Getline, presented a program to remove C-style comments (‘/* … */’) from
the input. That program does not work if one comment ends on one line and
another one starts later on the same line. That can be fixed by making one
simple change. What is it?
</p>

</div>
</div>

<div id="outline-container-org7b44523" class="outline-4">
<h4 id="org7b44523">Answer</h4>
<div class="outline-text-4" id="text-org7b44523">
<div class="org-src-container">
<pre class="src src-awk"><span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>i = <span style="color: #268bd2;">index</span><span style="color: #6c71c4;">(</span>$0, <span style="color: #2aa198;">"/*"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> != <span style="color: #6c71c4;">0</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        out = <span style="color: #268bd2;">substr</span><span style="color: #268bd2;">(</span>$0, <span style="color: #6c71c4;">1</span>, i - <span style="color: #6c71c4;">1</span><span style="color: #268bd2;">)</span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">leading part of the string</span>
        rest = <span style="color: #268bd2;">substr</span><span style="color: #268bd2;">(</span>$0, i + <span style="color: #6c71c4;">2</span><span style="color: #268bd2;">)</span>    <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">... */ ...</span>
        j = <span style="color: #268bd2;">index</span><span style="color: #268bd2;">(</span>rest, <span style="color: #2aa198;">"*/"</span><span style="color: #268bd2;">)</span>       <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">is */ in trailing part?</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>j &gt; <span style="color: #6c71c4;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            rest = <span style="color: #268bd2;">substr</span><span style="color: #6c71c4;">(</span>rest, j + <span style="color: #6c71c4;">2</span><span style="color: #6c71c4;">)</span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">remove comment</span>
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #6c71c4;">(</span>j == <span style="color: #6c71c4;">0</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">get more text</span>
                <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">getline</span> &lt;= <span style="color: #6c71c4;">0</span><span style="color: #859900;">)</span> <span style="color: #859900;">{</span>
                    <span style="color: #268bd2;">print</span><span style="color: #b58900;">(</span><span style="color: #2aa198;">"unexpected EOF or error:"</span>, <span style="color: #268bd2;">ERRNO</span><span style="color: #b58900;">)</span> &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
                    <span style="color: #859900; font-weight: bold;">exit</span>
                <span style="color: #859900;">}</span>
                <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">build up the line using string concatenation</span>
                rest = rest $0
                j = <span style="color: #268bd2;">index</span><span style="color: #859900;">(</span>rest, <span style="color: #2aa198;">"*/"</span><span style="color: #859900;">)</span>   <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">is */ in trailing part?</span>
                <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>j != <span style="color: #6c71c4;">0</span><span style="color: #859900;">)</span> <span style="color: #859900;">{</span>
                    rest = <span style="color: #268bd2;">substr</span><span style="color: #b58900;">(</span>rest, j + <span style="color: #6c71c4;">2</span><span style="color: #b58900;">)</span>
                    <span style="color: #859900; font-weight: bold;">break</span>
                <span style="color: #859900;">}</span>
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span>
        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">build up the output line using string concatenation</span>
        $0 = out rest
    <span style="color: #b58900;">}</span>
    <span style="color: #268bd2;">print</span> $0
<span style="color: #2aa198;">}</span>
</pre>
</div>

<pre class="example" id="org895d018">
#include &lt;errno.h&gt;
#include &lt;termios.h&gt;

int __set_errno(int n) { return n; }

int __libc_tcdrain (int fd) {
  if (fd &lt; 0) {
      __set_errno (EBADF);
      return -1;
    }
   __set_errno (ENOSYS);
  return -1;
}
</pre>
</div>
</div>
</div>
</section>

<section id="outline-container-orga264984" class="outline-2">
<h2 id="orga264984">Output</h2>
<div class="outline-text-2" id="text-orga264984">
</div>
<div id="outline-container-orgcfb9820" class="outline-3">
<h3 id="orgcfb9820">#1</h3>
<div class="outline-text-3" id="text-orgcfb9820">
<div class="question" id="org4f5f7df">
<p>
Rewrite the program from Output Separators, by using a new value of OFS.
</p>

</div>

<div class="org-src-container">
<pre class="src src-awk"><span style="color: #859900; font-weight: bold;">BEGIN</span> <span style="color: #2aa198;">{</span> <span style="color: #268bd2;">print</span> <span style="color: #2aa198;">"Month Crates"</span>; <span style="color: #268bd2;">print</span> <span style="color: #2aa198;">"----- ------"</span> <span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span> <span style="color: #268bd2;">print</span> $1, <span style="color: #2aa198;">"     "</span>, $2 <span style="color: #2aa198;">}</span>
</pre>
</div>
<pre class="example">
Month Crates
----- ------
Jan       13
Feb       15
Mar       15
Aug       11
Sep       25
Dec       6
</pre>
</div>


<div id="outline-container-org3d3541c" class="outline-4">
<h4 id="org3d3541c">Answer</h4>
<div class="outline-text-4" id="text-org3d3541c">
<div class="org-src-container">
<pre class="src src-awk"><span style="color: #859900; font-weight: bold;">BEGIN</span> <span style="color: #2aa198;">{</span> <span style="color: #268bd2;">print</span> <span style="color: #2aa198;">"Month Crates"</span>; <span style="color: #268bd2;">print</span> <span style="color: #2aa198;">"----- ------"</span>; <span style="color: #268bd2;">OFS</span>=<span style="color: #2aa198;">"     "</span> <span style="color: #2aa198;">}</span>
<span style="color: #2aa198;">{</span> <span style="color: #268bd2;">print</span> $1, $2 <span style="color: #2aa198;">}</span>
</pre>
</div>
<pre class="example">
Month Crates
----- ------
Jan     13
Feb     15
Mar     15
Aug     11
Sep     25
Dec     6
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-org6d89ce5" class="outline-2">
<h2 id="org6d89ce5">Library</h2>
<div class="outline-text-2" id="text-org6d89ce5">
</div>
<div id="outline-container-orge943924" class="outline-3">
<h3 id="orge943924">#1</h3>
<div class="outline-text-3" id="text-orge943924">
<div class="question" id="orgd72e1df">
<p>
In Empty Files, we presented the <code>zerofile.awk</code> program, which made use of gawk’s
<code>ARGIND</code> variable. Can this problem be solved without relying on <code>ARGIND</code>? If so,
how?
</p>

</div>
</div>

<div id="outline-container-org2c679d4" class="outline-4">
<h4 id="org2c679d4">Answer</h4>
<div class="outline-text-4" id="text-org2c679d4">
<p>
Use <code>ENDFILE</code> to run a function at the end of each file. You could match
<code>argc~/~argv</code> as well if you wanted to determine the index of the filename
argument.
</p>

<div class="org-src-container">
<pre class="src src-awk">ENDFILE <span style="color: #2aa198;">{</span> <span style="color: #268bd2;">print</span><span style="color: #b58900;">(</span><span style="color: #268bd2;">FILENAME</span>, ++argi<span style="color: #b58900;">)</span> <span style="color: #2aa198;">}</span>
</pre>
</div>

<pre class="example">
data/empty 1
data/empty1 2
</pre>
</div>
</div>
</div>
<div id="outline-container-org47b7431" class="outline-3">
<h3 id="org47b7431">#2</h3>
<div class="outline-text-3" id="text-org47b7431">
<div class="question" id="orgde246d1">
<p>
As a related challenge, revise that code to handle the case where an
intervening value in <code>ARGV</code> is a variable assignment.
</p>

</div>

<div class="org-src-container">
<pre class="src src-awk">ENDFILE <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>argv<span style="color: #268bd2;">[</span>argi++<span style="color: #268bd2;">]</span> !~ <span style="color: #2aa198;">/^[a-zA-Z_][a-zA-Z0-9_]*=.*/</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #268bd2;">print</span><span style="color: #268bd2;">(</span><span style="color: #268bd2;">FILENAME</span>, argi<span style="color: #268bd2;">)</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>

<pre class="example">
data/empty 1
data/empty1 2
</pre>
</div>
</div>
</section>
<section id="outline-container-orgf386757" class="outline-2">
<h2 id="orgf386757">Programs</h2>
<div class="outline-text-2" id="text-orgf386757">
</div>
<div id="outline-container-org6c29c82" class="outline-3">
<h3 id="org6c29c82">#1</h3>
<div class="outline-text-3" id="text-org6c29c82">
<div class="question" id="orgba66bca">
<p>
Rewrite cut.awk (see <a href="https://www.gnu.org/software/gawk/manual/gawk.html#Cut-Program">Cut Program</a>) using <code>split()</code> with &ldquo;&rdquo; as the separator.
</p>

</div>
</div>
<div id="outline-container-org548b3ac" class="outline-4">
<h4 id="org548b3ac">Answer</h4>
<div class="outline-text-4" id="text-org548b3ac">
<div class="org-src-container">
<pre class="src src-awk"><span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">cut.awk --- implement cut in awk</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Options:</span>
<span style="color: #93a1a1;">#    </span><span style="color: #93a1a1;">-f list     Cut fields</span>
<span style="color: #93a1a1;">#    </span><span style="color: #93a1a1;">-d c        Field delimiter character</span>
<span style="color: #93a1a1;">#    </span><span style="color: #93a1a1;">-c list     Cut characters</span>
<span style="color: #93a1a1;">#</span>
<span style="color: #93a1a1;">#    </span><span style="color: #93a1a1;">-s          Suppress lines without the delimiter</span>
<span style="color: #93a1a1;">#</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Requires getopt() and join() library functions</span>

<span style="color: #859900; font-weight: bold;">function</span> <span style="color: #268bd2;">usage</span><span style="color: #2aa198;">()</span>
<span style="color: #2aa198;">{</span>
    <span style="color: #268bd2;">print</span><span style="color: #b58900;">(</span><span style="color: #2aa198;">"usage: cut [-f list] [-d c] [-s] [files...]"</span><span style="color: #b58900;">)</span> &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
    <span style="color: #268bd2;">print</span><span style="color: #b58900;">(</span><span style="color: #2aa198;">"usage: cut [-c list] [files...]"</span><span style="color: #b58900;">)</span> &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
    <span style="color: #859900; font-weight: bold;">exit</span> <span style="color: #6c71c4;">1</span>
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">BEGIN</span> <span style="color: #2aa198;">{</span>
    <span style="color: #268bd2;">FS</span> = <span style="color: #2aa198;">"\t"</span>    <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">default</span>
    <span style="color: #268bd2;">OFS</span> = <span style="color: #268bd2;">FS</span>
    <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>c = getopt<span style="color: #6c71c4;">(</span><span style="color: #268bd2;">ARGC</span>, <span style="color: #268bd2;">ARGV</span>, <span style="color: #2aa198;">"sf:c:d:"</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> != -<span style="color: #6c71c4;">1</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>c == <span style="color: #2aa198;">"f"</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            by_fields = <span style="color: #6c71c4;">1</span>
            fieldlist = Optarg
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>c == <span style="color: #2aa198;">"c"</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            by_chars = <span style="color: #6c71c4;">1</span>
            fieldlist = Optarg
            <span style="color: #268bd2;">OFS</span> = <span style="color: #2aa198;">""</span>
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>c == <span style="color: #2aa198;">"d"</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">length</span><span style="color: #859900;">(</span>Optarg<span style="color: #859900;">)</span> &gt; <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                <span style="color: #268bd2;">printf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"cut: using first character of %s"</span> \
                       <span style="color: #2aa198;">" for delimiter\n"</span>, Optarg<span style="color: #859900;">)</span> &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
                Optarg = <span style="color: #268bd2;">substr</span><span style="color: #859900;">(</span>Optarg, <span style="color: #6c71c4;">1</span>, <span style="color: #6c71c4;">1</span><span style="color: #859900;">)</span>
            <span style="color: #6c71c4;">}</span>
            fs = <span style="color: #268bd2;">FS</span> = Optarg
            <span style="color: #268bd2;">OFS</span> = <span style="color: #268bd2;">FS</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">FS</span> == <span style="color: #2aa198;">" "</span><span style="color: #6c71c4;">)</span>    <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">defeat awk semantics</span>
                <span style="color: #268bd2;">FS</span> = <span style="color: #2aa198;">"[ ]"</span>
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>c == <span style="color: #2aa198;">"s"</span><span style="color: #268bd2;">)</span>
            suppress = <span style="color: #6c71c4;">1</span>
        <span style="color: #859900; font-weight: bold;">else</span>
            usage<span style="color: #268bd2;">()</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Clear out options</span>
    <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #b58900;">(</span>i = <span style="color: #6c71c4;">1</span>; i &lt; Optind; i++<span style="color: #b58900;">)</span>
        <span style="color: #268bd2;">ARGV</span><span style="color: #b58900;">[</span>i<span style="color: #b58900;">]</span> = <span style="color: #2aa198;">""</span>

    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>by_fields &amp;&amp; by_chars<span style="color: #b58900;">)</span>
        usage<span style="color: #b58900;">()</span>

    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>by_fields == <span style="color: #6c71c4;">0</span> &amp;&amp; by_chars == <span style="color: #6c71c4;">0</span><span style="color: #b58900;">)</span>
        by_fields = <span style="color: #6c71c4;">1</span>    <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">default</span>

    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>fieldlist == <span style="color: #2aa198;">""</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #268bd2;">print</span> <span style="color: #2aa198;">"cut: needs list for -c or -f"</span> &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
        <span style="color: #859900; font-weight: bold;">exit</span> <span style="color: #6c71c4;">1</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>by_fields<span style="color: #b58900;">)</span>
        set_fieldlist<span style="color: #b58900;">()</span>
    <span style="color: #859900; font-weight: bold;">else</span>
        set_charlist<span style="color: #b58900;">()</span>
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">function</span> <span style="color: #268bd2;">set_fieldlist</span><span style="color: #2aa198;">(</span>n, m, i, j, k, f, g<span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">{</span>
    n = <span style="color: #268bd2;">split</span><span style="color: #b58900;">(</span>fieldlist, f, <span style="color: #2aa198;">","</span><span style="color: #b58900;">)</span>
    j = <span style="color: #6c71c4;">1</span>    <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">index in flist</span>
    <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #b58900;">(</span>i = <span style="color: #6c71c4;">1</span>; i &lt;= n; i++<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">index</span><span style="color: #6c71c4;">(</span>f<span style="color: #859900;">[</span>i<span style="color: #859900;">]</span>, <span style="color: #2aa198;">"-"</span><span style="color: #6c71c4;">)</span> != <span style="color: #6c71c4;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">a range</span>
            m = <span style="color: #268bd2;">split</span><span style="color: #6c71c4;">(</span>f<span style="color: #859900;">[</span>i<span style="color: #859900;">]</span>, g, <span style="color: #2aa198;">"-"</span><span style="color: #6c71c4;">)</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>m != <span style="color: #6c71c4;">2</span> || g<span style="color: #859900;">[</span><span style="color: #6c71c4;">1</span><span style="color: #859900;">]</span> &gt;= g<span style="color: #859900;">[</span><span style="color: #6c71c4;">2</span><span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                <span style="color: #268bd2;">printf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"cut: bad field list: %s\n"</span>,
                       f<span style="color: #b58900;">[</span>i<span style="color: #b58900;">]</span><span style="color: #859900;">)</span> &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
                <span style="color: #859900; font-weight: bold;">exit</span> <span style="color: #6c71c4;">1</span>
            <span style="color: #6c71c4;">}</span>
            <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #6c71c4;">(</span>k = g<span style="color: #859900;">[</span><span style="color: #6c71c4;">1</span><span style="color: #859900;">]</span>; k &lt;= g<span style="color: #859900;">[</span><span style="color: #6c71c4;">2</span><span style="color: #859900;">]</span>; k++<span style="color: #6c71c4;">)</span>
                flist<span style="color: #6c71c4;">[</span>j++<span style="color: #6c71c4;">]</span> = k
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span>
            flist<span style="color: #268bd2;">[</span>j++<span style="color: #268bd2;">]</span> = f<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>
    <span style="color: #b58900;">}</span>
    nfields = j - <span style="color: #6c71c4;">1</span>
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">function</span> <span style="color: #268bd2;">set_charlist</span><span style="color: #2aa198;">(</span>    field, i, j, f, g, n, m, t,
                          filler, last, len<span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">{</span>
    field = <span style="color: #6c71c4;">1</span>   <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">count total fields</span>
    n = <span style="color: #268bd2;">split</span><span style="color: #b58900;">(</span>fieldlist, f, <span style="color: #2aa198;">","</span><span style="color: #b58900;">)</span>
    j = <span style="color: #6c71c4;">1</span>       <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">index in flist</span>
    <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #b58900;">(</span>i = <span style="color: #6c71c4;">1</span>; i &lt;= n; i++<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">index</span><span style="color: #6c71c4;">(</span>f<span style="color: #859900;">[</span>i<span style="color: #859900;">]</span>, <span style="color: #2aa198;">"-"</span><span style="color: #6c71c4;">)</span> != <span style="color: #6c71c4;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">range</span>
            m = <span style="color: #268bd2;">split</span><span style="color: #6c71c4;">(</span>f<span style="color: #859900;">[</span>i<span style="color: #859900;">]</span>, g, <span style="color: #2aa198;">"-"</span><span style="color: #6c71c4;">)</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>m != <span style="color: #6c71c4;">2</span> || g<span style="color: #859900;">[</span><span style="color: #6c71c4;">1</span><span style="color: #859900;">]</span> &gt;= g<span style="color: #859900;">[</span><span style="color: #6c71c4;">2</span><span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span>
                <span style="color: #268bd2;">printf</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"cut: bad character list: %s\n"</span>,
                       f<span style="color: #b58900;">[</span>i<span style="color: #b58900;">]</span><span style="color: #859900;">)</span> &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
                <span style="color: #859900; font-weight: bold;">exit</span> <span style="color: #6c71c4;">1</span>
            <span style="color: #6c71c4;">}</span>
            len = g<span style="color: #6c71c4;">[</span><span style="color: #6c71c4;">2</span><span style="color: #6c71c4;">]</span> - g<span style="color: #6c71c4;">[</span><span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">]</span> + <span style="color: #6c71c4;">1</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>g<span style="color: #859900;">[</span><span style="color: #6c71c4;">1</span><span style="color: #859900;">]</span> &gt; <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">compute length of filler</span>
                filler = g<span style="color: #6c71c4;">[</span><span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">]</span> - last - <span style="color: #6c71c4;">1</span>
            <span style="color: #859900; font-weight: bold;">else</span>
                filler = <span style="color: #6c71c4;">0</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>filler<span style="color: #6c71c4;">)</span>
                t<span style="color: #6c71c4;">[</span>field++<span style="color: #6c71c4;">]</span> = filler
            t<span style="color: #6c71c4;">[</span>field++<span style="color: #6c71c4;">]</span> = len  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">length of field</span>
            last = g<span style="color: #6c71c4;">[</span><span style="color: #6c71c4;">2</span><span style="color: #6c71c4;">]</span>
            flist<span style="color: #6c71c4;">[</span>j++<span style="color: #6c71c4;">]</span> = field - <span style="color: #6c71c4;">1</span>
        <span style="color: #268bd2;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>f<span style="color: #859900;">[</span>i<span style="color: #859900;">]</span> &gt; <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span>
                filler = f<span style="color: #6c71c4;">[</span>i<span style="color: #6c71c4;">]</span> - last - <span style="color: #6c71c4;">1</span>
            <span style="color: #859900; font-weight: bold;">else</span>
                filler = <span style="color: #6c71c4;">0</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>filler<span style="color: #6c71c4;">)</span>
                t<span style="color: #6c71c4;">[</span>field++<span style="color: #6c71c4;">]</span> = filler
            t<span style="color: #6c71c4;">[</span>field++<span style="color: #6c71c4;">]</span> = <span style="color: #6c71c4;">1</span>
            last = f<span style="color: #6c71c4;">[</span>i<span style="color: #6c71c4;">]</span>
            flist<span style="color: #6c71c4;">[</span>j++<span style="color: #6c71c4;">]</span> = field - <span style="color: #6c71c4;">1</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
    <span style="color: #268bd2;">FIELDWIDTHS</span> = join<span style="color: #b58900;">(</span>t, <span style="color: #6c71c4;">1</span>, field - <span style="color: #6c71c4;">1</span><span style="color: #b58900;">)</span>
    nfields = j - <span style="color: #6c71c4;">1</span>
<span style="color: #2aa198;">}</span>

<span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>by_fields &amp;&amp; suppress &amp;&amp; <span style="color: #268bd2;">index</span><span style="color: #268bd2;">(</span>$0, fs<span style="color: #268bd2;">)</span> == <span style="color: #6c71c4;">0</span><span style="color: #b58900;">)</span>
        <span style="color: #859900; font-weight: bold;">next</span>

    <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #b58900;">(</span>i = <span style="color: #6c71c4;">1</span>; i &lt;= nfields; i++<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>$flist<span style="color: #6c71c4;">[</span>i<span style="color: #6c71c4;">]</span> != <span style="color: #2aa198;">""</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #268bd2;">printf</span> <span style="color: #2aa198;">"%s"</span>, $flist<span style="color: #6c71c4;">[</span>i<span style="color: #6c71c4;">]</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>i &lt; nfields &amp;&amp; $flist<span style="color: #859900;">[</span>i+<span style="color: #6c71c4;">1</span><span style="color: #859900;">]</span> != <span style="color: #2aa198;">""</span><span style="color: #6c71c4;">)</span>
                <span style="color: #268bd2;">printf</span> <span style="color: #2aa198;">"%s"</span>, <span style="color: #268bd2;">OFS</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>
    <span style="color: #268bd2;">print</span> <span style="color: #2aa198;">""</span>
<span style="color: #2aa198;">}</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org818fa7f" class="outline-3">
<h3 id="org818fa7f">#2</h3>
<div class="outline-text-3" id="text-org818fa7f">
<div class="question" id="orgabfe170">
<p>
In <a href="https://www.gnu.org/software/gawk/manual/gawk.html#Egrep-Program">Egrep Program</a>, we mentioned that <code>‘egrep -i’</code> could be simulated in
versions of <code>awk</code> without <code>IGNORECASE</code> by using <code>tolower()</code> on the line and the
pattern. In a footnote there, we also mentioned that this solution has a
bug: the translated line is output, and not the original one. Fix this
problem.
</p>

</div>
</div>
<div id="outline-container-org34496bd" class="outline-4">
<h4 id="org34496bd">Answer</h4>
<div class="outline-text-4" id="text-org34496bd">
<p>
Simply check the results of <code>tolower()</code> without assigning output.
</p>
</div>
</div>
</div>

<div id="outline-container-org328e3e3" class="outline-3">
<h3 id="org328e3e3">#3</h3>
<div class="outline-text-3" id="text-org328e3e3">
<div class="question" id="org46a0fa8">
<p>
The POSIX version of <code>id</code> takes options that control which information is
printed. Modify the <code>awk</code> version (see <a href="https://www.gnu.org/software/gawk/manual/gawk.html#Id-Program">Id Program</a>) to accept the same
arguments and perform in the same way.
</p>

</div>
</div>

<div id="outline-container-org63e71e2" class="outline-4">
<h4 id="org63e71e2">Answer</h4>
<div class="outline-text-4" id="text-org63e71e2">
<div class="org-src-container">
<pre class="src src-awk"><span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">id.awk --- implement id in awk</span>
<span style="color: #93a1a1;">#</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Requires user and group library functions</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">output is:</span>
<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">uid=12(foo) euid=34(bar) gid=3(baz) \</span>
<span style="color: #93a1a1;">#             </span><span style="color: #93a1a1;">egid=5(blat) groups=9(nine),2(two),1(one)</span>
@include <span style="color: #2aa198;">"vendor/group.awk"</span>
@include <span style="color: #2aa198;">"vendor/passwd.awk"</span>
@include <span style="color: #2aa198;">"vendor/getopt.awk"</span>

<span style="color: #859900; font-weight: bold;">BEGIN</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">ARGC</span> &lt; <span style="color: #6c71c4;">2</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        print_uid++
        print_egid++
        print_groups++
    <span style="color: #b58900;">}</span> <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>c = getopt<span style="color: #859900;">(</span><span style="color: #268bd2;">ARGC</span>, <span style="color: #268bd2;">ARGV</span>, <span style="color: #2aa198;">"gGnru"</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span> != -<span style="color: #6c71c4;">1</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>c == <span style="color: #2aa198;">"g"</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span> print_gid++ <span style="color: #6c71c4;">}</span>
            <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>c == <span style="color: #2aa198;">"G"</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span> print_groups++ <span style="color: #6c71c4;">}</span>
            <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>c == <span style="color: #2aa198;">"u"</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span> print_uid++ <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    uid = <span style="color: #268bd2;">PROCINFO</span><span style="color: #b58900;">[</span><span style="color: #2aa198;">"uid"</span><span style="color: #b58900;">]</span>
    euid = <span style="color: #268bd2;">PROCINFO</span><span style="color: #b58900;">[</span><span style="color: #2aa198;">"euid"</span><span style="color: #b58900;">]</span>
    gid = <span style="color: #268bd2;">PROCINFO</span><span style="color: #b58900;">[</span><span style="color: #2aa198;">"gid"</span><span style="color: #b58900;">]</span>
    egid = <span style="color: #268bd2;">PROCINFO</span><span style="color: #b58900;">[</span><span style="color: #2aa198;">"egid"</span><span style="color: #b58900;">]</span>

    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>print_uid<span style="color: #b58900;">)</span>
        <span style="color: #268bd2;">printf</span><span style="color: #b58900;">(</span><span style="color: #2aa198;">"uid=%d"</span>, uid<span style="color: #b58900;">)</span>
    pw = getpwuid<span style="color: #b58900;">(</span>uid<span style="color: #b58900;">)</span>
    pr_first_field<span style="color: #b58900;">(</span>pw<span style="color: #b58900;">)</span>

    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>print_uid &amp;&amp; euid != uid<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #268bd2;">printf</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">" euid=%d"</span>, euid<span style="color: #268bd2;">)</span>
        pw = getpwuid<span style="color: #268bd2;">(</span>euid<span style="color: #268bd2;">)</span>
        pr_first_field<span style="color: #268bd2;">(</span>pw<span style="color: #268bd2;">)</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>print_gid<span style="color: #b58900;">)</span>
        <span style="color: #268bd2;">printf</span><span style="color: #b58900;">(</span><span style="color: #2aa198;">" gid=%d"</span>, gid<span style="color: #b58900;">)</span>
    pw = getgrgid<span style="color: #b58900;">(</span>gid<span style="color: #b58900;">)</span>
    pr_first_field<span style="color: #b58900;">(</span>pw<span style="color: #b58900;">)</span>

    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>print_gid &amp;&amp; egid != gid<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #268bd2;">printf</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">" egid=%d"</span>, egid<span style="color: #268bd2;">)</span>
        pw = getgrgid<span style="color: #268bd2;">(</span>egid<span style="color: #268bd2;">)</span>
        pr_first_field<span style="color: #268bd2;">(</span>pw<span style="color: #268bd2;">)</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>print_groups<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span>i = <span style="color: #6c71c4;">1</span>; <span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"group"</span> i<span style="color: #6c71c4;">)</span> <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #268bd2;">PROCINFO</span>; i++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>i == <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span>
                <span style="color: #268bd2;">printf</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">" groups="</span><span style="color: #6c71c4;">)</span>
            group = <span style="color: #268bd2;">PROCINFO</span><span style="color: #6c71c4;">[</span><span style="color: #2aa198;">"group"</span> i<span style="color: #6c71c4;">]</span>
            <span style="color: #268bd2;">printf</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">"%d"</span>, group<span style="color: #6c71c4;">)</span>
            pw = getgrgid<span style="color: #6c71c4;">(</span>group<span style="color: #6c71c4;">)</span>
            pr_first_field<span style="color: #6c71c4;">(</span>pw<span style="color: #6c71c4;">)</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span><span style="color: #2aa198;">"group"</span> <span style="color: #b58900;">(</span>i+<span style="color: #6c71c4;">1</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span> <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #268bd2;">PROCINFO</span><span style="color: #6c71c4;">)</span>
                <span style="color: #268bd2;">printf</span><span style="color: #6c71c4;">(</span><span style="color: #2aa198;">","</span><span style="color: #6c71c4;">)</span>
        <span style="color: #268bd2;">}</span>
    <span style="color: #b58900;">}</span>

    <span style="color: #268bd2;">print</span> <span style="color: #2aa198;">""</span>
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">function</span> <span style="color: #268bd2;">pr_first_field</span><span style="color: #2aa198;">(</span>str,  a<span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>str != <span style="color: #2aa198;">""</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #268bd2;">split</span><span style="color: #268bd2;">(</span>str, a, <span style="color: #2aa198;">":"</span><span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">printf</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">"(%s)"</span>, a<span style="color: #6c71c4;">[</span><span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>

<pre class="example">
uid=1000(zv)(zv) groups=10(wheel),968(docker),977(wireshark),1000(zv)
</pre>
</div>
</div>
</div>



<div id="outline-container-org577d83f" class="outline-3">
<h3 id="org577d83f">#6</h3>
<div class="outline-text-3" id="text-org577d83f">
<div class="question" id="orga24a835">
<p>
Why can’t the <code>wc.awk</code> program (see <a href="https://www.gnu.org/software/gawk/manual/gawk.html#Wc-Program">Wc Program</a>) just use the value of <code>FNR</code> in
<code>endfile()</code>? Hint: Examine the code in <a href="https://www.gnu.org/software/gawk/manual/gawk.html#Filetrans-Function">Filetrans Function</a>.
</p>

</div>
</div>
<div id="outline-container-orge27bad8" class="outline-4">
<h4 id="orge27bad8">Answer</h4>
<div class="outline-text-4" id="text-orge27bad8">
<p>
This is a confusing question because <code>ENDFILE</code> <b>can</b> use <code>FNR</code>, but this
question concerns an arbitrary user-defined function coincidentally named
<code>endfile()</code> which cannot. <code>endfile()</code> is run within the body of
<code>END</code>, which as the manual indicates, only occurs as the termination of
the entire program.
</p>
</div>
</div>
</div>

<div id="outline-container-orgb823b2e" class="outline-3">
<h3 id="orgb823b2e">#7</h3>
<div class="outline-text-3" id="text-orgb823b2e">
<div class="question" id="org08cd2fe">
<p>
Manipulation of individual characters in the <code>translate</code> program (see <a href="https://www.gnu.org/software/gawk/manual/gawk.html#Translate-Program">Translate Program</a>) 
is painful using standard awk functions. Given that <code>gawk</code> can split strings
into individual characters using &ldquo;&rdquo; as the separator, how might you use this
feature to simplify the program?
</p>

</div>
</div>

<div id="outline-container-orgc6d110d" class="outline-4">
<h4 id="orgc6d110d">Answer</h4>
<div class="outline-text-4" id="text-orgc6d110d">
<div class="org-src-container">
<pre class="src src-awk"><span style="color: #859900; font-weight: bold;">function</span> <span style="color: #268bd2;">stranslate</span><span style="color: #2aa198;">(</span>from, to, target, lf, lt, ltarget, t_ar, i, c, result<span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">{</span>
    <span style="color: #268bd2;">split</span><span style="color: #b58900;">(</span>from, f_a, <span style="color: #2aa198;">""</span><span style="color: #b58900;">)</span>;
    <span style="color: #268bd2;">split</span><span style="color: #b58900;">(</span>to, t_a, <span style="color: #2aa198;">""</span><span style="color: #b58900;">)</span>;
    <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #b58900;">(</span>i <span style="color: #859900; font-weight: bold;">in</span> f_a<span style="color: #b58900;">)</span> t_ar<span style="color: #b58900;">[</span>f_a<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span><span style="color: #b58900;">]</span> = t_a<span style="color: #b58900;">[</span>i<span style="color: #b58900;">]</span>;
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>lt &lt; lf<span style="color: #b58900;">)</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #b58900;">(</span>; i &lt;= lf; i++<span style="color: #b58900;">)</span> t_ar<span style="color: #b58900;">[</span>f_a<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span><span style="color: #b58900;">]</span> = t_a<span style="color: #b58900;">[</span><span style="color: #268bd2;">length</span><span style="color: #268bd2;">(</span>t_a<span style="color: #268bd2;">)</span><span style="color: #b58900;">]</span>

    <span style="color: #268bd2;">split</span><span style="color: #b58900;">(</span>target, target_chs, <span style="color: #2aa198;">""</span><span style="color: #b58900;">)</span>
    <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #b58900;">(</span>idx <span style="color: #859900; font-weight: bold;">in</span> target_chs<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        c = target<span style="color: #268bd2;">[</span>chs<span style="color: #268bd2;">]</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>c <span style="color: #859900; font-weight: bold;">in</span> t_ar<span style="color: #268bd2;">)</span> target_chs<span style="color: #268bd2;">[</span>c<span style="color: #268bd2;">]</span> = t_ar<span style="color: #268bd2;">[</span>c<span style="color: #268bd2;">]</span>
        result = result c
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">return</span> result
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">function</span> <span style="color: #268bd2;">translate</span><span style="color: #2aa198;">(</span>from, to<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span> <span style="color: #859900; font-weight: bold;">return</span> $0 = stranslate<span style="color: #b58900;">(</span>from, to, $0<span style="color: #b58900;">)</span> <span style="color: #2aa198;">}</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">main program</span>
<span style="color: #859900; font-weight: bold;">BEGIN</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">ARGC</span> &lt; <span style="color: #6c71c4;">3</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #268bd2;">print</span> <span style="color: #2aa198;">"usage: translate from to"</span> &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
        <span style="color: #859900; font-weight: bold;">exit</span>
    <span style="color: #b58900;">}</span>
    FROM = <span style="color: #268bd2;">ARGV</span><span style="color: #b58900;">[</span><span style="color: #6c71c4;">1</span><span style="color: #b58900;">]</span>
    TO = <span style="color: #268bd2;">ARGV</span><span style="color: #b58900;">[</span><span style="color: #6c71c4;">2</span><span style="color: #b58900;">]</span>
    <span style="color: #268bd2;">ARGC</span> = <span style="color: #6c71c4;">2</span>
    <span style="color: #268bd2;">ARGV</span><span style="color: #b58900;">[</span><span style="color: #6c71c4;">1</span><span style="color: #b58900;">]</span> = <span style="color: #2aa198;">"-"</span>
<span style="color: #2aa198;">}</span>

<span style="color: #2aa198;">{</span>
    translate<span style="color: #b58900;">(</span>FROM, TO<span style="color: #b58900;">)</span>
    <span style="color: #268bd2;">print</span>
<span style="color: #2aa198;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org16aef37" class="outline-3">
<h3 id="org16aef37">#8</h3>
<div class="outline-text-3" id="text-org16aef37">
<div class="question" id="org1814831">
<p>
The <code>extract.awk</code> program (see <a href="https://www.gnu.org/software/gawk/manual/gawk.html#Extract-Program">Extract Program</a>) was written before <code>gawk</code> had
the <code>gensub()</code> function. Use it to simplify the code.
</p>

</div>
</div>
<div id="outline-container-org42ef6d8" class="outline-4">
<h4 id="org42ef6d8">Answer</h4>
<div class="outline-text-4" id="text-org42ef6d8">
<div class="org-src-container">
<pre class="src src-awk"><span style="color: #859900; font-weight: bold;">BEGIN</span>    <span style="color: #2aa198;">{</span> <span style="color: #268bd2;">IGNORECASE</span> = <span style="color: #6c71c4;">1</span> <span style="color: #2aa198;">}</span>

<span style="color: #2aa198;">/^@c(omment)?[ \t]+system/</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">NF</span> &lt; <span style="color: #6c71c4;">3</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        e = <span style="color: #268bd2;">(</span><span style="color: #2aa198;">"extract: "</span> <span style="color: #268bd2;">FILENAME</span> <span style="color: #2aa198;">":"</span> <span style="color: #268bd2;">FNR</span><span style="color: #268bd2;">)</span>
        e = <span style="color: #268bd2;">(</span>e  <span style="color: #2aa198;">": badly formed `system' line"</span><span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">print</span> e &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
        <span style="color: #859900; font-weight: bold;">next</span>
    <span style="color: #b58900;">}</span>
    $1 = <span style="color: #2aa198;">""</span>
    $2 = <span style="color: #2aa198;">""</span>
    stat = <span style="color: #268bd2;">system</span><span style="color: #b58900;">(</span>$0<span style="color: #b58900;">)</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>stat != <span style="color: #6c71c4;">0</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        e = <span style="color: #268bd2;">(</span><span style="color: #2aa198;">"extract: "</span> <span style="color: #268bd2;">FILENAME</span> <span style="color: #2aa198;">":"</span> <span style="color: #268bd2;">FNR</span><span style="color: #268bd2;">)</span>
        e = <span style="color: #268bd2;">(</span>e <span style="color: #2aa198;">": warning: system returned "</span> stat<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">print</span> e &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #2aa198;">/^@c(omment)?[ \t]+file/</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">NF</span> != <span style="color: #6c71c4;">3</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        e = <span style="color: #268bd2;">(</span><span style="color: #2aa198;">"extract: "</span> <span style="color: #268bd2;">FILENAME</span> <span style="color: #2aa198;">":"</span> <span style="color: #268bd2;">FNR</span> <span style="color: #2aa198;">": badly formed `file' line"</span><span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">print</span> e &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
        <span style="color: #859900; font-weight: bold;">next</span>
    <span style="color: #b58900;">}</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>$3 != curfile<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>curfile != <span style="color: #2aa198;">""</span><span style="color: #268bd2;">)</span>
            <span style="color: #268bd2;">close</span><span style="color: #268bd2;">(</span>curfile<span style="color: #268bd2;">)</span>
        curfile = $3
    <span style="color: #b58900;">}</span>

    <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #b58900;">(</span>;;<span style="color: #b58900;">)</span> <span style="color: #b58900;">{</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">getline</span> line<span style="color: #6c71c4;">)</span> &lt;= <span style="color: #6c71c4;">0</span><span style="color: #268bd2;">)</span>
            unexpected_eof<span style="color: #268bd2;">()</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>line ~ <span style="color: #2aa198;">/^@c(omment)?[ \t]+endfile/</span><span style="color: #268bd2;">)</span>
            <span style="color: #859900; font-weight: bold;">break</span>
        <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>line ~ <span style="color: #2aa198;">/^@(end[ \t]+)?group/</span><span style="color: #268bd2;">)</span>
            <span style="color: #859900; font-weight: bold;">continue</span>
        <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>line ~ <span style="color: #2aa198;">/^@c(omment+)?[ \t]+/</span><span style="color: #268bd2;">)</span>
            <span style="color: #859900; font-weight: bold;">continue</span>
        <span style="color: #268bd2;">gensub</span><span style="color: #268bd2;">(</span><span style="color: #2aa198;">/@[^@]o/</span>, <span style="color: #2aa198;">"\\1"</span>, <span style="color: #2aa198;">"g"</span>, line<span style="color: #268bd2;">)</span>
        <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">index</span><span style="color: #6c71c4;">(</span>line, <span style="color: #2aa198;">"@"</span><span style="color: #6c71c4;">)</span> == <span style="color: #6c71c4;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #268bd2;">print</span> line &gt; curfile
            <span style="color: #859900; font-weight: bold;">continue</span>
        <span style="color: #268bd2;">}</span>
        n = <span style="color: #268bd2;">split</span><span style="color: #268bd2;">(</span>line, a, <span style="color: #2aa198;">"@"</span><span style="color: #268bd2;">)</span>
        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">if a[1] == "", means leading @,</span>
        <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">don't add one back in.</span>
        <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span>i = <span style="color: #6c71c4;">2</span>; i &lt;= n; i++<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
            <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>a<span style="color: #859900;">[</span>i<span style="color: #859900;">]</span> == <span style="color: #2aa198;">""</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">{</span> <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">was an @@</span>
                a<span style="color: #859900;">[</span>i<span style="color: #859900;">]</span> = <span style="color: #2aa198;">"@"</span>
                <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>a<span style="color: #b58900;">[</span>i+<span style="color: #6c71c4;">1</span><span style="color: #b58900;">]</span> == <span style="color: #2aa198;">""</span><span style="color: #859900;">)</span>
                    i++
            <span style="color: #6c71c4;">}</span>
        <span style="color: #268bd2;">}</span>
        <span style="color: #268bd2;">print</span> join<span style="color: #268bd2;">(</span>a, <span style="color: #6c71c4;">1</span>, n, <span style="color: #268bd2;">SUBSEP</span><span style="color: #268bd2;">)</span> &gt; curfile
    <span style="color: #b58900;">}</span>
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">function</span> <span style="color: #268bd2;">join</span><span style="color: #2aa198;">(</span>array, start, end, sep, result, i<span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>sep == <span style="color: #2aa198;">""</span><span style="color: #b58900;">)</span>
        sep = <span style="color: #2aa198;">" "</span>
    <span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>sep == <span style="color: #268bd2;">SUBSEP</span><span style="color: #b58900;">)</span> <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">magic value</span>
        sep = <span style="color: #2aa198;">""</span>
    result = array<span style="color: #b58900;">[</span>start<span style="color: #b58900;">]</span>
    <span style="color: #859900; font-weight: bold;">for</span> <span style="color: #b58900;">(</span>i = start + <span style="color: #6c71c4;">1</span>; i &lt;= end; i++<span style="color: #b58900;">)</span>
        result = result sep array<span style="color: #b58900;">[</span>i<span style="color: #b58900;">]</span>
    <span style="color: #859900; font-weight: bold;">return</span> result
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">function</span> <span style="color: #268bd2;">unexpected_eof</span><span style="color: #2aa198;">()</span>
<span style="color: #2aa198;">{</span>
    <span style="color: #268bd2;">printf</span><span style="color: #b58900;">(</span><span style="color: #2aa198;">"extract: %s:%d: unexpected EOF or error\n"</span>,
           <span style="color: #268bd2;">FILENAME</span>, <span style="color: #268bd2;">FNR</span><span style="color: #b58900;">)</span> &gt; <span style="color: #268bd2;">"/dev/stderr"</span>
    <span style="color: #859900; font-weight: bold;">exit</span> <span style="color: #6c71c4;">1</span>
<span style="color: #2aa198;">}</span>

<span style="color: #859900; font-weight: bold;">END</span> <span style="color: #2aa198;">{</span>
    <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>curfile<span style="color: #b58900;">)</span> <span style="color: #268bd2;">close</span><span style="color: #b58900;">(</span>curfile<span style="color: #b58900;">)</span>
    <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">to accommodate literate programming, print out our file</span>
    <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">getline</span> tmp &lt; curfile<span style="color: #b58900;">)</span> <span style="color: #268bd2;">print</span> tmp
<span style="color: #2aa198;">}</span>
</pre>
</div>

<pre class="example">
BEGIN { print "Don't panic!" }
END { print "Always avoid bored archaeologists!" }
</pre>
</div>
</div>
</div>
</section>
