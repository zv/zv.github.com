---
layout: page
title: SICP Chapter 4 Exercises & Solutions
category: note
tags:
- sicp
- lisp
- exercises
- solutions
---

<section id="outline-container-org3136fa6" class="outline-2">
<h2 id="org3136fa6"></h2>
<div class="outline-text-2" id="text-org3136fa6">
<p>
The HTML for this page has been automatically generated by parsing the loosely
formatted source code &amp; comments included in my solutions repository
(<a href="https://github.com/zv/SICP-guile">https://github.com/zv/SICP-guile</a>), if you encounter any unformatted
solutions, you think you've spotted an error or you have something you'd like
to share about the exercises, don't hesitate to leave a comment below
(or a pull request on the source repo).
</p>
</div>
</section>

<section id="outline-container-org1ada91e" class="outline-2">
<h2 id="org1ada91e">Exercises Chapter 4</h2>
<div class="outline-text-2" id="text-org1ada91e">
</div>
<div id="outline-container-org51660d5" class="outline-3">
<h3 id="org51660d5">Exercise 4.1</h3>
<div class="outline-text-3" id="text-org51660d5">
<blockquote>
<p>
Notice that we cannot tell whether the metacircular evaluator evaluates operands
from left to right or from right to left. Its evaluation order is inherited from
the underlying Lisp: If the arguments to cons in list-of-values are evaluated
from left to right, then list-of-values will evaluate operands from left to
right; and if the arguments to cons are evaluated from right to left, then
list-of-values will evaluate operands from right to left.
</p>

<p>
Write a version of list-of-values that evaluates operands from left to right
regardless of the order of evaluation in the underlying Lisp. Also write a
version of list-of-values that evaluates operands from right to left.
</p>
</blockquote>
</div>

<div id="outline-container-orgaaec07b" class="outline-4">
<h4 id="orgaaec07b">Answer</h4>
<div class="outline-text-4" id="text-orgaaec07b">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">rtl-list-of-values</span> exps env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>no-operands? exps<span style="color: #268bd2;">)</span> '<span style="color: #268bd2;">()</span>
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span>left <span style="color: #b58900;">(</span>zeval <span style="color: #268bd2;">(</span>first-operand exps<span style="color: #268bd2;">)</span> env<span style="color: #b58900;">)</span> <span style="color: #859900;">)</span>
             <span style="color: #859900;">(</span>right <span style="color: #b58900;">(</span>rtl-list-of-values <span style="color: #268bd2;">(</span>rest-operands exps<span style="color: #268bd2;">)</span> env<span style="color: #b58900;">)</span> <span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>cons left right<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7d66d76" class="outline-3">
<h3 id="org7d66d76">Exercise 4.2</h3>
<div class="outline-text-3" id="text-org7d66d76">
<blockquote>
<p>
Louis Reasoner plans to reorder the cond clauses in eval so that the clause for
procedure applications appears before the clause for assignments. He argues that
this will make the interpreter more efficient: Since programs usually contain
more applications than assignments, definitions, and so on, his modified eval
will usually check fewer clauses than the original eval before identifying the
type of an expression.
</p>

<ol class="org-ol">
<li>What is wrong with Louis’s plan? (Hint: What will Louis’s evaluator do with the expression (define x 3)?)</li>

<li>Louis is upset that his plan didn’t work. He is willing to go to any lengths to make his evaluator recognize procedure applications before it checks for most other kinds of expressions. Help him by changing the syntax of the evaluated language so that procedure applications start with call. For example, instead of (factorial 3) we will now have to write (call factorial 3) and instead of (+ 1 2) we will have to write (call + 1 2).</li>
</ol>
</blockquote>
</div>

<div id="outline-container-orgf1b1618" class="outline-4">
<h4 id="orgf1b1618">Answer</h4>
<div class="outline-text-4" id="text-orgf1b1618">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Answer:</span>
<span style="color: #93a1a1;">1: The order of operations will cause some variables to be undefined. As the</span>
<span style="color: #93a1a1;">example suggests, define will be called with 'x' and '3' as arguments. `define'</span>
<span style="color: #93a1a1;">cannot be made into a procedure because the arguments will be evaluated.</span>

<span style="color: #93a1a1;">2. Only `application' need be changed:</span>

<span style="color: #93a1a1;">(define application? (exp)</span>
<span style="color: #93a1a1;">(tagged-list? exp 'call))</span>
<span style="color: #93a1a1;">(define operator (exp) (cadr exp))</span>
<span style="color: #93a1a1;">(define operands (exp) (cddr exp)) |#</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org65fb6dc" class="outline-3">
<h3 id="org65fb6dc">Exercise 4.3</h3>
<div class="outline-text-3" id="text-org65fb6dc">
<blockquote>
<p>
Rewrite eval so that the dispatch is done in data-directed style. Compare this
with the data-directed differentiation procedure of Exercise 2.73.
(You may use the car of a compound expression as the type of the expression, as
is appropriate for the syntax implemented in this section.) 
</p>
</blockquote>
</div>

<div id="outline-container-org1fd6c69" class="outline-4">
<h4 id="org1fd6c69">Answer</h4>
<div class="outline-text-4" id="text-org1fd6c69">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define-class</span> <span style="color: #b58900;">&lt;dispatch-table&gt;</span> <span style="color: #b58900;">()</span>
  <span style="color: #b58900;">(</span>method-table <span style="color: #657b83; font-weight: bold;">#:init-value</span> <span style="color: #268bd2;">(</span>make-hash-table<span style="color: #268bd2;">)</span>
                <span style="color: #657b83; font-weight: bold;">#:getter</span> method-table<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">table-ordinal</span> op type<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>opstr   <span style="color: #859900;">(</span>symbol-&gt;string op<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>typestr <span style="color: #859900;">(</span>symbol-&gt;string type<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>string-append opstr <span style="color: #2aa198;">"/"</span> typestr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define-method</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">get</span> <span style="color: #268bd2;">(</span>dt <span style="color: #b58900;">&lt;dispatch-table&gt;</span><span style="color: #268bd2;">)</span> op type<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span>symbol? op<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>symbol? type<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
      <span style="color: #268bd2;">(</span>hash-ref <span style="color: #6c71c4;">(</span>method-table dt<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>table-ordinal op type<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
      #f<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define-method</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">put</span> <span style="color: #268bd2;">(</span>dt <span style="color: #b58900;">&lt;dispatch-table&gt;</span><span style="color: #268bd2;">)</span> op type item<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>hash-set! <span style="color: #268bd2;">(</span>method-table dt<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>table-ordinal op type<span style="color: #268bd2;">)</span> item<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">dispatch-tt</span> <span style="color: #b58900;">(</span>make <span style="color: #b58900;">&lt;dispatch-table&gt;</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">list-tag</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"Extract the type of expression"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>pair? expr<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>car expr<span style="color: #268bd2;">)</span> #f<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">install-procedure</span> p<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>put dispatch-tt 'eval <span style="color: #268bd2;">(</span>car p<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>cadr p<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Install our procedures</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span>
 install-procedure
 `<span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>quote  ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>expr env<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>text-of-quotation expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span><span style="color: #859900; font-weight: bold;">set!</span>    ,eval-assignment<span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span>define ,eval-definition<span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span>if     ,eval-if<span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span>lambda ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>expr env<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>make-procedure <span style="color: #b58900;">(</span>lambda-parameters expr<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>lambda-body expr<span style="color: #b58900;">)</span> env<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span>begin  ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>expr env<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>eval-sequence <span style="color: #b58900;">(</span>begin-actions expr<span style="color: #b58900;">)</span> env<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
   <span style="color: #268bd2;">[</span>cond   ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>expr env<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>zeval <span style="color: #b58900;">(</span>cond-&gt;if expr<span style="color: #b58900;">)</span> env<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">zeval</span> expr env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>dispatch-fn <span style="color: #859900;">(</span>get dispatch-tt 'eval <span style="color: #b58900;">(</span>list-tag expr<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">cond</span>
     <span style="color: #6c71c4;">[</span><span style="color: #859900;">(</span>self-evaluating? expr<span style="color: #859900;">)</span>
      expr<span style="color: #6c71c4;">]</span>
     <span style="color: #6c71c4;">[</span><span style="color: #859900;">(</span>variable? expr<span style="color: #859900;">)</span>
      <span style="color: #859900;">(</span>lookup-variable-value expr env<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
     <span style="color: #6c71c4;">[</span><span style="color: #859900;">(</span>procedure? dispatch-fn<span style="color: #859900;">)</span>
      <span style="color: #859900;">(</span>dispatch-fn expr env<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
     <span style="color: #6c71c4;">[</span><span style="color: #859900;">(</span>application? expr<span style="color: #859900;">)</span>
      <span style="color: #859900;">(</span>zapply <span style="color: #b58900;">(</span>zeval <span style="color: #268bd2;">(</span>operator expr<span style="color: #268bd2;">)</span> env<span style="color: #b58900;">)</span>
              <span style="color: #b58900;">(</span>list-of-values <span style="color: #268bd2;">(</span>operands expr<span style="color: #268bd2;">)</span> env<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
     <span style="color: #6c71c4;">[</span><span style="color: #859900; font-weight: bold;">else</span> <span style="color: #859900;">(</span>error <span style="color: #2aa198;">"Bad Expression"</span> expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">install-driver-loop</span> evaluator fn<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>put dispatch-tt 'driver-loop evaluator fn<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-driver-loop 'zeval base-driver-loop<span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org10eeb74" class="outline-3">
<h3 id="org10eeb74">Exercise 4.4</h3>
<div class="outline-text-3" id="text-org10eeb74">
<blockquote>
<p>
Recall the definitions of the special forms and and or from Chapter 1:
</p>

<p>
`and': The expressions are evaluated from left to right. If any expression
evaluates to false, false is returned; any remaining expressions are not
evaluated. If all the expressions evaluate to true values, the value of the last
expression is returned. If there are no expressions then true is returned.
`or': The expressions are evaluated from left to right. If any expression
evaluates to a true value, that value is returned; any remaining expressions are
not evaluated. If all expressions evaluate to false, or if there are no
expressions, then false is returned.
</p>

<p>
Install `and' and `or' as new special forms for the evaluator by defining
appropriate syntax procedures and evaluation procedures eval-and and eval-or.
Alternatively, show how to implement and and or as derived expressions. 
</p>
</blockquote>
</div>
<div id="outline-container-orgacb8e3e" class="outline-4">
<h4 id="orgacb8e3e">Answer</h4>
<div class="outline-text-4" id="text-orgacb8e3e">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">disjunct</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? <span style="color: #6c71c4;">(</span>cdr exp<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> 'false
      <span style="color: #268bd2;">(</span>cadr exp<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">rest-disjunctions</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? <span style="color: #6c71c4;">(</span>cdr exp<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span> '<span style="color: #268bd2;">()</span>
      <span style="color: #268bd2;">(</span>cddr exp<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">or</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">or?</span> exp<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>tagged-list? exp 'or<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">eval-or</span> exp env<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>eval-connective exp env true?<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">or</span> ,eval-or<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">and</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">and?</span> exp<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>tagged-list? exp 'and<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">eval-and</span> exp env<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>eval-connective exp env false?<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">and</span> ,eval-and<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">eval-connective</span> exp env oper<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"eval-connective evaluates the first part of an expression in the given</span>
<span style="color: #2aa198;">environment. If the result applied to `oper' is false, it continues to evaluate</span>
<span style="color: #2aa198;">until `(oper exp)' argument returns true or no arguments remain."</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>disjunction <span style="color: #859900;">(</span>zeval <span style="color: #b58900;">(</span>disjunct exp<span style="color: #b58900;">)</span> env<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>rest-disjunctions <span style="color: #859900;">(</span>rest-disjunctions exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">or</span> <span style="color: #859900;">(</span>oper disjunction<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>null? rest-disjunctions<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span> disjunction
        <span style="color: #6c71c4;">(</span>eval-connective <span style="color: #859900;">(</span>cons <span style="color: #b58900;">(</span>operator exp<span style="color: #b58900;">)</span> rest-disjunctions<span style="color: #859900;">)</span>
                         env
                         oper<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org962cedf" class="outline-3">
<h3 id="org962cedf">Exercise 4.5</h3>
<div class="outline-text-3" id="text-org962cedf">
<blockquote>
<p>
Scheme allows an additional syntax for cond clauses, (⟨test⟩ =&gt; ⟨recipient⟩). If
⟨test⟩ evaluates to a true value, then ⟨recipient⟩ is evaluated. Its value must
be a procedure of one argument; this procedure is then invoked on the value of
the ⟨test⟩, and the result is returned as the value of the cond expression. For
example
</p>

<p>
(cond ((assoc 'b '((a 1) (b 2))) =&gt; cadr)
(else false))
</p>

<p>
returns 2.
Modify the handling of cond so that it supports this extended syntax. 
</p>
</blockquote>
</div>
<div id="outline-container-orgf7475b9" class="outline-4">
<h4 id="orgf7475b9">Answer</h4>
<div class="outline-text-4" id="text-orgf7475b9">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">cond-is-pipe?</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>pair? exp<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>eq? <span style="color: #6c71c4;">(</span>cadr exp<span style="color: #6c71c4;">)</span> '=&gt;<span style="color: #268bd2;">)</span> #f<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">cond-recipient</span> exp<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>caddr exp<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">expand-clauses</span> clauses<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? clauses<span style="color: #268bd2;">)</span> 'false
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">[</span>first <span style="color: #b58900;">(</span>car clauses<span style="color: #b58900;">)</span><span style="color: #859900;">]</span>
            <span style="color: #859900;">[</span>rest  <span style="color: #b58900;">(</span>cdr clauses<span style="color: #b58900;">)</span><span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>

        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">check for =&gt;</span>
        <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>cond-is-pipe? first<span style="color: #859900;">)</span>
            <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>test <span style="color: #6c71c4;">(</span>cond-predicate first<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span>
              <span style="color: #b58900;">(</span>make-if test
                       <span style="color: #268bd2;">(</span>list <span style="color: #6c71c4;">(</span>cond-recipient first<span style="color: #6c71c4;">)</span> test<span style="color: #268bd2;">)</span>
                       <span style="color: #268bd2;">(</span>expand-clauses rest<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>

            <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">otherwise a normal cond applies</span>
            <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #b58900;">(</span>cond-else-clause? first<span style="color: #b58900;">)</span>
                <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? rest<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>sequence-&gt;exp <span style="color: #6c71c4;">(</span>cond-actions first<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
                    <span style="color: #268bd2;">(</span>error <span style="color: #2aa198;">"ELSE clause isn't last: COND-&gt;IF"</span> clauses<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
                <span style="color: #b58900;">(</span>make-if <span style="color: #268bd2;">(</span>cond-predicate first<span style="color: #268bd2;">)</span>
                         <span style="color: #268bd2;">(</span>sequence-&gt;exp <span style="color: #6c71c4;">(</span>cond-actions first<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
                         <span style="color: #268bd2;">(</span>expand-clauses rest<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org0954f61" class="outline-3">
<h3 id="org0954f61">Exercise 4.6</h3>
<div class="outline-text-3" id="text-org0954f61">
<blockquote>
<p>
Let expressions are derived expressions, because
</p>

<p>
(let ((⟨var₁⟩ ⟨exp₁⟩) … (⟨varₙ⟩ ⟨expₙ⟩))
⟨body⟩)
</p>

<p>
is equivalent to
</p>

<p>
((lambda (⟨var₁⟩ … ⟨varₙ⟩)
⟨body⟩)
⟨exp₁⟩
…
⟨expₙ⟩)
</p>

<p>
Implement a syntactic transformation let-&gt;combination that reduces evaluating
let expressions to evaluating combinations of the type shown above, and add the
appropriate clause to eval to handle let expressions. 
</p>
</blockquote>
</div>
<div id="outline-container-org7ec0985" class="outline-4">
<h4 id="org7ec0985">Answer</h4>
<div class="outline-text-4" id="text-org7ec0985">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span>generate-accessors
 <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>let-bindings       cadr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let-body           cddr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let-binding-vars   <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">cut</span> map car <span style="color: #b58900;">&lt;...&gt;</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let-binding-exprs  <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">cut</span> map cadr <span style="color: #b58900;">&lt;...&gt;</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let-vars           <span style="color: #6c71c4;">(</span>compose let-binding-vars let-bindings<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let-exprs          <span style="color: #6c71c4;">(</span>compose let-binding-exprs let-bindings<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>


<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">make-let-&gt;lambda</span> vars exprs body<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"Makes a let expression as ((lambda (vars) body) exprs)"</span>
  <span style="color: #b58900;">(</span>cons <span style="color: #268bd2;">(</span>make-lambda vars body<span style="color: #268bd2;">)</span> exprs<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">let-&gt;combination</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? exp<span style="color: #268bd2;">)</span> 'false
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">[</span>bindings <span style="color: #b58900;">(</span>let-bindings exp<span style="color: #b58900;">)</span><span style="color: #859900;">]</span>
            <span style="color: #859900;">[</span>body     <span style="color: #b58900;">(</span>let-body exp<span style="color: #b58900;">)</span><span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>make-let-&gt;lambda <span style="color: #859900;">(</span>let-binding-vars bindings<span style="color: #859900;">)</span>
                          <span style="color: #859900;">(</span>let-binding-exprs bindings<span style="color: #859900;">)</span>
                          body<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp env<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>zeval <span style="color: #859900;">(</span>let-&gt;combination exp<span style="color: #859900;">)</span> env<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd03ad06" class="outline-3">
<h3 id="orgd03ad06">Exercise 4.7</h3>
<div class="outline-text-3" id="text-orgd03ad06">
<blockquote>
<p>
`let*' is similar to `let', except that the bindings of the `let*' variables are
performed sequentially from left to right, and each binding is made in an
environment in which all of the preceding bindings are visible. For example
</p>

<p>
(let* ((x 3)
(y (+ x 2))
(z (+ x y 5)))
(* x z))
</p>

<p>
returns 39. Explain how a `let*' expression can be rewritten as a set of nested
let expressions, and write a procedure `let*-&gt;nested-lets' that performs this
transformation. If we have already implemented let (Exercise 4.6) and we want to
extend the evaluator to handle `let*', is it sufficient to add a clause to eval
whose action is
</p>

<p>
(eval (let*-&gt;nested-lets exp) env)
</p>

<p>
(let (x 3)
(let (y 2)
1))
</p>

<p>
((lambda (x) (lambda (y) 1) 2) 3)
</p>

<p>
or must we explicitly expand `let*' in terms of non-derived expressions? 
</p>
</blockquote>
</div>
<div id="outline-container-org3bef997" class="outline-4">
<h4 id="org3bef997">Answer</h4>
<div class="outline-text-4" id="text-org3bef997">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;;; </span><span style="color: #93a1a1;">There is nothing preventing `let*' from being defined in terms of existing</span>
<span style="color: #93a1a1;">;;; </span><span style="color: #93a1a1;">`let' expressions</span>
<span style="color: #2aa198;">(</span>generate-accessors
 <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>let*-body  caddr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>let*-inits cadr<span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;;;; </span><span style="color: #93a1a1;">This is a little funky here, I've replaced this with another version copied</span>
<span style="color: #93a1a1;">;;;; </span><span style="color: #93a1a1;">online -- the only thing wrong with this is some monkeying around with the let</span>
<span style="color: #93a1a1;">;;;; </span><span style="color: #93a1a1;">order</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">(define (let*-&gt;nested-let exp)</span>
<span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">(define (next exp)</span>
<span style="color: #93a1a1;">;;     </span><span style="color: #93a1a1;">(list (operator exp) (cdadr exp) (caddr exp)))</span>
<span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">(if (null? exp) 'false</span>
<span style="color: #93a1a1;">;;       </span><span style="color: #93a1a1;">(let ([bindings (let-bindings exp)]</span>
<span style="color: #93a1a1;">;;             </span><span style="color: #93a1a1;">[body     (let-body exp)])</span>
<span style="color: #93a1a1;">;;         </span><span style="color: #93a1a1;">(if (null? bindings) body</span>
<span style="color: #93a1a1;">;;             </span><span style="color: #93a1a1;">(make-let-&gt;lambda</span>
<span style="color: #93a1a1;">;;              </span><span style="color: #93a1a1;">(list (car (let-binding-vars bindings)))</span>
<span style="color: #93a1a1;">;;              </span><span style="color: #93a1a1;">(list (car (let-binding-exprs bindings)))</span>
<span style="color: #93a1a1;">;;              </span><span style="color: #93a1a1;">(let*-&gt;nested-let (next exp)))))))</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">let*-&gt;nested-lets</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>inits <span style="color: #859900;">(</span>let*-inits expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>body <span style="color: #859900;">(</span>let*-body expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">next</span> expr<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>null? expr<span style="color: #859900;">)</span> body
          <span style="color: #859900;">(</span>list 'let <span style="color: #b58900;">(</span>list <span style="color: #268bd2;">(</span>car expr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>next <span style="color: #268bd2;">(</span>cdr expr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>next inits<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>


<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let*</span> ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp env<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>zeval <span style="color: #859900;">(</span>let*-&gt;nested-lets exp<span style="color: #859900;">)</span> env<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgfd79cc7" class="outline-3">
<h3 id="orgfd79cc7">Exercise 4.8</h3>
<div class="outline-text-3" id="text-orgfd79cc7">
<blockquote>
<p>
“Named let” is a variant of let that has the form
</p>

<p>
(let ⟨var⟩ ⟨bindings⟩ ⟨body⟩)
</p>

<p>
The ⟨bindings⟩ and ⟨body⟩ are just as in ordinary let, except that ⟨var⟩ is
bound within ⟨body⟩ to a procedure whose body is ⟨body⟩ and whose parameters are
the variables in the ⟨bindings⟩. Thus, one can repeatedly execute the ⟨body⟩ by
invoking the procedure named ⟨var⟩. For example, the iterative Fibonacci
procedure (1.2.2) can be rewritten using named let as follows:
</p>

<p>
(define (fib n)
(let fib-iter ((a 1) (b 0) (count n))
(if (= count 0)
b
(fib-iter (+ a b)
a
(- count 1)))))
</p>

<p>
Modify let-&gt;combination of Exercise 4.6 to also support named let. 
</p>
</blockquote>
</div>
<div id="outline-container-org7bc464d" class="outline-4">
<h4 id="org7bc464d">Answer</h4>
<div class="outline-text-4" id="text-org7bc464d">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">named-let?</span> exp<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>symbol? <span style="color: #268bd2;">(</span>cadr exp<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>generate-accessors
 <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>nlet-var cadr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>nlet-bindings caddr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>nlet-body cdddr<span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">make-named-let</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">get prepped for that long let</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>body       <span style="color: #859900;">(</span>nlet-body exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
         <span style="color: #6c71c4;">[</span>bindings   <span style="color: #859900;">(</span>nlet-bindings exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
         <span style="color: #6c71c4;">[</span>vars       <span style="color: #859900;">(</span>let-binding-vars bindings<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
         <span style="color: #6c71c4;">[</span>exprs      <span style="color: #859900;">(</span>let-binding-exprs bindings<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
         <span style="color: #6c71c4;">[</span>fnname     <span style="color: #859900;">(</span>nlet-var exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
         <span style="color: #6c71c4;">[</span>fn         <span style="color: #859900;">(</span>make-lambda vars body<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>%as-syntax
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> ,bindings
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">begin</span>
         <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> ,fnname ,fn<span style="color: #b58900;">)</span>
         ,@body<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">let-&gt;combination</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>null? exp<span style="color: #268bd2;">)</span> 'false
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>named-let? exp<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>make-named-let exp<span style="color: #6c71c4;">)</span>
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">otherwise we're processing a normal let</span>
          <span style="color: #6c71c4;">(</span>make-let-&gt;lambda <span style="color: #859900;">(</span>let-vars exp<span style="color: #859900;">)</span>
                            <span style="color: #859900;">(</span>let-exprs exp<span style="color: #859900;">)</span>
                            <span style="color: #859900;">(</span>let-body exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb78004a" class="outline-3">
<h3 id="orgb78004a">Exercise 4.9</h3>
<div class="outline-text-3" id="text-orgb78004a">
<blockquote>
<p>
Many languages support a variety of iteration constructs, such as `do', `for',
`while', and `until'. In Scheme, iterative processes can be expressed in terms of
ordinary procedure calls, so special iteration constructs provide no essential
gain in computational power. On the other hand, such constructs are often
convenient. Design some iteration constructs, give examples of their use, and
show how to implement them as derived expressions. 
</p>
</blockquote>
</div>
<div id="outline-container-org459886b" class="outline-4">
<h4 id="org459886b">Answer</h4>
<div class="outline-text-4" id="text-org459886b">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>generate-accessors
 <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>while-cond cadr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>while-body caddr<span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">make-while</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>body <span style="color: #859900;">(</span>while-body exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>cond <span style="color: #859900;">(</span>while-cond exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>null? cond<span style="color: #6c71c4;">)</span> 'false
        <span style="color: #6c71c4;">(</span>%as-syntax
         <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">while-loop</span> <span style="color: #b58900;">()</span>
           <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> ,cond
               <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">begin</span> ,body
                      <span style="color: #6c71c4;">(</span>while-loop<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
               false<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span>while ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp env<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>zeval <span style="color: #859900;">(</span>make-while exp<span style="color: #859900;">)</span> env<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8569744" class="outline-3">
<h3 id="org8569744">Exercise 4.11 &amp; Exercise 4.12</h3>
<div class="outline-text-3" id="text-org8569744">
<blockquote>
<p>
4.11: Instead of representing a frame as a pair of lists, we can represent a
frame as a list of bindings, where each binding is a name-value pair. Rewrite
the environment operations to use this alternative representation.
</p>

<p>
4.12: The procedures define-variable!, set-variable-value! and
lookup-variable-value can be expressed in terms of more abstract procedures for
traversing the environment structure. Define abstractions that capture the
common patterns and redefine the three procedures in terms of these
abstractions. 
</p>
</blockquote>
<p>
<b>*</b> Answer
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">make-frame</span> variables values<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">map</span> cons variables values<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">var-process</span> var environment fn<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">var-search</span> env<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>eq? env the-empty-environment<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">begin</span>
                                          <span style="color: #93a1a1;">;;</span><span style="color: #93a1a1;">(pretty-print environment)</span>
                                          <span style="color: #859900;">(</span>error <span style="color: #2aa198;">"Unbound variable"</span> var<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #859900;">(</span><span style="color: #b58900;">[</span>frame <span style="color: #268bd2;">(</span>first-frame env<span style="color: #268bd2;">)</span><span style="color: #b58900;">]</span>
               <span style="color: #b58900;">[</span>entry <span style="color: #268bd2;">(</span>assoc var frame<span style="color: #268bd2;">)</span><span style="color: #b58900;">]</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">if</span> entry <span style="color: #b58900;">(</span>fn frame entry<span style="color: #b58900;">)</span>
              <span style="color: #b58900;">(</span>var-search <span style="color: #268bd2;">(</span>enclosing-environment env<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>var-search environment<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">lookup-variable-value</span> var env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>var-process var env <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>_frame entry<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>cdr entry<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">set-variable-value!</span> var val env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>var-process var env <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>frame entry<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>set-cdr! entry val<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">define-variable!</span> var val env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>set-car! env <span style="color: #268bd2;">(</span>assoc-set! <span style="color: #6c71c4;">(</span>first-frame env<span style="color: #6c71c4;">)</span> var val<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org7960b41" class="outline-3">
<h3 id="org7960b41">Exercise 4.13</h3>
<div class="outline-text-3" id="text-org7960b41">
<blockquote>
<p>
Scheme allows us to create new bindings for variables by means of define, but
provides no way to get rid of bindings. Implement for the evaluator a special
form make-unbound! that removes the binding of a given symbol from the
environment in which the make-unbound! expression is evaluated. This problem is
not completely specified. For example, should we remove only the binding in the
first frame of the environment? Complete the specification and justify any
choices you make. 
</p>
</blockquote>
</div>
<div id="outline-container-orgd6ddcc6" class="outline-4">
<h4 id="orgd6ddcc6">Answer</h4>
<div class="outline-text-4" id="text-orgd6ddcc6">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Spec:</span>
<span style="color: #93a1a1;">`undefine' and `unset' are functions that set the name of the binding inside the</span>
<span style="color: #93a1a1;">closest stack-frame to null. |#</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">undefine-variable!</span> var env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>var-process var env <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>frame entry<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>set-car! entry '<span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">eval-undefinition</span> exp env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>undefine-variable!
   <span style="color: #268bd2;">(</span>definition-variable exp<span style="color: #268bd2;">)</span> env<span style="color: #b58900;">)</span>
  'ok<span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span>undefine ,eval-undefinition<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org4e48fe2" class="outline-3">
<h3 id="org4e48fe2">Exercise 4.14</h3>
<div class="outline-text-3" id="text-org4e48fe2">
<blockquote>
<p>
Eva Lu Ator and Louis Reasoner are each experimenting with the metacircular
evaluator. Eva types in the definition of map, and runs some test programs that
use it. They work fine. Louis, in contrast, has installed the system version of
map as a primitive for the metacircular evaluator. When he tries it, things go
terribly wrong. Explain why Louis’s map fails even though Eva’s works. 
</p>
</blockquote>
</div>
<div id="outline-container-orgd396a1d" class="outline-4">
<h4 id="orgd396a1d">Answer</h4>
<div class="outline-text-4" id="text-orgd396a1d">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">Louis is trying to use a variable defined inside the *interpreters* stack</span>
<span style="color: #93a1a1;">frame, not the *interpreTED* stack frame |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge71fda9" class="outline-3">
<h3 id="orge71fda9">Exercise 4.15</h3>
<div class="outline-text-3" id="text-orge71fda9">
<blockquote>
<p>
Given a one-argument procedure p and an object a, p is said to “halt” on a if
evaluating the expression (p a) returns a value (as opposed to terminating with
an error message or running forever). Show that it is impossible to write a
procedure halts? that correctly determines whether p halts on a for any
procedure p and object a. Use the following reasoning: If you had such a
procedure halts?, you could implement the following program:
</p>

<p>
(define (run-forever)
(run-forever))
</p>

<p>
(define (try p)
(if (halts? p p)
(run-forever)
'halted))
</p>

<p>
Now consider evaluating the expression (try try) and show that any possible
outcome (either halting or running forever) violates the intended behavior of
halts?. 
</p>
</blockquote>
</div>
<div id="outline-container-orgf880cd8" class="outline-4">
<h4 id="orgf880cd8">Answer</h4>
<div class="outline-text-4" id="text-orgf880cd8">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| - - - - - Solution:</span>
<span style="color: #93a1a1;">This problem is an abstract description of a thought experiment Turing conducted in the 1930s which would later be known as the 'halting problem'.</span>

<span style="color: #93a1a1;">The problem has no solution for a similar reason to the 'liar' paradox:</span>

<span style="color: #93a1a1;">Suppose it returns true -- `try' enters an endless loop, so it obviously doesn&#8217;t halt, while halts? returned true. The contrawise position is identical</span>

<span style="color: #93a1a1;">Therefore there can be no solution to the problem |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org2c99ed5" class="outline-3">
<h3 id="org2c99ed5">Exercise 4.16</h3>
<div class="outline-text-3" id="text-org2c99ed5">
<blockquote>
<p>
In this exercise we implement the method just described for interpreting
internal definitions. We assume that the evaluator supports let (see Exercise
4.6).
</p>

<ol class="org-ol">
<li>Change `lookup-variable-value' (4.1.3) to signal an error if the value it finds</li>
</ol>
<p>
is the symbol <b>unassigned</b>.
</p>
<ol class="org-ol">
<li>Write a procedure `scan-out-defines' that takes a procedure body and returns an</li>
</ol>
<p>
equivalent one that has no internal definitions, by making the transformation
described above.
</p>
<ol class="org-ol">
<li>Install `scan-out-defines' in the interpreter, either in make-procedure or in</li>
</ol>
<p>
procedure-body (see 4.1.3). Which place is better? Why? 
</p>
</blockquote>
</div>
<div id="outline-container-org04ffe11" class="outline-4">
<h4 id="org04ffe11">Answer</h4>
<div class="outline-text-4" id="text-org04ffe11">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">1. Solution</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">simultaneous/lookup-variable-value</span> var env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>var-process var env <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>_f entry<span style="color: #6c71c4;">)</span>
                         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>eq? <span style="color: #b58900;">(</span>cdr entry<span style="color: #b58900;">)</span> '*unassigned*<span style="color: #859900;">)</span>
                             <span style="color: #859900;">(</span>error <span style="color: #2aa198;">"Unassigned var: "</span> var<span style="color: #859900;">)</span>
                             <span style="color: #859900;">(</span>cdr entry<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">2</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">scan-out-defines</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"Transform a procedure, returning an equivalent one with no internal</span>
<span style="color: #2aa198;">definitions"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">has-define</span> <span style="color: #268bd2;">(</span>find <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>e<span style="color: #859900;">)</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #b58900;">(</span>pair? e<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>eq? <span style="color: #268bd2;">(</span>car e<span style="color: #268bd2;">)</span> 'define<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
                           expr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> has-define
      <span style="color: #268bd2;">(</span>fold
       <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>elt prev<span style="color: #859900;">)</span>
         <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>bindings <span style="color: #6c71c4;">(</span>let-bindings prev<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
               <span style="color: #268bd2;">[</span>body     <span style="color: #6c71c4;">(</span>let-body prev<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span>
           <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">merge our (new) bindings &amp; body</span>
           <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">match</span> elt
             <span style="color: #268bd2;">[</span><span style="color: #6c71c4;">(</span>'define var val<span style="color: #6c71c4;">)</span>
              `<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span><span style="color: #2aa198;">(</span>,var '*unassigned*<span style="color: #2aa198;">)</span>
                     ,@bindings<span style="color: #859900;">)</span>
                 <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> ,var ,val<span style="color: #859900;">)</span>
                 <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">we use ,@ to prevent recursive lists</span>
                 ,@body<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
             <span style="color: #268bd2;">[</span>_ `<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> ,bindings ,@body ,elt<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
       '<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">we start with a basic let expression</span>
       expr<span style="color: #268bd2;">)</span>
      expr<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">simulatanous test</span>
<span style="color: #2aa198;">(</span>assert-equal
 <span style="color: #b58900;">(</span>scan-out-defines '<span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">a</span> <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span>
                     <span style="color: #6c71c4;">(</span>make-thing <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span>
                     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">b</span> <span style="color: #6c71c4;">2</span><span style="color: #6c71c4;">)</span>
                     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">c</span> <span style="color: #6c71c4;">3</span><span style="color: #6c71c4;">)</span>
                     <span style="color: #6c71c4;">(</span>make-thing a <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>c '*unassigned*<span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>b '*unassigned*<span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>a '*unassigned*<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">set!</span> c <span style="color: #6c71c4;">3</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">set!</span> b <span style="color: #6c71c4;">2</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">set!</span> a <span style="color: #6c71c4;">1</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>make-thing <span style="color: #6c71c4;">1</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>make-thing a <span style="color: #6c71c4;">1</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">3 -- I've selected make-procedure so that the conversion is done at</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">interpretation, rather than runtime.</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">simultaneous/make-procedure</span> parameters body env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>list 'procedure
        parameters
        <span style="color: #268bd2;">(</span>scan-out-defines body<span style="color: #268bd2;">)</span>
        env<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3599ea2" class="outline-3">
<h3 id="org3599ea2">Exercise 4.18</h3>
<div class="outline-text-3" id="text-org3599ea2">
<blockquote>
<p>
Consider an alternative strategy for scanning out definitions that translates
the example in the text to
</p>

<p>
(lambda ⟨vars⟩
(let ((u '<b>unassigned</b>)
(v '<b>unassigned</b>))
(let ((a ⟨e1⟩)
(b ⟨e2⟩))
(set! u a)
(set! v b))
⟨e3⟩))
</p>

<p>
Here a and b are meant to represent new variable names, created by the
interpreter, that do not appear in the user’s program. Consider the solve
procedure from 3.5.4:
</p>

<p>
(define (solve f y0 dt)
(define y (integral (delay dy) y0 dt))
(define dy (stream-map f y))
y)
</p>

<p>
Will this procedure work if internal definitions are scanned out as shown in
this exercise? What if they are scanned out as shown in the text? Explain. 
</p>
</blockquote>
</div>
<div id="outline-container-orgd149d1b" class="outline-4">
<h4 id="orgd149d1b">Answer</h4>
<div class="outline-text-4" id="text-orgd149d1b">
<div class="org-src-container">
<pre class="src src-scheme">
                                        <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">- - - - - - Solution:</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">This wont work because the proxy-value of `y' (a) cannot be directly</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">referenced upon the definition of `dy'</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org53b3670" class="outline-3">
<h3 id="org53b3670">Exercise 4.19</h3>
<div class="outline-text-3" id="text-org53b3670">
<blockquote>
<p>
Ben Bitdiddle, Alyssa P. Hacker, and Eva Lu Ator are arguing about the desired
result of evaluating the expression
</p>

<p>
(let ((a 1))
(define (f x)
(define b (+ a x))
(define a 5)
(+ a b))
(f 10))
</p>

<p>
Ben asserts that the result should be obtained using the sequential rule for
define: `b' is defined to be 11, then `a' is defined to be 5, so the result is
</p>
<ol class="org-ol">
<li>Alyssa objects that mutual recursion requires the simultaneous scope rule</li>
</ol>
<p>
for internal procedure definitions, and that it is unreasonable to treat
procedure names differently from other names. Thus, she argues for the mechanism
implemented in Exercise 4.16. This would lead to a being unassigned at the time
that the value for `b' is to be computed. Hence, in Alyssa’s view the procedure
should produce an error. Eva has a third opinion. She says that if the
definitions of `a' and `b' are truly meant to be simultaneous, then the value 5
for `a' should be used in evaluating b. Hence, in Eva’s view `a' should be 5, `b'
should be 15, and the result should be 20. Which (if any) of these viewpoints do
you support? Can you devise a way to implement internal definitions so that they
behave as Eva prefers? 
</p>
</blockquote>
</div>
<div id="outline-container-orgaeb9399" class="outline-4">
<h4 id="orgaeb9399">Answer</h4>
<div class="outline-text-4" id="text-orgaeb9399">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution</span>
<span style="color: #93a1a1;">I like Alyssas view, although Ben's dominates most thinking.</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Eva's view can be easily supported by swapping the order within the `let'</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">quasiquote of `set!' and `@,body'</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge548a61" class="outline-3">
<h3 id="orge548a61">Exercise 4.20 (lol)</h3>
<div class="outline-text-3" id="text-orge548a61">
<blockquote>
<p>
Because internal definitions look sequential but are actually simultaneous, some
people prefer to avoid them entirely, and use the special form letrec instead.
Letrec looks like let, so it is not surprising that the variables it binds are
bound simultaneously and have the same scope as each other. The sample procedure
f above can be written without internal definitions, but with exactly the same
meaning, as
</p>

<p>
(define (f x)
(letrec
((even?
(lambda (n)
(if (= n 0)
true
(odd? (- n 1)))))
(odd?
(lambda (n)
(if (= n 0)
false
(even? (- n 1))))))
⟨rest of body of f⟩))
</p>

<p>
`letrec' expressions, which have the form
</p>

<p>
(letrec ((⟨var₁⟩ ⟨exp₁⟩) … (⟨varₙ⟩ ⟨expₙ⟩))
⟨body⟩)
</p>

<p>
are a variation on let in which the expressions ⟨expₖ⟩ that provide the initial
values for the variables ⟨varₖ⟩ are evaluated in an environment that includes
all the letrec bindings. This permits recursion in the bindings, such as the
mutual recursion of even? and odd? in the example above, or the evaluation of 10
factorial with
</p>

<p>
(letrec
((fact
(lambda (n)
(if (= n 1)
1
(* n (fact (- n 1)))))))
(fact 10))
</p>

<ol class="org-ol">
<li>Implement letrec as a derived expression, by transforming a letrec expression</li>
</ol>
<p>
into a let expression as shown in the text above or in Exercise 4.18. That is,
the letrec variables should be created with a let and then be assigned their
values with set!.
</p>

<ol class="org-ol">
<li>Louis Reasoner is confused by all this fuss about internal definitions. The</li>
</ol>
<p>
way he sees it, if you don’t like to use define inside a procedure, you can just
use let. Illustrate what is loose about his reasoning by drawing an environment
diagram that shows the environment in which the ⟨rest of body of f⟩ is evaluated
during evaluation of the expression (f 5), with f defined as in this exercise.
Draw an environment diagram for the same evaluation, but with let in place of
letrec in the definition of f. 
</p>
</blockquote>
</div>
<div id="outline-container-org1e8a13f" class="outline-4">
<h4 id="org1e8a13f">Answer</h4>
<div class="outline-text-4" id="text-org1e8a13f">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">1.</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">letrec-&gt;let</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>%as-syntax
   <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span>
       ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">map</span> <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">generate the (binding . '*unassigned) let binds</span>
         <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>v<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>list v ''*unassigned<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
         <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">map</span> car <span style="color: #b58900;">(</span>cadr expr<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>

     ,@<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">map</span> <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">generate the `set!' expressions</span>
        <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>bind<span style="color: #b58900;">)</span> `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> ,<span style="color: #268bd2;">(</span>car bind<span style="color: #268bd2;">)</span> ,<span style="color: #268bd2;">(</span>cadr bind<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>let-bindings expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>

     <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">and merge our existing body</span>
     ,@<span style="color: #6c71c4;">(</span>let-body expr<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>assert-equal
 <span style="color: #b58900;">(</span>letrec-&gt;let
  `<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">letrec</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span>a <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #268bd2;">()</span> <span style="color: #268bd2;">(</span>b<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
            <span style="color: #859900;">(</span>b <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #268bd2;">()</span> <span style="color: #268bd2;">(</span>a<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>x a<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>x b<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>x c<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>

 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>a '*unassigned<span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>b '*unassigned<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">set!</span> a <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #859900;">()</span> <span style="color: #859900;">(</span>b<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">set!</span> b <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #859900;">()</span> <span style="color: #859900;">(</span>a<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>x a<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>x b<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>x c<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">letrec</span> ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp env<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>zeval <span style="color: #859900;">(</span>letrec-&gt;let exp<span style="color: #859900;">)</span> env<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">2.</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">The main problem with Louis's reasoning is that the environment that `let' is</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">being evaluating against is actually expressed in the form of a `lambda' whoses</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">actual function bodies are being passed in as arguments (in the case of (f x)),</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">this means that the lexical scope of `even?' cannot see that of `odd?' and</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">versa.</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgac5f3c8" class="outline-3">
<h3 id="orgac5f3c8">Exercise 4.21</h3>
<div class="outline-text-3" id="text-orgac5f3c8">
<blockquote>
<p>
Amazingly, Louis’s intuition in Exercise 4.20 is correct. It is indeed possible
to specify recursive procedures without using letrec (or even define), although
the method for accomplishing this is much more subtle than Louis imagined. The
following expression computes 10 factorial by applying a recursive factorial
procedure:231
</p>

<p>
((lambda (n)
((lambda (fact) (fact fact n))
(lambda (ft k)
(if (= k 1)
1
(* k (ft ft (- k 1)))))))
</p>
<ol class="org-ol">
<li></li>


<li>Check (by evaluating the expression) that this really does compute</li>
</ol>
<p>
factorials. Devise an analogous expression for computing Fibonacci numbers.
</p>

<p>
Consider the following procedure, which includes mutually recursive internal
definitions:
</p>

<p>
(define (f x)
(define (even? n)
(if (= n 0)
true
(odd? (- n 1))))
(define (odd? n)
(if (= n 0)
false
(even? (- n 1))))
(even? x))
</p>

<ol class="org-ol">
<li>Fill in the missing expressions to complete an alternative definition of f,</li>
</ol>
<p>
which uses neither internal definitions nor letrec:
</p>

<p>
(define (f x)
((lambda (even? odd?)
(even? even? odd? x))
(lambda (ev? od? n)
(if (= n 0)
true
(od? ⟨??⟩ ⟨??⟩ ⟨??⟩)))
(lambda (ev? od? n)
(if (= n 0)
false
(ev? ⟨??⟩ ⟨??⟩ ⟨??⟩))))) 
</p>
</blockquote>
<p>
<b>*</b> Answer
</p>
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">1.</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">It does indeed produce Factorials</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">funk-fibonacci</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #268bd2;">(</span>n<span style="color: #268bd2;">)</span> <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">(it's a fibonacci number)</span>
    <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>fib<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>fib fib n<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>fb k<span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">match</span> k
         <span style="color: #b58900;">[</span><span style="color: #6c71c4;">0</span> <span style="color: #6c71c4;">1</span><span style="color: #b58900;">]</span>
         <span style="color: #b58900;">[</span><span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">1</span><span style="color: #b58900;">]</span>
         <span style="color: #b58900;">[</span>_ <span style="color: #268bd2;">(</span>+ <span style="color: #6c71c4;">(</span>fb fb <span style="color: #859900;">(</span>- k <span style="color: #6c71c4;">1</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
               <span style="color: #6c71c4;">(</span>fb fb <span style="color: #859900;">(</span>- k <span style="color: #6c71c4;">2</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">]</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">2.</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">feven-4.21</span> x<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>even? odd?<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>even? even? odd? x<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
   <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>ev? od? n<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>= n <span style="color: #6c71c4;">0</span><span style="color: #859900;">)</span>
         #t
         <span style="color: #859900;">(</span>od? ev? od? <span style="color: #b58900;">(</span>- n <span style="color: #6c71c4;">1</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
   <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>ev? od? n<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>= n <span style="color: #6c71c4;">0</span><span style="color: #859900;">)</span>
         #f
         <span style="color: #859900;">(</span>ev? ev? od? <span style="color: #b58900;">(</span>- n <span style="color: #6c71c4;">1</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>assert <span style="color: #b58900;">(</span>= <span style="color: #268bd2;">(</span>funk-fibonacci <span style="color: #6c71c4;">4</span><span style="color: #268bd2;">)</span> <span style="color: #6c71c4;">5</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>assert <span style="color: #b58900;">(</span>feven-4.21 <span style="color: #6c71c4;">4</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>


<div id="outline-container-orgd406914" class="outline-3">
<h3 id="orgd406914">Exercise 4.22</h3>
<div class="outline-text-3" id="text-orgd406914">
<blockquote>
<p>
Extend the evaluator in this section to support the special form let. (See Exercise 4.6.) 
</p>
</blockquote>
</div>
<div id="outline-container-org28e85c0" class="outline-4">
<h4 id="org28e85c0">Answer</h4>
<div class="outline-text-4" id="text-org28e85c0">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>install-analyze-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>analyze <span style="color: #859900;">(</span>let-&gt;combination exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgde287e3" class="outline-3">
<h3 id="orgde287e3">Exercise 4.25</h3>
<div class="outline-text-3" id="text-orgde287e3">
<blockquote>
<p>
Suppose that (in ordinary applicative-order Scheme) we define unless as shown
above and then define factorial in terms of unless as
</p>

<p>
(define (factorial n)
(unless (= n 1)
(* n (factorial (- n 1)))
1))
What happens if we attempt to evaluate (factorial 5)? Will our definitions work
in a normal-order language? 
</p>
</blockquote>
</div>
<div id="outline-container-org5df3d10" class="outline-4">
<h4 id="org5df3d10">Answer</h4>
<div class="outline-text-4" id="text-org5df3d10">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solution:</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Applicative order languages will cause an infinite loop with the definition</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">of `unless' provided by SICP -- on the other hand a normal-order language will</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">do just fine</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org31d84bc" class="outline-3">
<h3 id="org31d84bc">Exercise 4.26</h3>
<div class="outline-text-3" id="text-org31d84bc">
<blockquote>
<p>
Ben Bitdiddle and Alyssa P. Hacker disagree over the importance of lazy
evaluation for implementing things such as unless. Ben points out that it’s
possible to implement unless in applicative order as a special form. Alyssa
counters that, if one did that, unless would be merely syntax, not a procedure
that could be used in conjunction with higher-order procedures. Fill in the
details on both sides of the argument. Show how to implement unless as a derived
expression (like cond or let), and give an example of a situation where it might
be useful to have unless available as a procedure, rather than as a special
form. 
</p>
</blockquote>
</div>
<div id="outline-container-orgc7c249e" class="outline-4">
<h4 id="orgc7c249e">Answer</h4>
<div class="outline-text-4" id="text-orgc7c249e">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">zv-unless</span> condition consequent alternative<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> condition alternative
      consequent<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>generate-accessors
 <span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>unless-predicate cadr<span style="color: #268bd2;">]</span>
  <span style="color: #268bd2;">[</span>unless-alternative caddr<span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">unless-consequent</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>not <span style="color: #6c71c4;">(</span>null? <span style="color: #859900;">(</span>cdddr exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
      <span style="color: #268bd2;">(</span>cadddr exp<span style="color: #268bd2;">)</span>
      'false<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">unless-&gt;if</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>make-if
   <span style="color: #268bd2;">(</span>unless-predicate exp<span style="color: #268bd2;">)</span>
   <span style="color: #268bd2;">(</span>unless-consequent exp<span style="color: #268bd2;">)</span>
   <span style="color: #268bd2;">(</span>unless-alternative exp<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">analyze-unless</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>pproc <span style="color: #859900;">(</span>analyze <span style="color: #b58900;">(</span>unless-predicate exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>cproc <span style="color: #859900;">(</span>analyze <span style="color: #b58900;">(</span>unless-consequent exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>aproc <span style="color: #859900;">(</span>analyze <span style="color: #b58900;">(</span>unless-alternative exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #6c71c4;">(</span>env<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>true? <span style="color: #b58900;">(</span>pproc env<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>cproc env<span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>aproc env<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">unless</span> ,<span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>exp env<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>zeval <span style="color: #859900;">(</span>unless-&gt;if exp<span style="color: #859900;">)</span> env<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>install-analyze-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">unless</span> ,analyze-unless<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">this functions utility is for lazy bums who cant type `not'</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Various evaluator utils</span>
</pre>
</div>
<p>
;; Lazy Evaluator
(include "/home/zv/z/practice/sicp/evaluator/lazy-evaluator.scm")
</p>

<p>
;; Install our new driver-loop
(define (lazy-driver-loop)
(prompt-for-input ";; Lazy (leval) input: ")
(let* ((input (read))
(output (actual-value input the-global-environment)))
(announce-output output-prompt)
(user-print output))
(lazy-driver-loop))
</p>

<p>
(install-driver-loop 'leval lazy-driver-loop)
#+end<sub>src</sub>
</p>
</div>
</div>
</div>
<div id="outline-container-org079a25a" class="outline-3">
<h3 id="org079a25a">Exercise 4.27</h3>
<div class="outline-text-3" id="text-org079a25a">
<blockquote>
<p>
Suppose we type in the following definitions to the lazy evaluator:
</p>

<p>
(define count 0)
(define (id x) (set! count (+ count 1)) x)
(define w (id (id 10)))
</p>

<p>
Give the missing values in the following sequence of interactions, and explain
your answers.
</p>


<p>
;;; L-Eval input:
count
</p>

<p>
;;; L-Eval value:
1
</p>

<p>
;;; L-Eval input:
w
</p>

<p>
;;; L-Eval value:
10
</p>

<p>
;;; L-Eval input:
count
</p>

<p>
;;; L-Eval value:
2
</p>
</blockquote>
</div>
<div id="outline-container-org1afa179" class="outline-4">
<h4 id="org1afa179">Answer</h4>
<div class="outline-text-4" id="text-org1afa179">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org28a4f73" class="outline-3">
<h3 id="org28a4f73">Exercise 4.28</h3>
<div class="outline-text-3" id="text-org28a4f73">
<blockquote>
<p>
lazy-eval uses actual-value rather than leval to evaluate the operator before passing
it to apply, in order to force the value of the operator. Give an example that
demonstrates the need for this forcing.
</p>
</blockquote>
</div>
<div id="outline-container-orgc7d2d05" class="outline-4">
<h4 id="orgc7d2d05">Answer</h4>
<div class="outline-text-4" id="text-orgc7d2d05">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solution</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Any function using a lambda as an argument will fail -- the operands are</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">not forced and when trying to apply them you will attempt to apply a thunk</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">instead of a "real" value.</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orge8ac044" class="outline-3">
<h3 id="orge8ac044">Exercise 4.29</h3>
<div class="outline-text-3" id="text-orge8ac044">
<blockquote>
<p>
Exhibit a program that you would expect to run much more slowly without
memoization than with memoization. Also, consider the following interaction,
where the id procedure is defined as in Exercise 4.27 and count starts at 0:
</p>

<p>
(define (square x) (* x x))
</p>

<p>
;;; L-Eval input:
(square (id 10))
</p>

<p>
;;; L-Eval value:
⟨response⟩
</p>

<p>
;;; L-Eval input:
count
</p>

<p>
;;; L-Eval value:
⟨response⟩
</p>

<p>
Give the responses both when the evaluator memoizes and when it does not.
</p>
</blockquote>
</div>
<div id="outline-container-orgedde14d" class="outline-4">
<h4 id="orgedde14d">Answer</h4>
<div class="outline-text-4" id="text-orgedde14d">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solutions</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">The canonical example of a function sped up by memoization is factorial --</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">each of the components can be reused n^2 times</span>


<span style="color: #93a1a1;">#| Memoized:</span>
<span style="color: #93a1a1;">;;; L-Eval input:</span>
<span style="color: #93a1a1;">(square (id 10))</span>

<span style="color: #93a1a1;">;;; L-Eval value:</span>
<span style="color: #93a1a1;">100</span>

<span style="color: #93a1a1;">;;; L-Eval input:</span>
<span style="color: #93a1a1;">count</span>

<span style="color: #93a1a1;">;;; L-Eval value:</span>
<span style="color: #93a1a1;">1</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #93a1a1;">#| Raw:</span>

<span style="color: #93a1a1;">;;; L-Eval input:</span>
<span style="color: #93a1a1;">(square (id 10))</span>

<span style="color: #93a1a1;">;;; L-Eval value:</span>
<span style="color: #93a1a1;">100</span>

<span style="color: #93a1a1;">;;; L-Eval input:</span>
<span style="color: #93a1a1;">count</span>

<span style="color: #93a1a1;">;;; L-Eval value:</span>
<span style="color: #93a1a1;">2</span>

<span style="color: #93a1a1;">|#</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgbe55b8e" class="outline-3">
<h3 id="orgbe55b8e">Exercise 4.30</h3>
<div class="outline-text-3" id="text-orgbe55b8e">
<blockquote>
<p>
Cy D. Fect, a reformed C programmer, is worried that some side effects may never
take place, because the lazy evaluator doesn’t force the expressions in a
sequence. Since the value of an expression in a sequence other than the last one
is not used (the expression is there only for its effect, such as assigning to a
variable or printing), there can be no subsequent use of this value (e.g., as an
argument to a primitive procedure) that will cause it to be forced. Cy thus
thinks that when evaluating sequences, we must force all expressions in the
sequence except the final one. He proposes to modify eval-sequence from 4.1.1 to
use actual-value rather than eval:
</p>

<p>
(define (eval-sequence exps env)
(cond ((last-exp? exps)
(eval (first-exp exps) env))
(else
(actual-value (first-exp exps)
env)
(eval-sequence (rest-exps exps)
env))))
</p>

<ol class="org-ol">
<li>Ben Bitdiddle thinks Cy is wrong. He shows Cy the for-each procedure</li>
</ol>
<p>
described in Exercise 2.23, which gives an important example of a sequence with
side effects:
</p>

<p>
(define (for-each proc items)
(if (null? items)
'done
(begin (proc (car items))
(for-each proc
(cdr items)))))
</p>

<p>
He claims that the evaluator in the text (with the original eval-sequence)
handles this correctly:
</p>

<p>
;;; L-Eval input:
(for-each
(lambda (x) (newline) (display x))
'(57 321 88))
57
321
88
</p>

<p>
;;; L-Eval value:
done
</p>

<p>
Explain why Ben is right about the behavior of for-each.
</p>

<ol class="org-ol">
<li>Cy agrees that Ben is right about the for-each example, but says that that’s</li>
</ol>
<p>
not the kind of program he was thinking about when he proposed his change to
eval-sequence. He defines the following two procedures in the lazy evaluator:
</p>

<p>
(define (p1 x)
(set! x (cons x '(2)))
x)
</p>

<p>
(define (p2 x)
(define (p e) e x)
(p (set! x (cons x '(2)))))
</p>

<p>
What are the values of (p1 1) and (p2 1) with the original eval-sequence?
What would the values be with Cy’s proposed change to eval-sequence?
</p>

<ol class="org-ol">
<li>Cy also points out that changing eval-sequence as he proposes does not affect</li>
</ol>
<p>
the behavior of the example in part a. Explain why this is true.
</p>

<ol class="org-ol">
<li>How do you think sequences ought to be treated in the lazy evaluator? Do you</li>
</ol>
<p>
like Cy’s approach, the approach in the text, or some other approach?
</p>
</blockquote>
</div>
<div id="outline-container-org7f23daf" class="outline-4">
<h4 id="org7f23daf">Answer</h4>
<div class="outline-text-4" id="text-org7f23daf">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solutions</span>
<span style="color: #93a1a1;">1. In `for-each's case, the procedure is called every time, all primitive</span>
<span style="color: #93a1a1;">procedures are called -- even if they are the last.</span>

<span style="color: #93a1a1;">2.</span>
<span style="color: #93a1a1;">leval: (p1 1) =&gt; (1 2); (p2 1) =&gt; 1</span>
<span style="color: #93a1a1;">(`e' is never evaluated -- it's a compound procedure)</span>
<span style="color: #93a1a1;">actual-value: (p1 1) =&gt; (1 2); (p2 1) =&gt; (1 2)</span>

<span style="color: #93a1a1;">3. There is no difference -- primitive procedures are called either way</span>

<span style="color: #93a1a1;">4. Side effects are a critical aspect of computer programming -- a lazy computer</span>
<span style="color: #93a1a1;">system needs to execute them in a manner consistent with our expectations of a</span>
<span style="color: #93a1a1;">basic interpreter -- Cy's approach is the winner. |#</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga630f5d" class="outline-3">
<h3 id="orga630f5d">Exercise 4.31</h3>
<div class="outline-text-3" id="text-orga630f5d">
<blockquote>
<p>
The approach taken in this section is somewhat unpleasant, because it makes an
incompatible change to Scheme. It might be nicer to implement lazy evaluation as
an upward-compatible extension, that is, so that ordinary Scheme programs will
work as before. We can do this by extending the syntax of procedure declarations
to let the user control whether or not arguments are to be delayed. While we’re
at it, we may as well also give the user the choice between delaying with and
without memoization. For example, the definition
</p>

<p>
(define (f a (b lazy) c (d lazy-memo))
…)
</p>

<p>
would define f to be a procedure of four arguments, where the first and third
arguments are evaluated when the procedure is called, the second argument is
delayed, and the fourth argument is both delayed and memoized. Thus, ordinary
procedure definitions will produce the same behavior as ordinary Scheme, while
adding the lazy-memo declaration to each parameter of every compound procedure
will produce the behavior of the lazy evaluator defined in this section. Design
and implement the changes required to produce such an extension to Scheme. You
will have to implement new syntax procedures to handle the new syntax for
define. You must also arrange for eval or apply to determine when arguments are
to be delayed, and to force or delay arguments accordingly, and you must arrange
for forcing to memoize or not, as appropriate.
</p>
</blockquote>
</div>
<div id="outline-container-org7338db6" class="outline-4">
<h4 id="org7338db6">Answer</h4>
<div class="outline-text-4" id="text-org7338db6">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">perpetual-thunk?</span> obj<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>tagged-list? obj 'always-thunk<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">delay-it-perpetually</span> exp env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>list 'always-thunk exp env<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">list-of-resolved-args</span> parameters arguments env<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">map</span>
   <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>p a<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">match</span> p
       <span style="color: #859900;">[</span><span style="color: #b58900;">(</span>_ 'lazy<span style="color: #b58900;">)</span>       <span style="color: #b58900;">(</span>delay-it-perpetually a env<span style="color: #b58900;">)</span><span style="color: #859900;">]</span>
       <span style="color: #859900;">[</span><span style="color: #b58900;">(</span>_ 'lazy-memo<span style="color: #b58900;">)</span>  <span style="color: #b58900;">(</span>delay-it a env<span style="color: #b58900;">)</span><span style="color: #859900;">]</span>
       <span style="color: #859900;">[</span>_               a<span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
   parameters
   arguments<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">force-it</span> obj<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"This is just a memoizing version of `force-it'"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">fetch-result</span> e<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>actual-value <span style="color: #6c71c4;">(</span>thunk-exp e<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>thunk-env e<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">match</span> obj
    <span style="color: #268bd2;">[</span>thunk?
     <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span><span style="color: #b58900;">[</span>result <span style="color: #268bd2;">(</span>fetch-result obj<span style="color: #268bd2;">)</span><span style="color: #b58900;">]</span><span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> obj `<span style="color: #b58900;">(</span>evaluated-thunk ,result<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
       result<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
    <span style="color: #268bd2;">[</span>evaluated-thunk? <span style="color: #6c71c4;">(</span>thunk-value obj<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
    <span style="color: #268bd2;">[</span>perpetual-thunk? <span style="color: #6c71c4;">(</span>fetch-result obj<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
    <span style="color: #268bd2;">[</span>_ obj<span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">fetch-parameter</span> p<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>pair? p<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>car p<span style="color: #268bd2;">)</span> p<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">extract-parameters</span> fn<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">map</span> fetch-parameter <span style="color: #268bd2;">(</span>procedure-parameters fn<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">capply</span> procedure arguments env<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"capply is a combined `apply' function -- determining which parameters are</span>
<span style="color: #2aa198;">lazy, memoized or raw and supplying them to the function at hand"</span>
  <span style="color: #93a1a1;">;;</span><span style="color: #93a1a1;">(format #t "procedure: ~a\narguments: ~a\nenv: ~a" procedure arguments env)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">cond</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>primitive-procedure? procedure<span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>apply-primitive-procedure
          procedure
          <span style="color: #859900;">(</span>list-of-arg-values arguments env<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>  <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">changed</span>
        <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>compound-procedure? procedure<span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>leval-sequence
          <span style="color: #859900;">(</span>procedure-body procedure<span style="color: #859900;">)</span>

          <span style="color: #859900;">(</span>extend-environment
           <span style="color: #b58900;">(</span>extract-parameters procedure<span style="color: #b58900;">)</span>
           <span style="color: #b58900;">(</span>list-of-resolved-args <span style="color: #268bd2;">(</span>procedure-parameters procedure<span style="color: #268bd2;">)</span>
                                  arguments
                                  env<span style="color: #b58900;">)</span> <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">changed</span>
           <span style="color: #b58900;">(</span>procedure-environment procedure<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">else</span> <span style="color: #6c71c4;">(</span>error <span style="color: #2aa198;">"Unknown procedure type: APPLY"</span> procedure<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Install our new driver-loop</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">combined-driver-loop</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>prompt-for-input <span style="color: #2aa198;">";; Strict/Lazy (ceval) input: "</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>input <span style="color: #859900;">(</span>read<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>output <span style="color: #859900;">(</span>actual-value input the-global-environment<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>announce-output output-prompt<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>user-print output<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>combined-driver-loop<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-driver-loop 'ceval combined-driver-loop<span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge5447f5" class="outline-3">
<h3 id="orge5447f5">Exercise 4.35</h3>
<div class="outline-text-3" id="text-orge5447f5">
<blockquote>
<p>
Write a procedure an-integer-between that returns an integer between two given
bounds. This can be used to implement a procedure that finds Pythagorean
triples, i.e., triples of integers ( i , j , k ) between the given bounds such
that i ≤ j and i 2 + j 2 = k 2 , as follows:
</p>

<p>
(define (a-pythagorean-triple-between low high)
(let ((i (an-integer-between low high)))
(let ((j (an-integer-between i high)))
(let ((k (an-integer-between j high)))
(require (= (+ (* i i) (* j j))
(* k k)))
(list i j k)))))
</p>
</blockquote>
</div>
<div id="outline-container-org2066674" class="outline-4">
<h4 id="org2066674">Answer</h4>
<div class="outline-text-4" id="text-org2066674">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">an-integer-between</span> low high<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>&lt; low high<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>amb low
         <span style="color: #6c71c4;">(</span>an-integer-between <span style="color: #859900;">(</span>+ <span style="color: #6c71c4;">1</span> low<span style="color: #859900;">)</span> high<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org8f4bf9b" class="outline-3">
<h3 id="org8f4bf9b">Exercise 4.36</h3>
<div class="outline-text-3" id="text-org8f4bf9b">
<blockquote>
<p>
Exercise 3.69 discussed how to generate the stream of all Pythagorean triples,
with no upper bound on the size of the integers to be searched. Explain why
simply replacing an-integer-between by an-integer-starting-from in the procedure
in Exercise 4.35 is not an adequate way to generate arbitrary Pythagorean
triples. Write a procedure that actually will accomplish this. (That is, write a
procedure for which repeatedly typing try-again would in principle eventually
generate all Pythagorean triples.) 
</p>
</blockquote>
</div>
<div id="outline-container-org6d894f5" class="outline-4">
<h4 id="org6d894f5">Answer</h4>
<div class="outline-text-4" id="text-org6d894f5">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>sqrt ,sqrt<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">pyth-triple</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">k</span> <span style="color: #6c71c4;">(</span>an-integer-starting-from <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">j</span> <span style="color: #6c71c4;">(</span>an-integer-between <span style="color: #6c71c4;">1</span> k<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">i</span> <span style="color: #6c71c4;">(</span>an-integer-between <span style="color: #6c71c4;">1</span> j<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>= <span style="color: #859900;">(</span>+ <span style="color: #b58900;">(</span>* i i<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>* j j<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
                <span style="color: #859900;">(</span>* k k<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>list i j k<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">#| Solution Explanation:</span>
<span style="color: #93a1a1;">Depth first search means that an infinite `amb' loop will never progress past</span>
<span style="color: #93a1a1;">the first 'amb' |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1e4abdc" class="outline-3">
<h3 id="org1e4abdc">Exercise 4.37</h3>
<div class="outline-text-3" id="text-org1e4abdc">
<blockquote>
<p>
Ben Bitdiddle claims that the following method for generating Pythagorean
triples is more efficient than the one in Exercise 4.35. Is he correct? (Hint:
Consider the number of possibilities that must be explored.)
</p>

<p>
(define (a-pythagorean-triple-between low high)
(let ((i (an-integer-between low high))
(hsq (* high high)))
(let ((j (an-integer-between i high)))
(let ((ksq (+ (* i i) (* j j))))
(require (&gt;= hsq ksq))
(let ((k (sqrt ksq)))
(require (integer? k))
(list i j k))))))
</p>
</blockquote>
</div>
<div id="outline-container-org4eac911" class="outline-4">
<h4 id="org4eac911">Answer</h4>
<div class="outline-text-4" id="text-org4eac911">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">It seems to be -- Ben's method only uses N^2 space, while the .35 method uses</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">N^3 space, while also throwing away tons of 'impossible' results.</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf70379a" class="outline-3">
<h3 id="orgf70379a">Exercise 4.38</h3>
<div class="outline-text-3" id="text-orgf70379a">
<blockquote>
<p>
Modify the multiple-dwelling procedure to omit the requirement that Smith and
Fletcher do not live on adjacent floors. How many solutions are there to this
modified puzzle? 
</p>
</blockquote>
</div>
<div id="outline-container-orga09ba6a" class="outline-4">
<h4 id="orga09ba6a">Answer</h4>
<div class="outline-text-4" id="text-orga09ba6a">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution</span>

<span style="color: #93a1a1;">;; There are 5 distinct solutions</span>

<span style="color: #93a1a1;">|#</span>
<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">multiple-dwelling</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">baker</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">cooper</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">fletcher</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">miller</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">smith</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require
     <span style="color: #6c71c4;">(</span>distinct? <span style="color: #859900;">(</span>list baker cooper fletcher
                      miller smith<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= baker <span style="color: #6c71c4;">5</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= cooper <span style="color: #6c71c4;">1</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= fletcher <span style="color: #6c71c4;">5</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= fletcher <span style="color: #6c71c4;">1</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>&gt; miller cooper<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require
     <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= <span style="color: #b58900;">(</span>abs <span style="color: #268bd2;">(</span>- fletcher cooper<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> <span style="color: #6c71c4;">1</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>list <span style="color: #6c71c4;">(</span>list 'baker baker<span style="color: #6c71c4;">)</span>
          <span style="color: #6c71c4;">(</span>list 'cooper cooper<span style="color: #6c71c4;">)</span>
          <span style="color: #6c71c4;">(</span>list 'fletcher fletcher<span style="color: #6c71c4;">)</span>
          <span style="color: #6c71c4;">(</span>list 'miller miller<span style="color: #6c71c4;">)</span>
          <span style="color: #6c71c4;">(</span>list 'smith smith<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org278391d" class="outline-3">
<h3 id="org278391d">Exercise 4.39</h3>
<div class="outline-text-3" id="text-org278391d">
<blockquote>
<p>
Does the order of the restrictions in the multiple-dwelling procedure affect the
answer? Does it affect the time to find an answer? If you think it matters,
demonstrate a faster program obtained from the given one by reordering the
restrictions. If you think it does not matter, argue your case. 
</p>
</blockquote>
</div>
<div id="outline-container-orgb9a3b8b" class="outline-4">
<h4 id="orgb9a3b8b">Answer</h4>
<div class="outline-text-4" id="text-orgb9a3b8b">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">The order of the restrictions can matter regarding runtime invoking the</span>
<span style="color: #93a1a1;">'failure' continuation through a `require' statement or otherwise can prevent a</span>
<span style="color: #93a1a1;">great deal of work from being performed.</span>
<span style="color: #93a1a1;">|#</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc27b7f6" class="outline-3">
<h3 id="orgc27b7f6">TODO: Exercise 4.40</h3>
<div class="outline-text-3" id="text-orgc27b7f6">
<blockquote>
<p>
In the multiple dwelling problem, how many sets of assignments are there of
people to floors, both before and after the requirement that floor assignments
be distinct? It is very inefficient to generate all possible assignments of
people to floors and then leave it to backtracking to eliminate them. For
example, most of the restrictions depend on only one or two of the person-floor
variables, and can thus be imposed before floors have been selected for all the
people. Write and demonstrate a much more efficient nondeterministic procedure
that solves this problem based upon generating only those possibilities that are
not already ruled out by previous restrictions. (Hint: This will require a nest
of `let' expressions.) 
</p>
</blockquote>
</div>
<div id="outline-container-orgfcdc5d6" class="outline-4">
<h4 id="orgfcdc5d6">Answer</h4>
<div class="outline-text-4" id="text-orgfcdc5d6">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org37445c7" class="outline-3">
<h3 id="org37445c7">Exercise 4.41</h3>
<div class="outline-text-3" id="text-org37445c7">
<blockquote>
<p>
Write an ordinary Scheme program to solve the multiple dwelling puzzle. 
</p>
</blockquote>
</div>
<div id="outline-container-orgb483fc7" class="outline-4">
<h4 id="orgb483fc7">Answer</h4>
<div class="outline-text-4" id="text-orgb483fc7">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">possible-floors</span> '<span style="color: #b58900;">(</span><span style="color: #268bd2;">[</span>baker <span style="color: #6c71c4;">(</span><span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
                          <span style="color: #268bd2;">[</span>cooper <span style="color: #6c71c4;">(</span><span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
                          <span style="color: #268bd2;">[</span>fletcher <span style="color: #6c71c4;">(</span><span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
                          <span style="color: #268bd2;">[</span>miller <span style="color: #6c71c4;">(</span><span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span>
                          <span style="color: #268bd2;">[</span>smith <span style="color: #6c71c4;">(</span><span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>


<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">solve-it</span> floors<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">valid?</span> lst<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">distinct?</span> lst<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">cond</span>
       <span style="color: #859900;">(</span><span style="color: #b58900;">(</span>null? lst<span style="color: #b58900;">)</span> #t<span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span><span style="color: #b58900;">(</span>null? <span style="color: #268bd2;">(</span>cdr lst<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span> #t<span style="color: #859900;">)</span>
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">else</span>
        <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #268bd2;">(</span>not <span style="color: #6c71c4;">(</span>member <span style="color: #859900;">(</span>car lst<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>cdr lst<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
             <span style="color: #268bd2;">(</span>distinct? <span style="color: #6c71c4;">(</span>cdr lst<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span>distinct? <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">map</span> cdr lst<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>&gt; <span style="color: #859900;">(</span>assoc-ref lst 'miller<span style="color: #859900;">)</span>
            <span style="color: #859900;">(</span>assoc-ref lst 'cooper<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">check that smith and fletcher are not adjacent</span>
         <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= <span style="color: #6c71c4;">1</span> <span style="color: #b58900;">(</span>abs <span style="color: #268bd2;">(</span>- <span style="color: #6c71c4;">(</span>assoc-ref lst 'smith<span style="color: #6c71c4;">)</span>
                           <span style="color: #6c71c4;">(</span>assoc-ref lst 'fletcher<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>= <span style="color: #6c71c4;">1</span> <span style="color: #b58900;">(</span>abs <span style="color: #268bd2;">(</span>- <span style="color: #6c71c4;">(</span>assoc-ref lst 'cooper<span style="color: #6c71c4;">)</span>
                           <span style="color: #6c71c4;">(</span>assoc-ref lst 'fletcher<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>

  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">recursive-level</span> lst acc<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>null? lst<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>valid? acc<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>display acc<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #859900;">(</span><span style="color: #b58900;">(</span>top <span style="color: #268bd2;">(</span>car lst<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
               <span style="color: #b58900;">(</span>name <span style="color: #268bd2;">(</span>car top<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
               <span style="color: #b58900;">(</span>pfloors <span style="color: #268bd2;">(</span>cadr top<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">map</span>
           <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #268bd2;">(</span>elt<span style="color: #268bd2;">)</span>
             <span style="color: #268bd2;">(</span>recursive-level <span style="color: #6c71c4;">(</span>cdr lst<span style="color: #6c71c4;">)</span>
                              <span style="color: #6c71c4;">(</span>cons <span style="color: #859900;">(</span>cons name elt<span style="color: #859900;">)</span> acc<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
           pfloors<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>

  <span style="color: #b58900;">(</span>recursive-level floors '<span style="color: #268bd2;">()</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org946cf6d" class="outline-3">
<h3 id="org946cf6d">Exercise 4.42</h3>
<div class="outline-text-3" id="text-org946cf6d">
<blockquote>
<p>
Solve the following "Liars" puzzle (from Phillips 1934):
</p>

<p>
Five schoolgirls sat for an examination.  Their parents&#x2013;so they
thought&#x2013;showed an undue degree of interest in the result.  They
therefore agreed that, in writing home about the examination, each
girl should make one true statement and one untrue one.  The
following are the relevant passages from their letters:
</p>

<ul class="org-ul">
<li>Betty: "Kitty was second in the examination.  I was only
third."</li>

<li>Ethel: "You'll be glad to hear that I was on top.  Joan was
second."</li>

<li>Joan: "I was third, and poor old Ethel was bottom."</li>

<li>Kitty: "I came out second.  Mary was only fourth."</li>

<li>Mary: "I was fourth.  Top place was taken by Betty."</li>
</ul>

<p>
What in fact was the order in which the five girls were placed? 
</p>
</blockquote>
</div>
<div id="outline-container-orge71758d" class="outline-4">
<h4 id="orge71758d">Answer</h4>
<div class="outline-text-4" id="text-orge71758d">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> ,<span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #859900;">(</span>a b<span style="color: #859900;">)</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> a b<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;;</span><span style="color: #93a1a1;">(append! primitive-procedures `((or ,(&#955; (a b) (or a b)))))</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">amb/eval-or</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"Both `or' and `and' can be implemented as primitive procedures without</span>
<span style="color: #2aa198;">significant issue, `amb/eval-or' exists to advance my knowledge of the</span>
<span style="color: #2aa198;">evaluator"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>disjunction <span style="color: #859900;">(</span>amb/analyze <span style="color: #b58900;">(</span>disjunct expr<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">[</span>rest-disjunctions <span style="color: #859900;">(</span>rest-disjunctions expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>env succeed fail<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>disjunction
       env
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>value fail2<span style="color: #b58900;">)</span>
         <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>true? value<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span>succeed value fail2<span style="color: #268bd2;">)</span>
             <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #6c71c4;">(</span>null? rest-disjunctions<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>succeed #f fail2<span style="color: #6c71c4;">)</span>
                 <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span>amb/eval-or <span style="color: #2aa198;">(</span>cons 'or rest-disjunctions<span style="color: #2aa198;">)</span><span style="color: #859900;">)</span> env succeed fail<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
       fail<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>amb/install-procedure `<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">or</span> ,amb/eval-or<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">xor</span> a b<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">or</span> a b<span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> a b<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">require-or</span> p1 p2<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>require <span style="color: #6c71c4;">(</span>xor p1 p2<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">solve-liars</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">betty</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">ethel</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">joan</span>  <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">kitty</span> <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">mary</span>  <span style="color: #6c71c4;">(</span>amb <span style="color: #6c71c4;">1</span> <span style="color: #6c71c4;">2</span> <span style="color: #6c71c4;">3</span> <span style="color: #6c71c4;">4</span> <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>

    <span style="color: #268bd2;">(</span>require
     <span style="color: #6c71c4;">(</span>distinct? <span style="color: #859900;">(</span>list betty ethel joan kitty mary<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>

    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">betty</span>
    <span style="color: #268bd2;">(</span>require-or <span style="color: #6c71c4;">(</span>= kitty <span style="color: #6c71c4;">2</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>= betty <span style="color: #6c71c4;">3</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">ethel</span>
    <span style="color: #268bd2;">(</span>require-or <span style="color: #6c71c4;">(</span>= ethel <span style="color: #6c71c4;">1</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>= joan <span style="color: #6c71c4;">2</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">joan</span>
    <span style="color: #268bd2;">(</span>require-or <span style="color: #6c71c4;">(</span>= joan <span style="color: #6c71c4;">3</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>= ethel <span style="color: #6c71c4;">5</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">kitty</span>
    <span style="color: #268bd2;">(</span>require-or <span style="color: #6c71c4;">(</span>= kitty <span style="color: #6c71c4;">2</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>= mary <span style="color: #6c71c4;">4</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">mary</span>
    <span style="color: #268bd2;">(</span>require-or <span style="color: #6c71c4;">(</span>= mary <span style="color: #6c71c4;">4</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>= <span style="color: #6c71c4;">1</span> betty<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>list
     <span style="color: #6c71c4;">(</span>list 'betty betty<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>list 'ethel ethel<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>list 'joan joan<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>list 'kitty kitty<span style="color: #6c71c4;">)</span>
     <span style="color: #6c71c4;">(</span>list 'mary mary<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgfefc54e" class="outline-3">
<h3 id="orgfefc54e">Exercise 4.43</h3>
<div class="outline-text-3" id="text-orgfefc54e">
<blockquote>
<p>
Use the `amb' evaluator to solve the following puzzle
</p>

<p>
Mary Ann Moore's father has a yacht and so has each of his four friends: Colonel
Downing, Mr. Hall, Sir Barnacle Hood, and Dr. Parker. Each of the five also has
one daughter and each has named his yacht after a daughter of one of the others.
Sir Barnacle's yacht is the Gabrielle, Mr. Moore owns the Lorna; Mr. Hall the
Rosalind. The Melissa, owned by Colonel Downing, is named after Sir Barnacle's
daughter. Gabrielle's father owns the yacht that is named after Dr. Parker's
daughter. Who is Lorna's father?
</p>

<p>
Try to write the program so that it runs efficiently. Also determine how many
solutions there are if we are not told that Mary Ann's last name is Moore. 
</p>
</blockquote>
</div>
<div id="outline-container-org33b9882" class="outline-4">
<h4 id="org33b9882">Answer</h4>
<div class="outline-text-4" id="text-org33b9882">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #93a1a1;">#| </span>
<span style="color: #93a1a1;">&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9574;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;</span>
<span style="color: #93a1a1;">&#9553; Individual  &#9553; Yacht      &#9553;</span>
<span style="color: #93a1a1;">&#9568;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9580;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9571;</span>
<span style="color: #93a1a1;">&#9553; Downing     &#9553; Melissa    &#9553;</span>
<span style="color: #93a1a1;">&#9568;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9580;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9571;</span>
<span style="color: #93a1a1;">&#9553; Hall        &#9553; Rosalind   &#9553;</span>
<span style="color: #93a1a1;">&#9568;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9580;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9571;</span>
<span style="color: #93a1a1;">&#9553; Moore       &#9553; Lorna      &#9553;</span>
<span style="color: #93a1a1;">&#9568;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9580;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9571;</span>
<span style="color: #93a1a1;">&#9553; Hood        &#9553; Gabrielle  &#9553;</span>
<span style="color: #93a1a1;">&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9577;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;</span>
<span style="color: #93a1a1;">Gabrielle's father owns the yacht that is named after Dr. Parker's daughter</span>
<span style="color: #93a1a1;">&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9574;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;</span>
<span style="color: #93a1a1;">&#9553; Parker's Daughter      &#9553; Gabrielle's Father's Ship &#9553;</span>
<span style="color: #93a1a1;">&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9577;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;</span>
<span style="color: #93a1a1;">The Melissa, owned by Colonel Downing, is named after Sir Barnacle's daughter.</span>
<span style="color: #93a1a1;">&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9574;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;</span>
<span style="color: #93a1a1;">&#9553; Barnacle    &#9553; (Daughter: Melissa)       &#9553;</span>
<span style="color: #93a1a1;">&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9577;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>eq? ,eq?<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>cadr ,cadr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>caddr ,caddr<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">sailors</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">father</span> car<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">daughter</span> cadr<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">yacht</span> caddr<span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">different-names</span> father<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>eq? <span style="color: #b58900;">(</span>daughter father<span style="color: #b58900;">)</span>
                <span style="color: #b58900;">(</span>yacht father<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>

    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span>moore   <span style="color: #b58900;">(</span>list 'moore
                         'mary-ann
                         'lorna<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>hood    <span style="color: #b58900;">(</span>list 'hood
                         'melissa
                         'gabrielle<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>hall    <span style="color: #b58900;">(</span>list 'hall
                         <span style="color: #268bd2;">(</span>amb 'gabrielle 'lorna<span style="color: #268bd2;">)</span>
                         'rosalind<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>downing <span style="color: #b58900;">(</span>list 'downing
                         <span style="color: #268bd2;">(</span>amb 'gabrielle 'lorna 'rosalind<span style="color: #268bd2;">)</span>
                         'melissa<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>parker <span style="color: #b58900;">(</span>list 'parker
                        <span style="color: #268bd2;">(</span>amb 'gabrielle 'lorna 'rosalind<span style="color: #268bd2;">)</span>
                        'mary-anne<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>

      <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #859900;">(</span><span style="color: #b58900;">(</span>gabrielle-father <span style="color: #268bd2;">(</span>amb hall downing parker<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
            <span style="color: #b58900;">(</span>lorna-father     <span style="color: #268bd2;">(</span>amb hall downing parker<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>require <span style="color: #b58900;">(</span>eq? <span style="color: #268bd2;">(</span>daughter gabrielle-father<span style="color: #268bd2;">)</span> 'gabrielle<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>require <span style="color: #b58900;">(</span>eq? <span style="color: #268bd2;">(</span>daughter lorna-father<span style="color: #268bd2;">)</span> 'lorna<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>require <span style="color: #b58900;">(</span>different-names lorna-father<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>require <span style="color: #b58900;">(</span>different-names gabrielle-father<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        <span style="color: #859900;">(</span>require <span style="color: #b58900;">(</span>eq? <span style="color: #268bd2;">(</span>daughter parker<span style="color: #268bd2;">)</span>
                      <span style="color: #268bd2;">(</span>yacht gabrielle-father<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
        lorna-father<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org905afea" class="outline-3">
<h3 id="org905afea">TODO: Exercise 4.44</h3>
<div class="outline-text-3" id="text-org905afea">
<blockquote>
<p>
Exercise 2.42 described the “eight-queens puzzle” of placing queens on a
chessboard so that no two attack each other. Write a nondeterministic program to
solve this puzzle. 
</p>
</blockquote>
</div>
<div id="outline-container-org947d21d" class="outline-4">
<h4 id="org947d21d">Answer</h4>
<div class="outline-text-4" id="text-org947d21d">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
<p>
#| Parsing Natural Language Utils|#
</p>

<p>
#| Programs designed to accept natural language as input usually start by
attempting to "parse" the input, that is, to match the input against some
grammatical structure. For example, we might try to recognize simple sentences
consisting of an article followed by a noun followed by a verb, such as "The cat
eats." To accomplish such an analysis, we must be able to identify the parts of
speech of individual words. We could start with some lists that classify various
words: |#
(append! primitive-procedures `((set! ,(λ (x y) (set! x y)))))
(append! primitive-procedures `((memq ,memq)))
(map amb/infuse
'((define nouns '(noun student professor cat class))
(define verbs '(verb studies lectures eats sleeps))
(define articles '(article the a))
(define prepositions '(prep for to in by with))
(define <b>unparsed</b> '())
(define (parse-sentence)
(list 'sentence
(parse-noun-phrase)
(parse-verb-phrase)))
(define (parse-word word-list)
(require (not (null? <b>unparsed</b>)))
(require (memq (car <b>unparsed</b>) (cdr word-list)))
(let ((found-word (car <b>unparsed</b>)))
(set! <b>unparsed</b> (cdr <b>unparsed</b>))
(list (car word-list) found-word)))
(define (parse input)
(set! <b>unparsed</b> input)
(let ((sent (parse-sentence)))
(require (null? <b>unparsed</b>))
sent))
(define (parse-prepositional-phrase)
(list 'prep-phrase
(parse-word prepositions)
(parse-noun-phrase)))
(define (parse-verb-phrase)
(define (maybe-extend verb-phrase)
(amb verb-phrase
(maybe-extend (list 'verb-phrase
verb-phrase
(parse-prepositional-phrase)))))
(maybe-extend (parse-word verbs)))
(define (parse-simple-noun-phrase)
(list 'simple-noun-phrase
(parse-word articles)
(parse-word nouns)))
(define (parse-noun-phrase)
(define (maybe-extend noun-phrase)
(amb noun-phrase
(maybe-extend (list 'noun-phrase
noun-phrase
(parse-prepositional-phrase)))))
(maybe-extend (parse-simple-noun-phrase)))))
</p>

<p>
#+end<sub>src</sub>
</p>
</div>
</div>
</div>
<div id="outline-container-org3a500c7" class="outline-3">
<h3 id="org3a500c7">Exercise 4.45</h3>
<div class="outline-text-3" id="text-org3a500c7">
<blockquote>
<p>
With the grammar given above, the following sentence can be parsed in five
different ways: "the professor lectures to the student in the class with the
cat." Give the five parses and explain the differences in shades of meaning
among them. 
</p>
</blockquote>
</div>
<div id="outline-container-orge7e79a9" class="outline-4">
<h4 id="orge7e79a9">Answer</h4>
<div class="outline-text-4" id="text-orge7e79a9">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#|</span>
<span style="color: #93a1a1;">(parse '(the professor lectures to the student in the class with the cat)) ~&gt;</span>

<span style="color: #93a1a1;">(sentence</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun professor))</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb lectures)</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep to)</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun student))))</span>
<span style="color: #93a1a1;">(prep-phrase (prep in) (simple-noun-phrase (article the) (noun class))))</span>
<span style="color: #93a1a1;">(prep-phrase (prep with) (simple-noun-phrase (article the) (noun cat)))))</span>


<span style="color: #93a1a1;">(sentence</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun professor))</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb lectures)</span>
<span style="color: #93a1a1;">(prep-phrase (prep to) (simple-noun-phrase (article the) (noun student))))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep in)</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun class))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep with)</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun cat)))))))</span>

<span style="color: #93a1a1;">(sentence</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun professor))</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb lectures)</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep to)</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun student))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep in)</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun class))))))</span>
<span style="color: #93a1a1;">(prep-phrase (prep with) (simple-noun-phrase (article the) (noun cat)))))</span>

<span style="color: #93a1a1;">(sentence</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun professor))</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb lectures)</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep to)</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun student))</span>
<span style="color: #93a1a1;">(prep-phrase (prep in) (simple-noun-phrase (article the) (noun class))))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep with)</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun cat)))))))</span>

<span style="color: #93a1a1;">(sentence</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun professor))</span>
<span style="color: #93a1a1;">(verb-phrase</span>
<span style="color: #93a1a1;">(verb lectures)</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep to)</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun student))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep in)</span>
<span style="color: #93a1a1;">(noun-phrase</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun class))</span>
<span style="color: #93a1a1;">(prep-phrase</span>
<span style="color: #93a1a1;">(prep with)</span>
<span style="color: #93a1a1;">(simple-noun-phrase (article the) (noun cat))))))))) |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org348ec53" class="outline-3">
<h3 id="org348ec53">Exercise 4.46</h3>
<div class="outline-text-3" id="text-org348ec53">
<blockquote>
<p>
The evaluators in sections *Note and do not determine what order operands are
evaluated in. We will see that the `amb' evaluator evaluates them from left to
right. Explain why our parsing program wouldn't work if the operands were
evaluated in some other order. 
</p>
</blockquote>
</div>
<div id="outline-container-orgc2add00" class="outline-4">
<h4 id="orgc2add00">Answer</h4>
<div class="outline-text-4" id="text-orgc2add00">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| parse-word advances the *unparsed* list from left to right, because it knows</span>
<span style="color: #93a1a1;">that the parser works this way. Without being sure of the order, we couldn&#8217;t</span>
<span style="color: #93a1a1;">implement parse-word. |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7145e47" class="outline-3">
<h3 id="org7145e47">Exercise 4.49</h3>
<div class="outline-text-3" id="text-org7145e47">
<blockquote>
<p>
Alyssa P. Hacker is more interested in generating interesting sentences than in
parsing them. She reasons that by simply changing the procedure `parse-word' so
that it ignores the "input sentence" and instead always succeeds and generates
an appropriate word, we can use the programs we had built for parsing to do
generation instead. Implement Alyssa's idea, and show the first half-dozen or so
sentences generated. 
</p>
</blockquote>
</div>
<div id="outline-container-orga24955a" class="outline-4">
<h4 id="orga24955a">Answer</h4>
<div class="outline-text-4" id="text-orga24955a">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> amb/infuse
     '<span style="color: #b58900;">(</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate</span><span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>generate-sentence<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-sentence</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>list 'sentence
               <span style="color: #859900;">(</span>generate-noun-phrase<span style="color: #859900;">)</span>
               <span style="color: #859900;">(</span>generate-verb-phrase<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-word</span> word-list<span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>list <span style="color: #859900;">(</span>car word-list<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>amb word-list<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-prepositional-phrase</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>list 'prep-phrase
               <span style="color: #859900;">(</span>generate-word prepositions<span style="color: #859900;">)</span>
               <span style="color: #859900;">(</span>generate-noun-phrase<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-verb-phrase</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #859900;">(</span><span style="color: #268bd2;">maybe-extend</span> verb-phrase<span style="color: #859900;">)</span>
           <span style="color: #859900;">(</span>amb verb-phrase
                <span style="color: #b58900;">(</span>maybe-extend <span style="color: #268bd2;">(</span>list 'verb-phrase
                                    verb-phrase
                                    <span style="color: #6c71c4;">(</span>generate-prepositional-phrase<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>maybe-extend <span style="color: #859900;">(</span>generate-word verbs<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-simple-noun-phrase</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>list 'simple-noun-phrase
               <span style="color: #859900;">(</span>generate-word articles<span style="color: #859900;">)</span>
               <span style="color: #859900;">(</span>generate-word nouns<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #6c71c4;">(</span><span style="color: #268bd2;">generate-noun-phrase</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #859900;">(</span><span style="color: #268bd2;">maybe-extend</span> noun-phrase<span style="color: #859900;">)</span>
           <span style="color: #859900;">(</span>amb noun-phrase
                <span style="color: #b58900;">(</span>maybe-extend <span style="color: #268bd2;">(</span>list 'noun-phrase
                                    noun-phrase
                                    <span style="color: #6c71c4;">(</span>generate-prepositional-phrase<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>maybe-extend <span style="color: #859900;">(</span>generate-simple-noun-phrase<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf23b5f9" class="outline-3">
<h3 id="orgf23b5f9">Exercise 4.50</h3>
<div class="outline-text-3" id="text-orgf23b5f9">
<blockquote>
<p>
Implement a new special form ramb that is like amb except
that it searches alternatives in a random order, rather than
from left to right. Show how this can help with Alyssa’s
problem in Exercise 4.49. 
</p>
</blockquote>
</div>
<div id="outline-container-orgc43da65" class="outline-4">
<h4 id="orgc43da65">Answer</h4>
<div class="outline-text-4" id="text-orgc43da65">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">shuffle</span> lst<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"Returns a randomly re-ordered copy of `lst'"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>&lt; <span style="color: #6c71c4;">(</span>length lst<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">1</span><span style="color: #268bd2;">)</span> lst
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">[</span>item <span style="color: #b58900;">(</span>list-ref lst <span style="color: #268bd2;">(</span>random <span style="color: #6c71c4;">(</span>length lst<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>cons item <span style="color: #859900;">(</span>shuffle <span style="color: #b58900;">(</span>delete item lst<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">amb/analyze-ramb</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>amb/analyze-amb <span style="color: #268bd2;">(</span>cons
                    <span style="color: #6c71c4;">(</span>car exp<span style="color: #6c71c4;">)</span>
                    <span style="color: #6c71c4;">(</span>shuffle <span style="color: #859900;">(</span>amb/choices exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb11fd06" class="outline-3">
<h3 id="orgb11fd06">Exercise 4.51</h3>
<div class="outline-text-3" id="text-orgb11fd06">
<blockquote>
<p>
Implement a new kind of assignment called permanent-set!
that is not undone upon failure. For example, we can choose
two distinct elements from a list and count the number of
trials required to make a successful choice as follows:
</p>

<p>
(define count 0)
(let ((x (an-element-of '(a b c)))
(y (an-element-of '(a b c))))
(permanent-set! count (+ count 1))
(require (not (eq? x y)))
(list x y count))
</p>

<p>
;;; Starting a new problem
;;; Amb-Eval value:
(a b 2)
</p>

<p>
;;; Amb-Eval input:
try-again
</p>

<p>
;;; Amb-Eval value:
(a c 3)
</p>

<p>
What values would have been displayed if we had used set!
here rather than permanent-set!? 
</p>
</blockquote>
</div>
<div id="outline-container-orga2769e7" class="outline-4">
<h4 id="orga2769e7">Answer</h4>
<div class="outline-text-4" id="text-orga2769e7">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>append! primitive-procedures `<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>shuffle ,shuffle<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">amb/analyze-permanent-assignment</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #2aa198;">"The execution procedure for permanent assignment is essentially a</span>
<span style="color: #2aa198;">redaction of the components of `analyze-assignment' that restore the value</span>
<span style="color: #2aa198;">of the old variable proceeding from a failed assignment"</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>var <span style="color: #859900;">(</span>definition-variable exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span>
        <span style="color: #6c71c4;">(</span>vproc <span style="color: #859900;">(</span>amb/analyze <span style="color: #b58900;">(</span>definition-value exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #6c71c4;">(</span>env succeed fail<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>vproc
       env
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>val fail2<span style="color: #b58900;">)</span>
         <span style="color: #b58900;">(</span>set-variable-value! var val env<span style="color: #b58900;">)</span>
         <span style="color: #b58900;">(</span>succeed
          'ok
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">a failure continues without restoring the old value</span>
          <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">()</span> <span style="color: #6c71c4;">(</span>fail2<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
       fail<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/install-procedure `<span style="color: #b58900;">(</span>permanent-set! ,amb/analyze-permanent-assignment<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/infuse
 '<span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">(</span><span style="color: #268bd2;">cps</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">count</span> <span style="color: #6c71c4;">0</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">(</span>x <span style="color: #b58900;">(</span>car <span style="color: #268bd2;">(</span>amb '<span style="color: #6c71c4;">(</span>a b c<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>y <span style="color: #b58900;">(</span>car <span style="color: #268bd2;">(</span>amb '<span style="color: #6c71c4;">(</span>z b c<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>permanent-set! count <span style="color: #859900;">(</span>+ count <span style="color: #6c71c4;">1</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>require <span style="color: #859900;">(</span>not <span style="color: #b58900;">(</span>eq? x y<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>list x y count<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga687d26" class="outline-3">
<h3 id="orga687d26">Exercise 4.52</h3>
<div class="outline-text-3" id="text-orga687d26">
<blockquote>
<p>
Implement a new construct called `if-fail' that permits the
user to catch the failure of an expression. `if-fail' takes
two expressions. It evaluates the first expression as usual
and returns as usual if the evaluation succeeds. If the
evaluation fails, however, the value of the second
expression is returned, as in the following example:
</p>

<p>
;;; Amb-Eval input:
(if-fail
(let ((x (an-element-of '(1 3 5))))
(require (even? x))
x)
'all-odd)
</p>

<p>
;;; Starting a new problem
;;; Amb-Eval value:
all-odd
</p>

<p>
;;; Amb-Eval input:
(if-fail
(let ((x (an-element-of '(1 3 5 8))))
(require (even? x))
x)
'all-odd)
</p>

<p>
;;; Starting a new problem
;;; Amb-Eval value:
8                 
</p>
</blockquote>
<p>
<b>*</b> Answer
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">amb/analyze-if-fail</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>clause      <span style="color: #859900;">(</span>amb/analyze <span style="color: #b58900;">(</span>cadr exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span>alternative <span style="color: #859900;">(</span>caddr exp<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>env succeed fail<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>clause env
              <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">success, just suplly the result</span>
              <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>value fail2<span style="color: #b58900;">)</span> <span style="color: #b58900;">(</span>succeed value fail2<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
              <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">fail, send our alternative</span>
              <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">()</span> <span style="color: #b58900;">(</span>succeed alternative fail<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>amb/install-procedure `<span style="color: #b58900;">(</span>if-fail ,amb/analyze-if-fail<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgaa6f034" class="outline-3">
<h3 id="orgaa6f034">Exercise 4.53</h3>
<div class="outline-text-3" id="text-orgaa6f034">
<blockquote>
<p>
With `permanent-set!' as described in *Note4.51 and
`if-fail' as in *Note Exercise 4.52, what will be the result
of evaluating
</p>

<p>
(let ((pairs '()))
(if-fail (let ((p (prime-sum-pair '(1 3 5 8) '(20 35 110))))
(permanent-set! pairs (cons p pairs))
(amb))
pairs))
</p>
</blockquote>
</div>
<div id="outline-container-orgc677388" class="outline-4">
<h4 id="orgc677388">Answer</h4>
<div class="outline-text-4" id="text-orgc677388">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">It prints:</span>

<span style="color: #93a1a1;">((8 35) (3 110) (3 20))</span>

<span style="color: #93a1a1;">Although the let form always fails (it calls (amb) as its</span>
<span style="color: #93a1a1;">last statement), the pairs get added into pairs, because</span>
<span style="color: #93a1a1;">permanent-set! doesn&#8217;t roll assignments back from failed</span>
<span style="color: #93a1a1;">paths. |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7f9f8a7" class="outline-3">
<h3 id="org7f9f8a7">Exercise 4.54</h3>
<div class="outline-text-3" id="text-org7f9f8a7">
<blockquote>
<p>

</p>

<p>
If we had not realized that require could be implemented as an ordinary
procedure that uses `amb', to be defined by the user as part of a
nondeterministic program, we would have had to implement it as a special
form. This would require syntax procedures
</p>

<p>
(define (require? exp)
(tagged-list? exp 'require))
</p>

<p>
(define (require-predicate exp)
(cadr exp))
</p>

<p>
and a new clause in the dispatch in analyze
</p>

<p>
((require? exp) (analyze-require exp))
</p>

<p>
as well the procedure analyze-require that handles require expressions.
Complete the following definition of analyze-require.
</p>

<p>
(define (analyze-require exp)
(let ((pproc (analyze
(require-predicate exp))))
(lambda (env succeed fail)
(pproc env
(lambda (pred-value fail2)
(if ⟨??⟩
⟨??⟩
(succeed 'ok fail2)))
fail)))) 
</p>
</blockquote>
</div>
<div id="outline-container-orgf48180c" class="outline-4">
<h4 id="orgf48180c">Answer</h4>
<div class="outline-text-4" id="text-orgf48180c">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">require-predicate</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>cadr exp<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">amb/analyze-require</span> exp<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">[</span>pproc <span style="color: #859900;">(</span>analyze <span style="color: #b58900;">(</span>require-predicate exp<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">]</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>env succeed fail<span style="color: #6c71c4;">)</span>
      <span style="color: #6c71c4;">(</span>pproc
       env
       <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>value fail2<span style="color: #b58900;">)</span>
         <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>not <span style="color: #6c71c4;">(</span>true? value<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
             <span style="color: #268bd2;">(</span>fail<span style="color: #268bd2;">)</span>
             <span style="color: #268bd2;">(</span>succeed 'ok fail2<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
      fail<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgdbec92e" class="outline-3">
<h3 id="orgdbec92e">Exercise 4.55</h3>
<div class="outline-text-3" id="text-orgdbec92e">
<blockquote>
<p>
Give simple queries that retrieve the following information from the data
base:
</p>

<ul class="org-ul">
<li>all people supervised by Ben Bitdiddle;</li>
<li>the names and jobs of all people in the accounting division;</li>
<li>the names and addresses of all people who live in Slumerville.</li>
</ul>
</blockquote>
</div>
<div id="outline-container-org179f850" class="outline-4">
<h4 id="org179f850">Answer</h4>
<div class="outline-text-4" id="text-org179f850">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">Respectively:</span>

<span style="color: #93a1a1;">- (supervisor ?x (Bitdiddle Ben))</span>
<span style="color: #93a1a1;">- (job ?name (accounting . ?other))</span>
<span style="color: #93a1a1;">- (address ?name (Slumerville . ?rest))</span>
<span style="color: #93a1a1;">|#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga0e07a0" class="outline-3">
<h3 id="orga0e07a0">Exercise 4.56</h3>
<div class="outline-text-3" id="text-orga0e07a0">
<blockquote>
<p>
Formulate compound queries that retrieve the following information:
</p>

<p>
a. the names of all people who are supervised by Ben Bitdiddle,
together with their addresses;
</p>

<p>
b. all people whose salary is less than Ben Bitdiddle's,
together with their salary and Ben Bitdiddle's salary;
</p>

<p>
c. all people who are supervised by someone who is not in the
computer division, together with the supervisor's name and
job. 
</p>
</blockquote>
</div>
<div id="outline-container-org3c6a5aa" class="outline-4">
<h4 id="org3c6a5aa">Answer</h4>
<div class="outline-text-4" id="text-org3c6a5aa">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solutions:</span>
<span style="color: #93a1a1;">a. (and (supervisor ?name (Bitdiddle Ben))</span>
<span style="color: #93a1a1;">(address ?name . ?rest))</span>

<span style="color: #93a1a1;">b. (and (salary ?person ?salary)</span>
<span style="color: #93a1a1;">(salary (Bitdiddle Ben) ?ben-salary)</span>
<span style="color: #93a1a1;">(lisp-value &gt; ?salary ?ben-salary))</span>

<span style="color: #93a1a1;">c. (and (supervisor ?supervisor ?supervisee)</span>
<span style="color: #93a1a1;">(job ?supervisor ?job))</span>
<span style="color: #93a1a1;">|#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgaa1a9bd" class="outline-3">
<h3 id="orgaa1a9bd">Exercise 4.57</h3>
<div class="outline-text-3" id="text-orgaa1a9bd">
<blockquote>
<p>
Define a rule that says that person 1 can replace person 2 if either person
1 does the same job as person 2 or someone who does person 1’s job can also
do person 2’s job, and if person 1 and person 2 are not the same person.
Using your rule, give queries that find the following:
</p>

<ul class="org-ul">
<li>all people who can replace Cy D. Fect;</li>
<li>all people who can replace someone who is being paid more than they are,
together with the two salaries.</li>
</ul>
</blockquote>
<p>
<b>*</b> Answer
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>replaceable ?p1 ?p2<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">or</span> <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #b58900;">(</span>job ?p1 ?p1post<span style="color: #b58900;">)</span>
                      <span style="color: #b58900;">(</span>job ?p2 ?p1post<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
                 <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #b58900;">(</span>job ?p1 ?p1post<span style="color: #b58900;">)</span>
                      <span style="color: #b58900;">(</span>job ?p2 ?p2post<span style="color: #b58900;">)</span>
                      <span style="color: #b58900;">(</span>can-do-job ?p1post ?p2post<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
             <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>same ?p1 ?p2<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">- all people who can replace Cy D. Fect</span>
<span style="color: #93a1a1;">=&gt; (replaceable ?t (Fect Cy D))</span>
<span style="color: #93a1a1;">- all people who can replace someone who is being paid more than they are,</span>
<span style="color: #93a1a1;">together with the two salaries.</span>
<span style="color: #93a1a1;">=&gt; (and (replaceable ?p1 ?p2)</span>
<span style="color: #93a1a1;">(salary ?p1 ?s1)</span>
<span style="color: #93a1a1;">(salary ?p2 ?s2)</span>
<span style="color: #93a1a1;">(lisp-value &gt; ?s2 ?s1))</span>

<span style="color: #93a1a1;">|#</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org0b31f7c" class="outline-3">
<h3 id="org0b31f7c">Exercise 4.58</h3>
<div class="outline-text-3" id="text-org0b31f7c">
<blockquote>
<p>
Define a rule that says that a person is a "big shot" in a division if the
person works in the division but does not have a supervisor who works in
the division. 
</p>
</blockquote>
</div>
<div id="outline-container-orgb48ac72" class="outline-4">
<h4 id="orgb48ac72">Answer</h4>
<div class="outline-text-4" id="text-orgb48ac72">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>big-shot ?p1<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span>
         <span style="color: #6c71c4;">(</span>job ?p1 <span style="color: #859900;">(</span>?dept . ?job<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">or</span>
          <span style="color: #859900;">(</span>not <span style="color: #b58900;">(</span>supervisor ?p1 ?p2<span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #b58900;">(</span>supervisor ?p1 ?p2<span style="color: #b58900;">)</span>
               <span style="color: #b58900;">(</span>not <span style="color: #268bd2;">(</span>job ?p2 <span style="color: #6c71c4;">(</span>?dept . ?job2<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd35e277" class="outline-3">
<h3 id="orgd35e277">Exercise 4.59</h3>
<div class="outline-text-3" id="text-orgd35e277">
<blockquote>
<p>
Ben Bitdiddle has missed one meeting too many. Fearing that his habit of
forgetting meetings could cost him his job, Ben decides to do something
about it. He adds all the weekly meetings of the firm to the Microshaft
data base by asserting the following:
</p>
</blockquote>
</div>
<div id="outline-container-org23529f1" class="outline-4">
<h4 id="org23529f1">Answer</h4>
<div class="outline-text-4" id="text-org23529f1">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> query/infuse
     '<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>meeting accounting <span style="color: #6c71c4;">(</span>Monday 9am<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>meeting administration <span style="color: #6c71c4;">(</span>Monday 10am<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>meeting computer <span style="color: #6c71c4;">(</span>Wednesday 3pm<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>meeting administration <span style="color: #6c71c4;">(</span>Friday 1pm<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">#|</span>
<span style="color: #93a1a1;">Each of the above assertions is for a meeting of an entire division.</span>
<span style="color: #93a1a1;">Ben also adds an entry for the company-wide meeting that spans all the</span>
<span style="color: #93a1a1;">divisions. All of the company's employees attend this meeting.</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #2aa198;">(</span>query/infuse '<span style="color: #b58900;">(</span>meeting whole-company <span style="color: #268bd2;">(</span>Wednesday 4pm<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">#|</span>

<span style="color: #93a1a1;">a. On Friday morning, Ben wants to query the data base for all the meetings</span>
<span style="color: #93a1a1;">that occur that day. What query should he use?</span>

<span style="color: #93a1a1;">b. Alyssa P. Hacker is unimpressed. She thinks it would be much more useful</span>
<span style="color: #93a1a1;">to be able to ask for her meetings by specifying her name. So she designs a</span>
<span style="color: #93a1a1;">rule that says that a person's meetings include all `whole-company'</span>
<span style="color: #93a1a1;">meetings plus all meetings of that person's division. Fill in the body of</span>
<span style="color: #93a1a1;">Alyssa's rule.</span>

<span style="color: #93a1a1;">(rule (meeting-time ?person ?day-and-time)</span>
<span style="color: #93a1a1;">&lt;RULE-BODY&gt;)</span>

<span style="color: #93a1a1;">c. Alyssa arrives at work on Wednesday morning and wonders what meetings</span>
<span style="color: #93a1a1;">she has to attend that day. Having defined the above rule, what query</span>
<span style="color: #93a1a1;">should she make to find this out?</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solutions:</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">a. (meeting ?meeting (Friday ?time))</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">b.</span>
<span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>meeting-time ?person ?day-and-time<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">or</span>
         <span style="color: #6c71c4;">(</span>meeting whole-company ?day-and-time<span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">and</span>
          <span style="color: #859900;">(</span>meeting ?division ?day-and-time<span style="color: #859900;">)</span>
          <span style="color: #859900;">(</span>job ?person <span style="color: #b58900;">(</span>?division . ?job<span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">c. (meeting-time (Hacker Alyssa P) (Wednesday . ?x))</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1b9117a" class="outline-3">
<h3 id="org1b9117a">Exercise 4.60</h3>
<div class="outline-text-3" id="text-org1b9117a">
<blockquote>
<p>
By giving the query
</p>

<p>
(lives-near ?person (Hacker Alyssa P))
</p>

<p>
Alyssa P. Hacker is able to find people who live near her, with
whom she can ride to work.  On the other hand, when she tries to
find all pairs of people who live near each other by querying
</p>

<p>
(lives-near ?person-1 ?person-2)
</p>

<p>
she notices that each pair of people who live near each other is
listed twice; for example,
</p>

<p>
(lives-near (Hacker Alyssa P) (Fect Cy D))
(lives-near (Fect Cy D) (Hacker Alyssa P))
</p>

<p>
Why does this happen?  Is there a way to find a list of people who
live near each other, in which each pair appears only once?
Explain. 
</p>
</blockquote>
</div>
<div id="outline-container-orgee9a530" class="outline-4">
<h4 id="orgee9a530">Answer</h4>
<div class="outline-text-4" id="text-orgee9a530">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">The reason this occurs it that there is no 'ordering' on the results</span>
<span style="color: #93a1a1;">returned, e.g (Dewitt) (Louis) is equally valid to (Louis) (Dewitt) when</span>
<span style="color: #93a1a1;">the query analyzer searches through valid responses.</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>lives-near-only ?person-1 ?person-2<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span>
         <span style="color: #6c71c4;">(</span>address ?person-1 <span style="color: #859900;">(</span>?town . ?rest-1<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>address ?person-2 <span style="color: #859900;">(</span>?town . ?rest-2<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>not <span style="color: #859900;">(</span>same ?person-1 ?person-2<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
         <span style="color: #6c71c4;">(</span>lisp-value <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">lambda</span> <span style="color: #b58900;">(</span>x y<span style="color: #b58900;">)</span>
                       <span style="color: #b58900;">(</span>string&lt;=? <span style="color: #268bd2;">(</span>symbol-&gt;string <span style="color: #6c71c4;">(</span>car x<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
                                  <span style="color: #268bd2;">(</span>symbol-&gt;string <span style="color: #6c71c4;">(</span>car y<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span> ?person-1 ?person-2<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org21e4c19" class="outline-3">
<h3 id="org21e4c19">Exercise 4.61</h3>
<div class="outline-text-3" id="text-org21e4c19">
<blockquote>
<p>
The following rules implement a `next-to' relation that finds adjacent
elements of a list:
</p>

<p>
(rule (?x next-to ?y in (?x ?y . ?u)))
</p>

<p>
(rule (?x next-to ?y in (?v . ?z))
(?x next-to ?y in ?z))
</p>

<p>
What will the response be to the following queries?
</p>

<p>
(?x next-to ?y in (1 (2 3) 4))
</p>

<p>
(?x next-to 1 in (2 1 3 1))
</p>
</blockquote>
</div>
<div id="outline-container-org03846df" class="outline-4">
<h4 id="org03846df">Answer</h4>
<div class="outline-text-4" id="text-org03846df">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solution:</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">The rules written as-is are incompatible with the existing system, a s, I've resolved them in the following way:</span>

<span style="color: #2aa198;">(</span>query/infuse '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>next-to ?x ?y in <span style="color: #6c71c4;">(</span>?x ?y . ?u<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span>query/infuse '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>next-to ?x ?y in <span style="color: #6c71c4;">(</span>?v . ?z<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
                     <span style="color: #268bd2;">(</span>next-to ?x ?y in ?z<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">(next-to ?x ?y in (1 (2 3) 4)) =&gt; ((1 (2 3) 4) ((2 3) 4))</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">(next-to ?x 1 in (2 1 3 1)) =&gt; ((3 1)  (2 1))</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgea1e9e5" class="outline-3">
<h3 id="orgea1e9e5">Exercise 4.62</h3>
<div class="outline-text-3" id="text-orgea1e9e5">
<blockquote>
<p>
Define rules to implement the `last-pair' operation of *Note Exercise 2-17,
which returns a list containing the last element of a nonempty list. Check
your rules on queries such as `(last-pair (3) ?x)', `(last-pair (1 2 3)
?x)', and `(last-pair (2 ?x) (3))'. Do your rules work correctly on queries
such as `(last-pair ?x (3))' ? 
</p>
</blockquote>
</div>
<div id="outline-container-org633283d" class="outline-4">
<h4 id="org633283d">Answer</h4>
<div class="outline-text-4" id="text-org633283d">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Solution, it does not work correctly on results that yield an infinite</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">nubmer of answers;</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> query/infuse
     '<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>last-pair <span style="color: #859900;">(</span>?h<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>?h<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>last-pair <span style="color: #859900;">(</span>?h . ?t<span style="color: #859900;">)</span> ?last<span style="color: #6c71c4;">)</span>
             <span style="color: #6c71c4;">(</span>last-pair ?t ?last<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org5188c77" class="outline-3">
<h3 id="org5188c77">Exercise 4.63</h3>
<div class="outline-text-3" id="text-org5188c77">
<blockquote>
<p>
The following data base (see Genesis 4) traces the genealogy of the
descendants of Ada back to Adam, by way of Cain:
</p>
</blockquote>
</div>
<div id="outline-container-org411690f" class="outline-4">
<h4 id="org411690f">Answer</h4>
<div class="outline-text-4" id="text-org411690f">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> query/infuse
     '<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>son Adam Cain<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Cain Enoch<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Enoch Irad<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Irad Mehujael<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Mehujael Methushael<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Methushael Lamech<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>wife Lamech Ada<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Ada Jabal<span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>son Ada Jubal<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">#|</span>
<span style="color: #93a1a1;">Formulate rules such as</span>

<span style="color: #93a1a1;">"If S is the son of f, and f is the son of</span>
<span style="color: #93a1a1;">G, then S is the grandson of G" and "If W is the wife of M, and S</span>
<span style="color: #93a1a1;">is the son of W, then S is the son of M"</span>

<span style="color: #93a1a1;">(which was supposedly more true in biblical times than today) that will</span>
<span style="color: #93a1a1;">enable the query system to find the grandson of Cain; the sons of Lamech;</span>
<span style="color: #93a1a1;">the grandsons of Methushael. (See *Note Exercise 4-69 for some rules to</span>
<span style="color: #93a1a1;">deduce more complicated relationships.)</span>
<span style="color: #93a1a1;">|#</span>

<span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>grandparent ?g ?f ?s<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span>son ?g ?f<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>son ?f ?s<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>query/infuse
 '<span style="color: #b58900;">(</span>rule <span style="color: #268bd2;">(</span>son-of ?w ?m ?s<span style="color: #268bd2;">)</span>
        <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">and</span> <span style="color: #6c71c4;">(</span>wife ?m ?w<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>son ?w ?s<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf7ec3d2" class="outline-3">
<h3 id="orgf7ec3d2">Exercise 4.64</h3>
<div class="outline-text-3" id="text-orgf7ec3d2">
<blockquote>
<p>
Louis Reasoner mistakenly deletes the `outranked-by' rule
(section *Note 4.4.1) from the data base. When he realizes this,
he quickly reinstalls it. Unfortunately, he makes a slight change
in the rule, and types it in as
</p>
</blockquote>
</div>
<div id="outline-container-orga33ed47" class="outline-4">
<h4 id="orga33ed47">Answer</h4>
<div class="outline-text-4" id="text-orga33ed47">
<p>
#+begin<sub>src</sub> scheme
(query/infuse '(rule (loop-outranked-by ?staff-person ?boss)
(or (supervisor ?staff-person ?boss)
(and (outranked-by ?middle-manager ?boss)
(supervisor ?staff-person ?middle-manager)))))
#|
</p>

<p>
Just after Louis types this information into the system, DeWitt
Aull comes by to find out who outranks Ben Bitdiddle. He issues
the query
</p>

<p>
(outranked-by (Bitdiddle Ben) ?who)
</p>

<p>
After answering, the system goes into an infinite loop.  Explain
why. |#
</p>

<p>
#| Solution:
</p>

<p>
The problem with this query is the order in which applicable rules are
specified.
</p>
</div>
</div>
</div>
</section>

<section id="outline-container-org71cb025" class="outline-2">
<h2 id="org71cb025">After finding the previous `supervisor' rule applied; that is, the</h2>
<div class="outline-text-2" id="text-org71cb025">
<p>
rule conclusion `(supervisor (Bitdiddle Ben) ?boss)' successfully
unifies with the query pattern `(supervisor ?staff-person ?boss)' to
produce a frame in which `?boss' is bound to `?who'. The interpreter
proceeds to evaluate the next rule: `(outranked-by ?middle-manager
?boss)' in the same frame.
</p>
</div>
</section>

<section id="outline-container-org940e97d" class="outline-2">
<h2 id="org940e97d">One answer appears in the database.</h2>
</section>

<section id="outline-container-orgf0f8eac" class="outline-2">
<h2 id="orgf0f8eac">The `outranked-by' rule is also applicable, so the evaluator again</h2>
<div class="outline-text-2" id="text-orgf0f8eac">
<p>
evaluators the `outranked-by' rule body which is equivalent to
`(outranked-by ?middle-manager ?who)' |#
#+end<sub>src</sub>
</p>
</div>
<div id="outline-container-org268b594" class="outline-3">
<h3 id="org268b594">Exercise 4.65</h3>
<div class="outline-text-3" id="text-org268b594">
<blockquote>
<p>
Cy D. Fect, looking forward to the day when he will rise in the
organization, gives a query to find all the wheels
(using the `wheel' rule of section *Note 4-4-1)
</p>

<p>
(wheel ?who)
</p>

<p>
To his surprise, the system responds
</p>

<p>
;;; Query results:
(wheel (Warbucks Oliver))
(wheel (Bitdiddle Ben))
(wheel (Warbucks Oliver))
(wheel (Warbucks Oliver))
(wheel (Warbucks Oliver))
</p>

<p>
Why is Oliver Warbucks listed four times? 
</p>
</blockquote>
</div>
<div id="outline-container-org53435fb" class="outline-4">
<h4 id="org53435fb">Answer</h4>
<div class="outline-text-4" id="text-org53435fb">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>

<span style="color: #93a1a1;">The body of `wheel' contains a query pattern</span>
<span style="color: #93a1a1;">`(supervisor ?x ?middle-manager)' that can be satisfied by a</span>
<span style="color: #93a1a1;">variety of different values, each of those values contributes</span>
<span style="color: #93a1a1;">a match to the rule |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org634e671" class="outline-3">
<h3 id="org634e671">Exercise 4.66</h3>
<div class="outline-text-3" id="text-org634e671">
<blockquote>
<p>
Ben has been generalizing the query system to provide statistics about
the company. For example, to find the total salaries of all the
computer programmers one will be able to say
</p>

<p>
(sum ?amount
(and (job ?x (computer programmer))
(salary ?x ?amount)))
</p>

<p>
In general, Ben's new system allows expressions of the form
</p>

<p>
(accumulation-function &lt;VARIABLE&gt;
&lt;QUERY PATTERN&gt;)
</p>

<p>
where `accumulation-function' can be things like `sum', `average', or
`maximum'. Ben reasons that it should be a cinch to implement this. He
will simply feed the query pattern to `qeval'. This will produce a
stream of frames. He will then pass this stream through a mapping
function that extracts the value of the designated variable from each
frame in the stream and feed the resulting stream of values to the
accumulation function. Just as Ben completes the implementation and is
about to try it out, Cy walks by, still puzzling over the `wheel'
query result in exercise *Note Exercise 4-65. When Cy shows Ben the
system's response, Ben groans, "Oh, no, my simple accumulation scheme
won't work!"
</p>

<p>
What has Ben just realized? Outline a method he can use to salvage the
situation. 
</p>
</blockquote>
</div>
<div id="outline-container-orgc41a356" class="outline-4">
<h4 id="orgc41a356">Answer</h4>
<div class="outline-text-4" id="text-orgc41a356">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution</span>
<span style="color: #93a1a1;">Although the query supplied doesn't demonstrate it, it is possible to</span>
<span style="color: #93a1a1;">have multiple frames returns. |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgcb96a4a" class="outline-3">
<h3 id="orgcb96a4a">Exercise 4.67</h3>
<div class="outline-text-3" id="text-orgcb96a4a">
<blockquote>
<p>
Devise a way to install a loop detector in the query system so as to
avoid the kinds of simple loops illustrated in the text and in *NoteExercise 4.64.
</p>

<p>
The general idea is that the system should maintain some sort of
history of its current chain of deductions and should not begin
processing a query that it is already working on. Describe what kind
of information (patterns and frames) is included in this history, and
how the check should be made. (After you study the details of the
query-system implementation in section *Note 4.4.4, you may want to
modify the system to include your loop detector.) 
</p>
</blockquote>
</div>
<div id="outline-container-orgc0fd490" class="outline-4">
<h4 id="orgc0fd490">Answer</h4>
<div class="outline-text-4" id="text-orgc0fd490">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Because the rule variable contains the execution information, we can</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">lookup if a rule with the exact same parameters has been called before.</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #268bd2;">executed-rules</span> '<span style="color: #b58900;">()</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">previously-executed?</span> rule<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>member rule executed-rules<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">add-executed-rule!</span> rule<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> executed-rules <span style="color: #268bd2;">(</span>cons rule executed-rules<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">noloop/apply-a-rule</span> rule query-pattern query-frame<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>previously-executed? rule<span style="color: #268bd2;">)</span> stream-null
      <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">let*</span> <span style="color: #6c71c4;">(</span><span style="color: #859900;">[</span>clean-rule <span style="color: #b58900;">(</span>rename-variables-in rule<span style="color: #b58900;">)</span><span style="color: #859900;">]</span> <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">alpha-conversion</span>
             <span style="color: #859900;">[</span>unify-result <span style="color: #b58900;">(</span>unify-match query-pattern
                                        <span style="color: #268bd2;">(</span>conclusion clean-rule<span style="color: #268bd2;">)</span>
                                        query-frame<span style="color: #b58900;">)</span><span style="color: #859900;">]</span><span style="color: #6c71c4;">)</span>
        <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900;">(</span>eq? unify-result 'failed<span style="color: #859900;">)</span> stream-null
            <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">begin</span>
              <span style="color: #b58900;">(</span>add-executed-rule! rule<span style="color: #b58900;">)</span>
              <span style="color: #b58900;">(</span>qeval <span style="color: #268bd2;">(</span>rule-body clean-rule<span style="color: #268bd2;">)</span>
                     <span style="color: #268bd2;">(</span>singleton-stream
                      unify-result<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">The following are just driver extensions to permit for `noloop' to work</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">noloop/query-driver-loop</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> executed-rules '<span style="color: #268bd2;">()</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> apply-a-rule noloop/apply-a-rule<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span>query-driver-loop<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">define</span> <span style="color: #b58900;">(</span><span style="color: #268bd2;">noloop/query/eval</span> expr<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> executed-rules '<span style="color: #268bd2;">()</span><span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">set!</span> apply-a-rule noloop/apply-a-rule<span style="color: #b58900;">)</span>
  <span style="color: #b58900;">(</span><span style="color: #859900; font-weight: bold;">let</span> <span style="color: #268bd2;">(</span><span style="color: #6c71c4;">(</span>q <span style="color: #859900;">(</span>query-syntax-process expr<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
    <span style="color: #268bd2;">(</span>stream-&gt;list
     <span style="color: #6c71c4;">(</span>stream-map
      <span style="color: #859900;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #b58900;">(</span>frame<span style="color: #b58900;">)</span>
        <span style="color: #b58900;">(</span>instantiate q frame <span style="color: #268bd2;">(</span><span style="color: #859900; font-weight: bold;">&#955;</span> <span style="color: #6c71c4;">(</span>v f<span style="color: #6c71c4;">)</span> <span style="color: #6c71c4;">(</span>contract-question-mark v<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span>
      <span style="color: #859900;">(</span>qeval q <span style="color: #b58900;">(</span>singleton-stream '<span style="color: #268bd2;">()</span><span style="color: #b58900;">)</span><span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span>install-driver-loop 'qeval-noloop noloop/query-driver-loop<span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1a746b1" class="outline-3">
<h3 id="org1a746b1">Exercise 4.68</h3>
<div class="outline-text-3" id="text-org1a746b1">
<blockquote>
<p>
Define rules to implement the `reverse' operation of *Note Exercise 2-18,
which returns a list containing the same elements as a given list in
reverse order. (Hint: Use `append-to-form'.) Can your rules answer both
`(reverse (1 2 3) ?x)' and `(reverse ?x (1 2 3))' ? 
</p>
</blockquote>
</div>
<div id="outline-container-org417ac9f" class="outline-4">
<h4 id="org417ac9f">Answer</h4>
<div class="outline-text-4" id="text-org417ac9f">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">This is one solution that doesn't use append-to-form, but doesn't</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">generate proper lists</span>
<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> query/infuse
     '<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>bad-reverse <span style="color: #859900;">()</span> <span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>bad-reverse <span style="color: #859900;">(</span>?car . ?cdr<span style="color: #859900;">)</span> <span style="color: #859900;">(</span>?cdr1 . ?car<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span>
             <span style="color: #6c71c4;">(</span>bad-reverse ?cdr ?cdr1<span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">map</span> query/infuse
     '<span style="color: #b58900;">(</span><span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>reverse <span style="color: #859900;">()</span> <span style="color: #859900;">()</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span>
       <span style="color: #268bd2;">(</span>rule <span style="color: #6c71c4;">(</span>reverse ?x ?y<span style="color: #6c71c4;">)</span>
             <span style="color: #6c71c4;">(</span><span style="color: #859900; font-weight: bold;">and</span>
              <span style="color: #859900;">(</span>append-to-form <span style="color: #b58900;">(</span>?car<span style="color: #b58900;">)</span> ?rest ?x<span style="color: #859900;">)</span>
              <span style="color: #859900;">(</span>append-to-form ?rev <span style="color: #b58900;">(</span>?car<span style="color: #b58900;">)</span> ?y<span style="color: #859900;">)</span>
              <span style="color: #859900;">(</span>reverse ?rest ?rev<span style="color: #859900;">)</span><span style="color: #6c71c4;">)</span><span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgbd38d9f" class="outline-3">
<h3 id="orgbd38d9f">Exercise 4.69</h3>
<div class="outline-text-3" id="text-orgbd38d9f">
<blockquote>
<p>
Beginning with the data base and the rules you formulated in Exercise 4.63,
devise a rule for adding “greats” to a grandson relationship. This should
enable the system to deduce that Irad is the great-grandson of Adam, or
that Jabal and Jubal are the great-great-great-great-great-grandsons of
Adam. (Hint: Represent the fact about Irad, for example, as ((great
grandson) Adam Irad). Write rules that determine if a list ends in the word
grandson. Use this to express a rule that allows one to derive the
relationship ((great . ?rel) ?x ?y), where ?rel is a list ending in
grandson.) Check your rules on queries such as ((great grandson) ?g ?ggs)
and (?relationship Adam Irad). 
</p>
</blockquote>
</div>
<div id="outline-container-orgf32ba0f" class="outline-4">
<h4 id="orgf32ba0f">Answer</h4>
<div class="outline-text-4" id="text-orgf32ba0f">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#|</span>
<span style="color: #93a1a1;">I cannot find a solution to this</span>
<span style="color: #93a1a1;">|#</span>


</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgbb0abc4" class="outline-3">
<h3 id="orgbb0abc4">Exercise 4.70</h3>
<div class="outline-text-3" id="text-orgbb0abc4">
<blockquote>
<p>
What is the purpose of the `let' bindings in the procedures
`add-assertion!' and `add-rule!' ? What would be wrong with the following
implementation of `add-assertion!' ? Hint: Recall the definition of the
infinite stream of ones in section *Note 3.5.2: `(define ones (cons-stream 1 ones))'.
</p>

<p>
(define (add-assertion! assertion)
(store-assertion-in-index assertion)
(set! THE-ASSERTIONS
(cons-stream assertion THE-ASSERTIONS))
'ok) 
</p>
</blockquote>
<p>
<b>*</b> Answer
</p>
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution is non-indexable |#</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org5603ade" class="outline-3">
<h3 id="org5603ade">Exercise 4.71</h3>
<div class="outline-text-3" id="text-org5603ade">
<blockquote>
<p>
Louis Reasoner wonders why the simple-query and disjoin procedures
(4.4.4.2) are implemented using explicit delay operations, rather than
being defined as follows:
</p>

<p>
(define (simple-query query-pattern frame-stream)
(stream-flatmap
(lambda (frame)
(stream-append
(find-assertions query-pattern frame)
(apply-rules query-pattern frame)))
frame-stream))
</p>

<p>
(define (disjoin disjuncts frame-stream)
(if (empty-disjunction? disjuncts)
the-empty-stream
(interleave
(qeval (first-disjunct disjuncts)
frame-stream)
(disjoin (rest-disjuncts disjuncts)
frame-stream))))
</p>

<p>
Can you give examples of queries where these simpler definitions would lead
to undesirable behavior? 
</p>
</blockquote>
</div>
<div id="outline-container-org6f5413f" class="outline-4">
<h4 id="org6f5413f">Answer</h4>
<div class="outline-text-4" id="text-org6f5413f">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org699c1bd" class="outline-3">
<h3 id="org699c1bd">Exercise 4.72</h3>
<div class="outline-text-3" id="text-org699c1bd">
<blockquote>
<p>
Why do disjoin and stream-flatmap interleave the streams rather than simply
append them? Give examples that illustrate why interleaving works better.
(Hint: Why did we use interleave in 3.5.3?) 
</p>
</blockquote>
</div>
<div id="outline-container-orgfef9acf" class="outline-4">
<h4 id="orgfef9acf">Answer</h4>
<div class="outline-text-4" id="text-orgfef9acf">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">`interleave' provides a way to achieve 'diagonalization', that is to say so</span>
<span style="color: #93a1a1;">that every element in an infinite list can be reached, rather than focusing</span>
<span style="color: #93a1a1;">on either an input stream or a database |#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga097872" class="outline-3">
<h3 id="orga097872">Exercise 4.73</h3>
<div class="outline-text-3" id="text-orga097872">
<blockquote>
<p>
Why does flatten-stream use delay explicitly? What would be wrong with
defining it as follows:
</p>

<p>
(define (flatten-stream stream)
(if (stream-null? stream)
the-empty-stream
(interleave (stream-car stream)
(flatten-stream
(stream-cdr stream)))))
</p>
</blockquote>
</div>
<div id="outline-container-org63ce71c" class="outline-4">
<h4 id="org63ce71c">Answer</h4>
<div class="outline-text-4" id="text-org63ce71c">
<div class="org-src-container">
<pre class="src src-scheme">
<span style="color: #93a1a1;">#| Solution:</span>
<span style="color: #93a1a1;">Because it would loop forever - the evaluation strategy of a scheme</span>
<span style="color: #93a1a1;">interpreter dictates that arguments are passed in their 'fully evaluated'</span>
<span style="color: #93a1a1;">form.</span>
<span style="color: #93a1a1;">|#</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgcecc832" class="outline-3">
<h3 id="orgcecc832"><span class="todo TODO">TODO</span> Exercise 4.74</h3>
<div class="outline-text-3" id="text-orgcecc832">
<blockquote>
<p>
Alyssa P. Hacker proposes to use a simpler version of stream-flatmap in
negate, lisp-value, and find-assertions. She observes that the procedure
that is mapped over the frame stream in these cases always produces either
</p>
</blockquote>
</div>
<div id="outline-container-orgbdb0a9f" class="outline-4">
<h4 id="orgbdb0a9f">Answer</h4>
<div class="outline-text-4" id="text-orgbdb0a9f">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgd74fe78" class="outline-3">
<h3 id="orgd74fe78"><span class="todo TODO">TODO</span> Exercise 4.75</h3>
<div class="outline-text-3" id="text-orgd74fe78">
<blockquote>
<p>
Implement for the query language a new special form called `unique'.
`Unique' should succeed if there is precisely one item in the data base
satisfying a specified query. For example,
</p>

<p>
(unique (job ?x (computer wizard)))
</p>

<p>
should print the one-item stream
</p>

<p>
(unique (job (Bitdiddle Ben) (computer wizard)))
</p>

<p>
since Ben is the only computer wizard, and
</p>

<p>
(unique (job ?x (computer programmer)))
</p>

<p>
should print the empty stream, since there is more than one
computer programmer.  Moreover,
</p>

<p>
(and (job ?x ?j) (unique (job ?anyone ?j)))
</p>

<p>
should list all the jobs that are filled by only one person, and
the people who fill them.
</p>

<p>
There are two parts to implementing `unique'.  The first is to
write a procedure that handles this special form, and the second
is to make `qeval' dispatch to that procedure.  The second part is
trivial, since `qeval' does its dispatching in a data-directed
way.  If your procedure is called `uniquely-asserted', all you
need to do is
</p>

<p>
(put 'unique 'qeval uniquely-asserted)
</p>

<p>
and `qeval' will dispatch to this procedure for every query whose
`type' (`car') is the symbol `unique'.
</p>

<p>
The real problem is to write the procedure `uniquely-asserted'.
This should take as input the `contents' (`cdr') of the `unique'
query, together with a stream of frames.  For each frame in the
stream, it should use `qeval' to find the stream of all extensions
to the frame that satisfy the given query.  Any stream that does
not have exactly one item in it should be eliminated.  The
remaining streams should be passed back to be accumulated into one
big stream that is the result of the `unique' query.  This is
similar to the implementation of the `not' special form.
</p>

<p>
Test your implementation by forming a query that lists all people
who supervise precisely one person. 
</p>
</blockquote>
</div>
<div id="outline-container-orgbbd4c84" class="outline-4">
<h4 id="orgbbd4c84">Answer</h4>
<div class="outline-text-4" id="text-orgbbd4c84">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org0b12ba6" class="outline-3">
<h3 id="org0b12ba6"><span class="todo TODO">TODO</span> Exercise 4.76</h3>
<div class="outline-text-3" id="text-org0b12ba6">
<blockquote>
<p>
Our implementation of `and' as a series combination of queries
is elegant, but it is inefficient because in processing
the second query of the `and' we must scan the data
base for each frame produced by the first query.  If the data base
has n elements, and a typical query produces a number
of output frames proportional to n (say n/k),
then scanning the data base for each frame produced by the first
query will require n<sup>2</sup>/k calls to the pattern matcher.  Another
approach would be to process the two clauses of the `and'
separately, then look for all pairs of output frames that are
compatible.  If each query produces n/k output frames, then this
means that we must perform n<sup>2</sup>/k<sup>2</sup> compatibility checks&#x2013;a factor
of k fewer than the number of matches required in our current
method.
</p>

<p>
Devise an implementation of `and' that uses this strategy.  You
must implement a procedure that takes two frames as inputs, checks
whether the bindings in the frames are compatible, and, if so,
produces a frame that merges the two sets of bindings.  This
operation is similar to unification. 
</p>
</blockquote>
</div>
<div id="outline-container-orgc882b9d" class="outline-4">
<h4 id="orgc882b9d">Answer</h4>
<div class="outline-text-4" id="text-orgc882b9d">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc07364f" class="outline-3">
<h3 id="orgc07364f"><span class="todo TODO">TODO</span> Exercise 4.77</h3>
<div class="outline-text-3" id="text-orgc07364f">
<blockquote>
<p>
In section *Note 4-4-3:: we saw that `not' and
`lisp-value' can cause the query language to give "wrong" answers
if these filtering operations are applied to frames in which
variables are unbound.  Devise a way to fix this shortcoming.  One
idea is to perform the filtering in a "delayed" manner by
appending to the frame a "promise" to filter that is fulfilled
only when enough variables have been bound to make the operation
possible.  We could wait to perform filtering until all other
operations have been performed.  However, for efficiency's sake, we
would like to perform filtering as soon as possible so as to cut
down on the number of intermediate frames generated. 
</p>
</blockquote>
</div>
<div id="outline-container-org4ced723" class="outline-4">
<h4 id="org4ced723">Answer</h4>
<div class="outline-text-4" id="text-org4ced723">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3a7bdb3" class="outline-3">
<h3 id="org3a7bdb3"><span class="todo TODO">TODO</span> Exercise 4.78</h3>
<div class="outline-text-3" id="text-org3a7bdb3">
<blockquote>
<p>
Redesign the query language as a nondeterministic
program to be implemented using the evaluator of section *Note
4-3::, rather than as a stream process.  In this approach, each
query will produce a single answer (rather than the stream of all
answers) and the user can type `try-again' to see more answers.
You should find that much of the mechanism we built in this
section is subsumed by nondeterministic search and backtracking.
You will probably also find, however, that your new query language
has subtle differences in behavior from the one implemented here.
Can you find examples that illustrate this difference? 
</p>
</blockquote>
</div>
<div id="outline-container-org5dfab7a" class="outline-4">
<h4 id="org5dfab7a">Answer</h4>
<div class="outline-text-4" id="text-org5dfab7a">
<div class="org-src-container">
<pre class="src src-scheme">
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org08e639d" class="outline-3">
<h3 id="org08e639d"><span class="todo TODO">TODO</span> Exercise 4.79</h3>
<div class="outline-text-3" id="text-org08e639d">
<blockquote>
<p>
When we implemented the Lisp evaluator in section *Note 4-1, we
saw how to use local environments to avoid name conflicts between
the parameters of procedures. For example, in evaluating
</p>

<p>
(define (square x)
(* x x))
</p>

<p>
(define (sum-of-squares x y)
(+ (square x) (square y)))
</p>

<p>
(sum-of-squares 3 4)
</p>

<p>
there is no confusion between the `x' in `square' and the `x' in
`sum-of-squares', because we evaluate the body of each procedure
in an environment that is specially constructed to contain
bindings for the local variables.  In the query system, we used a
different strategy to avoid name conflicts in applying rules.
Each time we apply a rule we rename the variables with new names
that are guaranteed to be unique.  The analogous strategy for the
Lisp evaluator would be to do away with local environments and
simply rename the variables in the body of a procedure each time
we apply the procedure.
</p>

<p>
Implement for the query language a rule-application method that
uses environments rather than renaming.  See if you can build on
your environment structure to create constructs in the query
language for dealing with large systems, such as the rule analog
of block-structured procedures.  Can you relate any of this to the
problem of making deductions in a context (e.g., "If I supposed
that P were true, then I would be able to deduce A and B.") as a
method of problem solving?  (This problem is open-ended.  A good
answer is probably worth a Ph.D.) 
</p>
</blockquote>
</div>
</div>
</section>
