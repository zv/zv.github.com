---
layout: page
title: Printing job control messages for crashing programs
category: note
tags:
- post
- shell
- zshell
- zsh
---

<section id="outline-container-orgf76ea53" class="outline-2">
<h2 id="orgf76ea53"></h2>
<div class="outline-text-2" id="text-orgf76ea53">
<p>
If you write a zshell function for compiling &amp; running a piece of C code, you
might begin with this:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #006699;">compile_run</span> <span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
    <span style="color: #006FE0;">local</span> <span style="color: #BA36A5;">exepath</span>=<span style="color: #008000;">"$(</span><span style="color: #FF1493;">mktemp</span><span style="color: #008000;">)"</span>
    cc -g <span style="color: #008000;">"$1"</span> -o $<span style="color: #BA36A5;">exepath</span>
    <span style="color: #008000;">"$exepath"</span> <span style="color: #008000;">"$@"</span>
<span style="color: #707183;">}</span>
</pre>
</div>

<p>
Which works as expected for well-behaved programs:
</p>


<div id="orgf6b615f" class="figure">
<p><img src="/static/img/job_control_1.png" alt="job_control_1.png" />
</p>
</div>

<p>
If your program contains a segmentation fault however, job control messages
will be hidden from you as if your program printed no input at all.
</p>


<div id="org9f843dc" class="figure">
<p><img src="/static/img/job_control_2.png" alt="job_control_2.png" />
</p>
</div>

<p>
You may have known that messages like <span class="verbatim">[1] 21212 segmentation fault (core
  dumped) ./faulty</span> aren't ordinary messages in the sense you can't capture them
and they aren't generated by the program itself. They are actually generated
by your shell trapping those signals before executing a program, which, should
that program have issues, will run before your program terminates.
</p>

<p>
Shell-defined functions which run external programs (like <span class="verbatim">compile_run</span>) are
considered to be running within the current shell however, so job status
messages for the exit status of the function are not printed.
</p>
</div>

<div id="outline-container-orgb1603cc" class="outline-3">
<h3 id="orgb1603cc">Cycling background jobs hack</h3>
<div class="outline-text-3" id="text-orgb1603cc">
<p>
To get around this, you can get zsh to print the segmentation fault message
from the job if you start it as a background job and then immediately bring it
to the foreground:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #006699;">compile_run</span> <span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
    <span style="color: #006FE0;">local</span> <span style="color: #BA36A5;">exepath</span>=<span style="color: #008000;">"$(</span><span style="color: #FF1493;">mktemp</span><span style="color: #008000;">)"</span>
    cc -g <span style="color: #008000;">"$1"</span> -o $<span style="color: #BA36A5;">exepath</span>
    <span style="color: #8D8D84;">## </span><span style="color: #8D8D84; font-style: italic;">Magic Happens Here: ###############</span>
    <span style="color: #008000;">"$exepath"</span> <span style="color: #008000;">"$@"</span> &amp; <span style="color: #006FE0;">fg</span>
    <span style="color: #8D8D84;">######################################</span>
<span style="color: #707183;">}</span>
</pre>
</div>

<p>
A more comprehensive "compile run" function would have the same idea but with
some additional logic:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #006699;">compile_run</span> <span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
    <span style="color: #006FE0;">local</span> <span style="color: #BA36A5;">file</span>=$<span style="color: #D0372D;">1</span>
    <span style="color: #006FE0;">shift</span>
    <span style="color: #006FE0;">local</span> <span style="color: #BA36A5;">exepath</span>=<span style="color: #008000;">"$(</span><span style="color: #FF1493;">mktemp</span><span style="color: #008000;">)"</span>

    <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">[</span><span style="color: #909183;">[</span> $<span style="color: #BA36A5;">file</span> = *.cc <span style="color: #909183;">]</span><span style="color: #7388D6;">]</span>; <span style="color: #0000FF;">then</span>
        c++ -std=c++1z -g -Wall -Weffc++ $<span style="color: #BA36A5;">file</span> -o $<span style="color: #BA36A5;">exepath</span>
    <span style="color: #0000FF;">elif</span> <span style="color: #7388D6;">[</span><span style="color: #909183;">[</span> $<span style="color: #BA36A5;">file</span> = *.c <span style="color: #909183;">]</span><span style="color: #7388D6;">]</span>; <span style="color: #0000FF;">then</span>
        cc -g -Wall $<span style="color: #BA36A5;">file</span> -o $<span style="color: #BA36A5;">exepath</span>
    <span style="color: #0000FF;">else</span>
        <span style="color: #006FE0;">echo</span> <span style="color: #008000;">"no filetype detected"</span>
        <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">126</span>
    <span style="color: #0000FF;">fi</span>  || <span style="color: #0000FF;">return</span> $<span style="color: #BA36A5;">?</span>

    <span style="color: #008000;">"$exepath"</span> <span style="color: #008000;">"$@"</span> &amp; <span style="color: #006FE0;">fg</span>
<span style="color: #707183;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org51ee56d" class="outline-3">
<h3 id="org51ee56d">Custom messages</h3>
<div class="outline-text-3" id="text-org51ee56d">
<p>
If you want control over the exact message printed, you can also examine the
exit status of the program you ran yourself.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #006699;">compile_run</span> <span style="color: #707183;">()</span> <span style="color: #707183;">{</span>
    <span style="color: #006FE0;">local</span> <span style="color: #BA36A5;">exepath</span>=<span style="color: #008000;">"$(</span><span style="color: #FF1493;">mktemp</span><span style="color: #008000;">)"</span>
    cc -g <span style="color: #008000;">"$1"</span> -o $<span style="color: #BA36A5;">exepath</span>

    $<span style="color: #BA36A5;">exepath</span> <span style="color: #008000;">"$@"</span>
    integer <span style="color: #BA36A5;">stat</span>=$<span style="color: #BA36A5;">status</span>
    <span style="color: #0000FF;">if</span> <span style="color: #7388D6;">(</span><span style="color: #909183;">(</span> stat &gt; <span style="color: #D0372D;">128</span> <span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>; <span style="color: #0000FF;">then</span> print -u2 -- $<span style="color: #7388D6;">{</span><span style="color: #BA36A5;">exepath</span><span style="color: #7388D6;">}</span>: exited with 
    SIG$<span style="color: #7388D6;">{</span><span style="color: #BA36A5;">signals</span><span style="color: #909183;">[</span>stat-127<span style="color: #909183;">]</span><span style="color: #7388D6;">}</span>; <span style="color: #0000FF;">fi</span>
    <span style="color: #0000FF;">return</span> stat
<span style="color: #707183;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org40b8aa7" class="outline-3">
<h3 id="org40b8aa7">Using <span class="verbatim">setopt print_exit_value</span></h3>
<div class="outline-text-3" id="text-org40b8aa7">
<p>
Finally, zshell has an option <span class="verbatim">print_exit_value</span> that won't display messages
identically to job control messages, but will let you know what the exit
status code of your program is:
</p>


<div id="org48ade62" class="figure">
<p><img src="/static/img/job_control_3.png" alt="job_control_3.png" />
</p>
</div>
</div>
</div>
</section>
